/*! For license information please see ../../LICENSES */
(window.webpackJsonp=window.webpackJsonp||[]).push([[230],{12:function(e,t,n){"use strict";(function(e){n.d(t,"a",(function(){return Jl})),n.d(t,"b",(function(){return Yu})),n.d(t,"c",(function(){return Mu})),n.d(t,"d",(function(){return xu})),n.d(t,"e",(function(){return rh})),n.d(t,"f",(function(){return Xu})),n.d(t,"g",(function(){return N})),n.d(t,"h",(function(){return Zu})),n.d(t,"i",(function(){return sh})),n.d(t,"j",(function(){return ih})),n.d(t,"k",(function(){return K})),n.d(t,"l",(function(){return Sh})),n.d(t,"m",(function(){return bt})),n.d(t,"n",(function(){return H})),n.d(t,"o",(function(){return W})),n.d(t,"p",(function(){return Iu})),n.d(t,"q",(function(){return _})),n.d(t,"r",(function(){return lt})),n.d(t,"s",(function(){return E})),n.d(t,"t",(function(){return pu})),n.d(t,"u",(function(){return wh})),n.d(t,"v",(function(){return kh})),n.d(t,"w",(function(){return Ah})),n.d(t,"x",(function(){return Gu})),n.d(t,"y",(function(){return Nu})),n.d(t,"z",(function(){return Cu})),n.d(t,"A",(function(){return Su})),n.d(t,"B",(function(){return yh})),n.d(t,"C",(function(){return Nh})),n.d(t,"D",(function(){return ju})),n.d(t,"E",(function(){return Au})),n.d(t,"F",(function(){return Uu})),n.d(t,"G",(function(){return Bu})),n.d(t,"H",(function(){return $u})),n.d(t,"I",(function(){return jl})),n.d(t,"J",(function(){return $l})),n.d(t,"K",(function(){return Pu})),n.d(t,"L",(function(){return bh})),n.d(t,"M",(function(){return ch})),n.d(t,"N",(function(){return lh})),n.d(t,"O",(function(){return hh})),n.d(t,"P",(function(){return dh})),n.d(t,"Q",(function(){return fh})),n.d(t,"R",(function(){return mh})),n.d(t,"S",(function(){return Rh})),n.d(t,"T",(function(){return ql})),n.d(t,"U",(function(){return Ul})),n.d(t,"V",(function(){return Qu})),n.d(t,"W",(function(){return Wu})),n.d(t,"X",(function(){return vh})),n.d(t,"Y",(function(){return Ih})),n.d(t,"Z",(function(){return Ll})),n.d(t,"ab",(function(){return Rl})),n.d(t,"bb",(function(){return Ru})),n.d(t,"cb",(function(){return ku})),n.d(t,"db",(function(){return Dh})),n.d(t,"eb",(function(){return Ch})),n.d(t,"fb",(function(){return gh})),n.d(t,"gb",(function(){return w})),n.d(t,"hb",(function(){return ah})),n.d(t,"ib",(function(){return Gl})),n.d(t,"jb",(function(){return zl})),n.d(t,"kb",(function(){return ph})),n.d(t,"lb",(function(){return Ku})),n.d(t,"mb",(function(){return Vl}));var r=n(9),o=n(19),c=n(42),l=n(0),h=n(62);const b="@firebase/firestore";class d{constructor(e){this.uid=e}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(e){return e.uid===this.uid}}d.UNAUTHENTICATED=new d(null),d.GOOGLE_CREDENTIALS=new d("google-credentials-uid"),d.FIRST_PARTY=new d("first-party-uid"),d.MOCK_USER=new d("mock-user");let f="9.23.0";const m=new c.b("@firebase/firestore");function y(){return m.logLevel}function w(e){m.setLogLevel(e)}function v(e,...t){if(m.logLevel<=c.a.DEBUG){const n=t.map(T);m.debug(`Firestore (${f}): ${e}`,...n)}}function I(e,...t){if(m.logLevel<=c.a.ERROR){const n=t.map(T);m.error(`Firestore (${f}): ${e}`,...n)}}function E(e,...t){if(m.logLevel<=c.a.WARN){const n=t.map(T);m.warn(`Firestore (${f}): ${e}`,...n)}}function T(e){if("string"==typeof e)return e;try{return t=e,JSON.stringify(t)}catch(t){return e}var t}function S(e="Unexpected state"){const t=`FIRESTORE (${f}) INTERNAL ASSERTION FAILED: `+e;throw I(t),new Error(t)}function x(e,t){e||S()}function _(e,t){e||S()}function D(e,t){return e}const q={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class N extends l.c{constructor(e,t){super(e,t),this.code=e,this.message=t,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}class C{constructor(){this.promise=new Promise(((e,t)=>{this.resolve=e,this.reject=t}))}}class A{constructor(e,t){this.user=t,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${e}`)}}class k{getToken(){return Promise.resolve(null)}invalidateToken(){}start(e,t){e.enqueueRetryable((()=>t(d.UNAUTHENTICATED)))}shutdown(){}}class R{constructor(e){this.token=e,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(e,t){this.changeListener=t,e.enqueueRetryable((()=>t(this.token.user)))}shutdown(){this.changeListener=null}}class F{constructor(e){this.t=e,this.currentUser=d.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(e,t){let n=this.i;const s=e=>this.i!==n?(n=this.i,t(e)):Promise.resolve();let i=new C;this.o=()=>{this.i++,this.currentUser=this.u(),i.resolve(),i=new C,e.enqueueRetryable((()=>s(this.currentUser)))};const r=()=>{const t=i;e.enqueueRetryable((async()=>{await t.promise,await s(this.currentUser)}))},o=e=>{v("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=e,this.auth.addAuthTokenListener(this.o),r()};this.t.onInit((e=>o(e))),setTimeout((()=>{if(!this.auth){const e=this.t.getImmediate({optional:!0});e?o(e):(v("FirebaseAuthCredentialsProvider","Auth not yet detected"),i.resolve(),i=new C)}}),0),r()}getToken(){const e=this.i,t=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(t).then((t=>this.i!==e?(v("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):t?(x("string"==typeof t.accessToken),new A(t.accessToken,this.currentUser)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.auth.removeAuthTokenListener(this.o)}u(){const e=this.auth&&this.auth.getUid();return x(null===e||"string"==typeof e),new d(e)}}class V{constructor(e,t,n){this.h=e,this.l=t,this.m=n,this.type="FirstParty",this.user=d.FIRST_PARTY,this.g=new Map}p(){return this.m?this.m():null}get headers(){this.g.set("X-Goog-AuthUser",this.h);const e=this.p();return e&&this.g.set("Authorization",e),this.l&&this.g.set("X-Goog-Iam-Authorization-Token",this.l),this.g}}class O{constructor(e,t,n){this.h=e,this.l=t,this.m=n}getToken(){return Promise.resolve(new V(this.h,this.l,this.m))}start(e,t){e.enqueueRetryable((()=>t(d.FIRST_PARTY)))}shutdown(){}invalidateToken(){}}class M{constructor(e){this.value=e,this.type="AppCheck",this.headers=new Map,e&&e.length>0&&this.headers.set("x-firebase-appcheck",this.value)}}class L{constructor(e){this.I=e,this.forceRefresh=!1,this.appCheck=null,this.T=null}start(e,t){const n=e=>{null!=e.error&&v("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${e.error.message}`);const n=e.token!==this.T;return this.T=e.token,v("FirebaseAppCheckTokenProvider",`Received ${n?"new":"existing"} token.`),n?t(e.token):Promise.resolve()};this.o=t=>{e.enqueueRetryable((()=>n(t)))};const s=e=>{v("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=e,this.appCheck.addTokenListener(this.o)};this.I.onInit((e=>s(e))),setTimeout((()=>{if(!this.appCheck){const e=this.I.getImmediate({optional:!0});e?s(e):v("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}}),0)}getToken(){const e=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(e).then((e=>e?(x("string"==typeof e.token),this.T=e.token,new M(e.token)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.appCheck.removeTokenListener(this.o)}}function P(e){const t="undefined"!=typeof self&&(self.crypto||self.msCrypto),n=new Uint8Array(e);if(t&&"function"==typeof t.getRandomValues)t.getRandomValues(n);else for(let t=0;t<e;t++)n[t]=Math.floor(256*Math.random());return n}class U{static A(){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t=62*Math.floor(256/62);let n="";for(;n.length<20;){const s=P(40);for(let i=0;i<s.length;++i)n.length<20&&s[i]<t&&(n+=e.charAt(s[i]%62))}return n}}function B(e,t){return e<t?-1:e>t?1:0}function z(e,t,n){return e.length===t.length&&e.every(((e,s)=>n(e,t[s])))}function G(e){return e+"\0"}class K{constructor(e,t){if(this.seconds=e,this.nanoseconds=t,t<0)throw new N(q.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(t>=1e9)throw new N(q.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(e<-62135596800)throw new N(q.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e);if(e>=253402300800)throw new N(q.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e)}static now(){return K.fromMillis(Date.now())}static fromDate(e){return K.fromMillis(e.getTime())}static fromMillis(e){const t=Math.floor(e/1e3),n=Math.floor(1e6*(e-1e3*t));return new K(t,n)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(e){return this.seconds===e.seconds?B(this.nanoseconds,e.nanoseconds):B(this.seconds,e.seconds)}isEqual(e){return e.seconds===this.seconds&&e.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){const e=this.seconds- -62135596800;return String(e).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}class rt{constructor(e){this.timestamp=e}static fromTimestamp(e){return new rt(e)}static min(){return new rt(new K(0,0))}static max(){return new rt(new K(253402300799,999999999))}compareTo(e){return this.timestamp._compareTo(e.timestamp)}isEqual(e){return this.timestamp.isEqual(e.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}class ${constructor(e,t,n){void 0===t?t=0:t>e.length&&S(),void 0===n?n=e.length-t:n>e.length-t&&S(),this.segments=e,this.offset=t,this.len=n}get length(){return this.len}isEqual(e){return 0===$.comparator(this,e)}child(e){const t=this.segments.slice(this.offset,this.limit());return e instanceof $?e.forEach((e=>{t.push(e)})):t.push(e),this.construct(t)}limit(){return this.offset+this.length}popFirst(e){return e=void 0===e?1:e,this.construct(this.segments,this.offset+e,this.length-e)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(e){return this.segments[this.offset+e]}isEmpty(){return 0===this.length}isPrefixOf(e){if(e.length<this.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}isImmediateParentOf(e){if(this.length+1!==e.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}forEach(e){for(let t=this.offset,n=this.limit();t<n;t++)e(this.segments[t])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(e,t){const n=Math.min(e.length,t.length);for(let s=0;s<n;s++){const n=e.get(s),i=t.get(s);if(n<i)return-1;if(n>i)return 1}return e.length<t.length?-1:e.length>t.length?1:0}}class j extends ${construct(e,t,n){return new j(e,t,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}static fromString(...e){const t=[];for(const n of e){if(n.indexOf("//")>=0)throw new N(q.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);t.push(...n.split("/").filter((e=>e.length>0)))}return new j(t)}static emptyPath(){return new j([])}}const Q=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class W extends ${construct(e,t,n){return new W(e,t,n)}static isValidIdentifier(e){return Q.test(e)}canonicalString(){return this.toArray().map((e=>(e=e.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),W.isValidIdentifier(e)||(e="`"+e+"`"),e))).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&"__name__"===this.get(0)}static keyField(){return new W(["__name__"])}static fromServerFormat(e){const t=[];let n="",s=0;const i=()=>{if(0===n.length)throw new N(q.INVALID_ARGUMENT,`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);t.push(n),n=""};let r=!1;for(;s<e.length;){const t=e[s];if("\\"===t){if(s+1===e.length)throw new N(q.INVALID_ARGUMENT,"Path has trailing escape character: "+e);const t=e[s+1];if("\\"!==t&&"."!==t&&"`"!==t)throw new N(q.INVALID_ARGUMENT,"Path has invalid escape sequence: "+e);n+=t,s+=2}else"`"===t?(r=!r,s++):"."!==t||r?(n+=t,s++):(i(),s++)}if(i(),r)throw new N(q.INVALID_ARGUMENT,"Unterminated ` in path: "+e);return new W(t)}static emptyPath(){return new W([])}}class H{constructor(e){this.path=e}static fromPath(e){return new H(j.fromString(e))}static fromName(e){return new H(j.fromString(e).popFirst(5))}static empty(){return new H(j.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(e){return this.path.length>=2&&this.path.get(this.path.length-2)===e}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(e){return null!==e&&0===j.comparator(this.path,e.path)}toString(){return this.path.toString()}static comparator(e,t){return j.comparator(e.path,t.path)}static isDocumentKey(e){return e.length%2==0}static fromSegments(e){return new H(new j(e.slice()))}}class Y{constructor(e,t,n,s){this.indexId=e,this.collectionGroup=t,this.fields=n,this.indexState=s}}function X(e){return e.fields.find((e=>2===e.kind))}function dt(e){return e.fields.filter((e=>2!==e.kind))}Y.UNKNOWN_ID=-1;class J{constructor(e,t){this.fieldPath=e,this.kind=t}}class Z{constructor(e,t){this.sequenceNumber=e,this.offset=t}static empty(){return new Z(0,ne.min())}}function ee(e,t){const n=e.toTimestamp().seconds,s=e.toTimestamp().nanoseconds+1,i=rt.fromTimestamp(1e9===s?new K(n+1,0):new K(n,s));return new ne(i,H.empty(),t)}function te(e){return new ne(e.readTime,e.key,-1)}class ne{constructor(e,t,n){this.readTime=e,this.documentKey=t,this.largestBatchId=n}static min(){return new ne(rt.min(),H.empty(),-1)}static max(){return new ne(rt.max(),H.empty(),-1)}}function re(e,t){let n=e.readTime.compareTo(t.readTime);return 0!==n?n:(n=H.comparator(e.documentKey,t.documentKey),0!==n?n:B(e.largestBatchId,t.largestBatchId))}const se="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class ie{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(e){this.onCommittedListeners.push(e)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach((e=>e()))}}async function oe(e){if(e.code!==q.FAILED_PRECONDITION||e.message!==se)throw e;v("LocalStore","Unexpectedly lost primary lease")}class ae{constructor(e){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,e((e=>{this.isDone=!0,this.result=e,this.nextCallback&&this.nextCallback(e)}),(e=>{this.isDone=!0,this.error=e,this.catchCallback&&this.catchCallback(e)}))}catch(e){return this.next(void 0,e)}next(e,t){return this.callbackAttached&&S(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(t,this.error):this.wrapSuccess(e,this.result):new ae(((n,s)=>{this.nextCallback=t=>{this.wrapSuccess(e,t).next(n,s)},this.catchCallback=e=>{this.wrapFailure(t,e).next(n,s)}}))}toPromise(){return new Promise(((e,t)=>{this.next(e,t)}))}wrapUserFunction(e){try{const t=e();return t instanceof ae?t:ae.resolve(t)}catch(e){return ae.reject(e)}}wrapSuccess(e,t){return e?this.wrapUserFunction((()=>e(t))):ae.resolve(t)}wrapFailure(e,t){return e?this.wrapUserFunction((()=>e(t))):ae.reject(t)}static resolve(e){return new ae(((t,n)=>{t(e)}))}static reject(e){return new ae(((t,n)=>{n(e)}))}static waitFor(e){return new ae(((t,n)=>{let s=0,i=0,r=!1;e.forEach((e=>{++s,e.next((()=>{++i,r&&i===s&&t()}),(e=>n(e)))})),r=!0,i===s&&t()}))}static or(e){let t=ae.resolve(!1);for(const n of e)t=t.next((e=>e?ae.resolve(e):n()));return t}static forEach(e,t){const n=[];return e.forEach(((e,s)=>{n.push(t.call(this,e,s))})),this.waitFor(n)}static mapArray(e,t){return new ae(((n,s)=>{const i=e.length,r=new Array(i);let o=0;for(let u=0;u<i;u++){const c=u;t(e[c]).next((e=>{r[c]=e,++o,o===i&&n(r)}),(e=>s(e)))}}))}static doWhile(e,t){return new ae(((n,s)=>{const i=()=>{!0===e()?t().next((()=>{i()}),s):n()};i()}))}}class ce{constructor(e,t){this.action=e,this.transaction=t,this.aborted=!1,this.v=new C,this.transaction.oncomplete=()=>{this.v.resolve()},this.transaction.onabort=()=>{t.error?this.v.reject(new he(e,t.error)):this.v.resolve()},this.transaction.onerror=t=>{const n=pe(t.target.error);this.v.reject(new he(e,n))}}static open(e,t,n,s){try{return new ce(t,e.transaction(s,n))}catch(e){throw new he(t,e)}}get R(){return this.v.promise}abort(e){e&&this.v.reject(e),this.aborted||(v("SimpleDb","Aborting transaction:",e?e.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}P(){const e=this.transaction;this.aborted||"function"!=typeof e.commit||e.commit()}store(e){const t=this.transaction.objectStore(e);return new fe(t)}}class ue{constructor(e,t,n){this.name=e,this.version=t,this.V=n,12.2===ue.S(Object(l.A)())&&I("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}static delete(e){return v("SimpleDb","Removing database:",e),me(window.indexedDB.deleteDatabase(e)).toPromise()}static D(){if(!Object(l.G)())return!1;if(ue.C())return!0;const e=Object(l.A)(),t=ue.S(e),n=0<t&&t<10,s=ue.N(e),i=0<s&&s<4.5;return!(e.indexOf("MSIE ")>0||e.indexOf("Trident/")>0||e.indexOf("Edge/")>0||n||i)}static C(){var t;return void 0!==e&&"YES"===(null===(t=e.env)||void 0===t?void 0:t.k)}static M(e,t){return e.store(t)}static S(e){const t=e.match(/i(?:phone|pad|pod) os ([\d_]+)/i),n=t?t[1].split("_").slice(0,2).join("."):"-1";return Number(n)}static N(e){const t=e.match(/Android ([\d.]+)/i),n=t?t[1].split(".").slice(0,2).join("."):"-1";return Number(n)}async $(e){return this.db||(v("SimpleDb","Opening database:",this.name),this.db=await new Promise(((t,n)=>{const s=indexedDB.open(this.name,this.version);s.onsuccess=e=>{const n=e.target.result;t(n)},s.onblocked=()=>{n(new he(e,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},s.onerror=t=>{const s=t.target.error;"VersionError"===s.name?n(new N(q.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):"InvalidStateError"===s.name?n(new N(q.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+s)):n(new he(e,s))},s.onupgradeneeded=e=>{v("SimpleDb",'Database "'+this.name+'" requires upgrade from version:',e.oldVersion);const t=e.target.result;this.V.O(t,s.transaction,e.oldVersion,this.version).next((()=>{v("SimpleDb","Database upgrade to version "+this.version+" complete")}))}}))),this.F&&(this.db.onversionchange=e=>this.F(e)),this.db}B(e){this.F=e,this.db&&(this.db.onversionchange=t=>e(t))}async runTransaction(e,t,n,s){const i="readonly"===t;let r=0;for(;;){++r;try{this.db=await this.$(e);const t=ce.open(this.db,e,i?"readonly":"readwrite",n),r=s(t).next((e=>(t.P(),e))).catch((e=>(t.abort(e),ae.reject(e)))).toPromise();return r.catch((()=>{})),await t.R,r}catch(e){const t=e,n="FirebaseError"!==t.name&&r<3;if(v("SimpleDb","Transaction failed with error:",t.message,"Retrying:",n),this.close(),!n)return Promise.reject(t)}}}close(){this.db&&this.db.close(),this.db=void 0}}class le{constructor(e){this.L=e,this.q=!1,this.U=null}get isDone(){return this.q}get K(){return this.U}set cursor(e){this.L=e}done(){this.q=!0}G(e){this.U=e}delete(){return me(this.L.delete())}}class he extends N{constructor(e,t){super(q.UNAVAILABLE,`IndexedDB transaction '${e}' failed: ${t}`),this.name="IndexedDbTransactionError"}}function de(e){return"IndexedDbTransactionError"===e.name}class fe{constructor(e){this.store=e}put(e,t){let n;return void 0!==t?(v("SimpleDb","PUT",this.store.name,e,t),n=this.store.put(t,e)):(v("SimpleDb","PUT",this.store.name,"<auto-key>",e),n=this.store.put(e)),me(n)}add(e){return v("SimpleDb","ADD",this.store.name,e,e),me(this.store.add(e))}get(e){return me(this.store.get(e)).next((t=>(void 0===t&&(t=null),v("SimpleDb","GET",this.store.name,e,t),t)))}delete(e){return v("SimpleDb","DELETE",this.store.name,e),me(this.store.delete(e))}count(){return v("SimpleDb","COUNT",this.store.name),me(this.store.count())}j(e,t){const n=this.options(e,t);if(n.index||"function"!=typeof this.store.getAll){const e=this.cursor(n),t=[];return this.W(e,((e,n)=>{t.push(n)})).next((()=>t))}{const e=this.store.getAll(n.range);return new ae(((t,n)=>{e.onerror=e=>{n(e.target.error)},e.onsuccess=e=>{t(e.target.result)}}))}}H(e,t){const n=this.store.getAll(e,null===t?void 0:t);return new ae(((e,t)=>{n.onerror=e=>{t(e.target.error)},n.onsuccess=t=>{e(t.target.result)}}))}J(e,t){v("SimpleDb","DELETE ALL",this.store.name);const n=this.options(e,t);n.Y=!1;const s=this.cursor(n);return this.W(s,((e,t,n)=>n.delete()))}X(e,t){let n;t?n=e:(n={},t=e);const s=this.cursor(n);return this.W(s,t)}Z(e){const t=this.cursor({});return new ae(((n,s)=>{t.onerror=e=>{const t=pe(e.target.error);s(t)},t.onsuccess=t=>{const s=t.target.result;s?e(s.primaryKey,s.value).next((e=>{e?s.continue():n()})):n()}}))}W(e,t){const n=[];return new ae(((s,i)=>{e.onerror=e=>{i(e.target.error)},e.onsuccess=e=>{const i=e.target.result;if(!i)return void s();const r=new le(i),o=t(i.primaryKey,i.value,r);if(o instanceof ae){const e=o.catch((e=>(r.done(),ae.reject(e))));n.push(e)}r.isDone?s():null===r.K?i.continue():i.continue(r.K)}})).next((()=>ae.waitFor(n)))}options(e,t){let n;return void 0!==e&&("string"==typeof e?n=e:t=e),{index:n,range:t}}cursor(e){let t="next";if(e.reverse&&(t="prev"),e.index){const n=this.store.index(e.index);return e.Y?n.openKeyCursor(e.range,t):n.openCursor(e.range,t)}return this.store.openCursor(e.range,t)}}function me(e){return new ae(((t,n)=>{e.onsuccess=e=>{const n=e.target.result;t(n)},e.onerror=e=>{const t=pe(e.target.error);n(t)}}))}let ge=!1;function pe(e){const t=ue.S(Object(l.A)());if(t>=12.2&&t<13){const t="An internal error was encountered in the Indexed Database server";if(e.message.indexOf(t)>=0){const e=new N("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${t}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return ge||(ge=!0,setTimeout((()=>{throw e}),0)),e}}return e}class ye{constructor(e,t){this.asyncQueue=e,this.tt=t,this.task=null}start(){this.et(15e3)}stop(){this.task&&(this.task.cancel(),this.task=null)}get started(){return null!==this.task}et(e){v("IndexBackiller",`Scheduled in ${e}ms`),this.task=this.asyncQueue.enqueueAfterDelay("index_backfill",e,(async()=>{this.task=null;try{v("IndexBackiller",`Documents written: ${await this.tt.nt()}`)}catch(e){de(e)?v("IndexBackiller","Ignoring IndexedDB error during index backfill: ",e):await oe(e)}await this.et(6e4)}))}}class we{constructor(e,t){this.localStore=e,this.persistence=t}async nt(e=50){return this.persistence.runTransaction("Backfill Indexes","readwrite-primary",(t=>this.st(t,e)))}st(e,t){const n=new Set;let s=t,i=!0;return ae.doWhile((()=>!0===i&&s>0),(()=>this.localStore.indexManager.getNextCollectionGroupToUpdate(e).next((t=>{if(null!==t&&!n.has(t))return v("IndexBackiller",`Processing collection: ${t}`),this.it(e,t,s).next((e=>{s-=e,n.add(t)}));i=!1})))).next((()=>t-s))}it(e,t,n){return this.localStore.indexManager.getMinOffsetFromCollectionGroup(e,t).next((s=>this.localStore.localDocuments.getNextDocuments(e,t,s,n).next((n=>{const i=n.changes;return this.localStore.indexManager.updateIndexEntries(e,i).next((()=>this.rt(s,n))).next((n=>(v("IndexBackiller",`Updating offset: ${n}`),this.localStore.indexManager.updateCollectionGroup(e,t,n)))).next((()=>i.size))}))))}rt(e,t){let n=e;return t.changes.forEach(((e,t)=>{const s=te(t);re(s,n)>0&&(n=s)})),new ne(n.readTime,n.documentKey,Math.max(t.batchId,e.largestBatchId))}}class ve{constructor(e,t){this.previousValue=e,t&&(t.sequenceNumberHandler=e=>this.ot(e),this.ut=e=>t.writeSequenceNumber(e))}ot(e){return this.previousValue=Math.max(e,this.previousValue),this.previousValue}next(){const e=++this.previousValue;return this.ut&&this.ut(e),e}}function Ie(e){return null==e}function be(e){return 0===e&&1/e==-1/0}function Ee(e){return"number"==typeof e&&Number.isInteger(e)&&!be(e)&&e<=Number.MAX_SAFE_INTEGER&&e>=Number.MIN_SAFE_INTEGER}function Te(e){let t="";for(let n=0;n<e.length;n++)t.length>0&&(t=xe(t)),t=Se(e.get(n),t);return xe(t)}function Se(e,t){let n=t;const s=e.length;for(let t=0;t<s;t++){const s=e.charAt(t);switch(s){case"\0":n+="";break;case"":n+="";break;default:n+=s}}return n}function xe(e){return e+""}function _e(e){const t=e.length;if(x(t>=2),2===t)return x(""===e.charAt(0)&&""===e.charAt(1)),j.emptyPath();const n=t-2,r=[];let s="";for(let i=0;i<t;){const t=e.indexOf("",i);switch((t<0||t>n)&&S(),e.charAt(t+1)){case"":const n=e.substring(i,t);let o;0===s.length?o=n:(s+=n,o=s,s=""),r.push(o);break;case"":s+=e.substring(i,t),s+="\0";break;case"":s+=e.substring(i,t+1);break;default:S()}i=t+2}return new j(r)}ve.ct=-1;const De=["userId","batchId"];function Ne(e,t){return[e,Te(t)]}function Ce(e,t,n){return[e,Te(t),n]}const Ae={},ke=["prefixPath","collectionGroup","readTime","documentId"],Re=["prefixPath","collectionGroup","documentId"],Fe=["collectionGroup","readTime","prefixPath","documentId"],Ve=["canonicalId","targetId"],Oe=["targetId","path"],Me=["path","targetId"],Le=["collectionId","parent"],Pe=["indexId","uid"],qe=["uid","sequenceNumber"],Ue=["indexId","uid","arrayValue","directionalValue","orderedDocumentKey","documentKey"],Be=["indexId","uid","orderedDocumentKey"],ze=["userId","collectionPath","documentId"],Ge=["userId","collectionPath","largestBatchId"],Ke=["userId","collectionGroup","largestBatchId"],$e=["mutationQueues","mutations","documentMutations","remoteDocuments","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries"],je=[...$e,"documentOverlays"],Qe=["mutationQueues","mutations","documentMutations","remoteDocumentsV14","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries","documentOverlays"],We=Qe,He=[...We,"indexConfiguration","indexState","indexEntries"];class Ye extends ie{constructor(e,t){super(),this.ht=e,this.currentSequenceNumber=t}}function Xe(e,t){const n=D(e);return ue.M(n.ht,t)}function Je(e){let t=0;for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t++;return t}function Ze(e,t){for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t(n,e[n])}function et(e){for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}class tt{constructor(e,t){this.comparator=e,this.root=t||st.EMPTY}insert(e,t){return new tt(this.comparator,this.root.insert(e,t,this.comparator).copy(null,null,st.BLACK,null,null))}remove(e){return new tt(this.comparator,this.root.remove(e,this.comparator).copy(null,null,st.BLACK,null,null))}get(e){let t=this.root;for(;!t.isEmpty();){const n=this.comparator(e,t.key);if(0===n)return t.value;n<0?t=t.left:n>0&&(t=t.right)}return null}indexOf(e){let t=0,n=this.root;for(;!n.isEmpty();){const s=this.comparator(e,n.key);if(0===s)return t+n.left.size;s<0?n=n.left:(t+=n.left.size+1,n=n.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(e){return this.root.inorderTraversal(e)}forEach(e){this.inorderTraversal(((t,n)=>(e(t,n),!1)))}toString(){const e=[];return this.inorderTraversal(((t,n)=>(e.push(`${t}:${n}`),!1))),`{${e.join(", ")}}`}reverseTraversal(e){return this.root.reverseTraversal(e)}getIterator(){return new nt(this.root,null,this.comparator,!1)}getIteratorFrom(e){return new nt(this.root,e,this.comparator,!1)}getReverseIterator(){return new nt(this.root,null,this.comparator,!0)}getReverseIteratorFrom(e){return new nt(this.root,e,this.comparator,!0)}}class nt{constructor(e,t,n,s){this.isReverse=s,this.nodeStack=[];let i=1;for(;!e.isEmpty();)if(i=t?n(e.key,t):1,t&&s&&(i*=-1),i<0)e=this.isReverse?e.left:e.right;else{if(0===i){this.nodeStack.push(e);break}this.nodeStack.push(e),e=this.isReverse?e.right:e.left}}getNext(){let e=this.nodeStack.pop();const t={key:e.key,value:e.value};if(this.isReverse)for(e=e.left;!e.isEmpty();)this.nodeStack.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack.push(e),e=e.left;return t}hasNext(){return this.nodeStack.length>0}peek(){if(0===this.nodeStack.length)return null;const e=this.nodeStack[this.nodeStack.length-1];return{key:e.key,value:e.value}}}class st{constructor(e,t,n,s,i){this.key=e,this.value=t,this.color=null!=n?n:st.RED,this.left=null!=s?s:st.EMPTY,this.right=null!=i?i:st.EMPTY,this.size=this.left.size+1+this.right.size}copy(e,t,n,s,i){return new st(null!=e?e:this.key,null!=t?t:this.value,null!=n?n:this.color,null!=s?s:this.left,null!=i?i:this.right)}isEmpty(){return!1}inorderTraversal(e){return this.left.inorderTraversal(e)||e(this.key,this.value)||this.right.inorderTraversal(e)}reverseTraversal(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(e,t,n){let s=this;const i=n(e,s.key);return s=i<0?s.copy(null,null,null,s.left.insert(e,t,n),null):0===i?s.copy(null,t,null,null,null):s.copy(null,null,null,null,s.right.insert(e,t,n)),s.fixUp()}removeMin(){if(this.left.isEmpty())return st.EMPTY;let e=this;return e.left.isRed()||e.left.left.isRed()||(e=e.moveRedLeft()),e=e.copy(null,null,null,e.left.removeMin(),null),e.fixUp()}remove(e,t){let n,s=this;if(t(e,s.key)<0)s.left.isEmpty()||s.left.isRed()||s.left.left.isRed()||(s=s.moveRedLeft()),s=s.copy(null,null,null,s.left.remove(e,t),null);else{if(s.left.isRed()&&(s=s.rotateRight()),s.right.isEmpty()||s.right.isRed()||s.right.left.isRed()||(s=s.moveRedRight()),0===t(e,s.key)){if(s.right.isEmpty())return st.EMPTY;n=s.right.min(),s=s.copy(n.key,n.value,null,null,s.right.removeMin())}s=s.copy(null,null,null,null,s.right.remove(e,t))}return s.fixUp()}isRed(){return this.color}fixUp(){let e=this;return e.right.isRed()&&!e.left.isRed()&&(e=e.rotateLeft()),e.left.isRed()&&e.left.left.isRed()&&(e=e.rotateRight()),e.left.isRed()&&e.right.isRed()&&(e=e.colorFlip()),e}moveRedLeft(){let e=this.colorFlip();return e.right.left.isRed()&&(e=e.copy(null,null,null,null,e.right.rotateRight()),e=e.rotateLeft(),e=e.colorFlip()),e}moveRedRight(){let e=this.colorFlip();return e.left.left.isRed()&&(e=e.rotateRight(),e=e.colorFlip()),e}rotateLeft(){const e=this.copy(null,null,st.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)}rotateRight(){const e=this.copy(null,null,st.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)}colorFlip(){const e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}checkMaxDepth(){const e=this.check();return Math.pow(2,e)<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw S();if(this.right.isRed())throw S();const e=this.left.check();if(e!==this.right.check())throw S();return e+(this.isRed()?0:1)}}st.EMPTY=null,st.RED=!0,st.BLACK=!1,st.EMPTY=new class{constructor(){this.size=0}get key(){throw S()}get value(){throw S()}get color(){throw S()}get left(){throw S()}get right(){throw S()}copy(e,t,n,s,i){return this}insert(e,t,n){return new st(e,t)}remove(e,t){return this}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class it{constructor(e){this.comparator=e,this.data=new tt(this.comparator)}has(e){return null!==this.data.get(e)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(e){return this.data.indexOf(e)}forEach(e){this.data.inorderTraversal(((t,n)=>(e(t),!1)))}forEachInRange(e,t){const n=this.data.getIteratorFrom(e[0]);for(;n.hasNext();){const s=n.getNext();if(this.comparator(s.key,e[1])>=0)return;t(s.key)}}forEachWhile(e,t){let n;for(n=void 0!==t?this.data.getIteratorFrom(t):this.data.getIterator();n.hasNext();)if(!e(n.getNext().key))return}firstAfterOrEqual(e){const t=this.data.getIteratorFrom(e);return t.hasNext()?t.getNext().key:null}getIterator(){return new ot(this.data.getIterator())}getIteratorFrom(e){return new ot(this.data.getIteratorFrom(e))}add(e){return this.copy(this.data.remove(e).insert(e,!0))}delete(e){return this.has(e)?this.copy(this.data.remove(e)):this}isEmpty(){return this.data.isEmpty()}unionWith(e){let t=this;return t.size<e.size&&(t=e,e=this),e.forEach((e=>{t=t.add(e)})),t}isEqual(e){if(!(e instanceof it))return!1;if(this.size!==e.size)return!1;const t=this.data.getIterator(),n=e.data.getIterator();for(;t.hasNext();){const e=t.getNext().key,s=n.getNext().key;if(0!==this.comparator(e,s))return!1}return!0}toArray(){const e=[];return this.forEach((t=>{e.push(t)})),e}toString(){const e=[];return this.forEach((t=>e.push(t))),"SortedSet("+e.toString()+")"}copy(e){const t=new it(this.comparator);return t.data=e,t}}class ot{constructor(e){this.iter=e}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}function at(e){return e.hasNext()?e.getNext():void 0}class ct{constructor(e){this.fields=e,e.sort(W.comparator)}static empty(){return new ct([])}unionWith(e){let t=new it(W.comparator);for(const e of this.fields)t=t.add(e);for(const n of e)t=t.add(n);return new ct(t.toArray())}covers(e){for(const t of this.fields)if(t.isPrefixOf(e))return!0;return!1}isEqual(e){return z(this.fields,e.fields,((e,t)=>e.isEqual(t)))}}class ut extends Error{constructor(){super(...arguments),this.name="Base64DecodeError"}}function lt(){return"undefined"!=typeof atob}class ht{constructor(e){this.binaryString=e}static fromBase64String(e){const t=function(e){try{return atob(e)}catch(e){throw"undefined"!=typeof DOMException&&e instanceof DOMException?new ut("Invalid base64 string: "+e):e}}(e);return new ht(t)}static fromUint8Array(e){const t=function(e){let t="";for(let n=0;n<e.length;++n)t+=String.fromCharCode(e[n]);return t}(e);return new ht(t)}[Symbol.iterator](){let e=0;return{next:()=>e<this.binaryString.length?{value:this.binaryString.charCodeAt(e++),done:!1}:{value:void 0,done:!0}}}toBase64(){return e=this.binaryString,btoa(e);var e}toUint8Array(){return function(e){const t=new Uint8Array(e.length);for(let n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(e){return B(this.binaryString,e.binaryString)}isEqual(e){return this.binaryString===e.binaryString}}ht.EMPTY_BYTE_STRING=new ht("");const ft=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function mt(e){if(x(!!e),"string"==typeof e){let t=0;const n=ft.exec(e);if(x(!!n),n[1]){let e=n[1];e=(e+"000000000").substr(0,9),t=Number(e)}const s=new Date(e);return{seconds:Math.floor(s.getTime()/1e3),nanos:t}}return{seconds:gt(e.seconds),nanos:gt(e.nanos)}}function gt(e){return"number"==typeof e?e:"string"==typeof e?Number(e):0}function pt(e){return"string"==typeof e?ht.fromBase64String(e):ht.fromUint8Array(e)}function yt(e){var t,n;return"server_timestamp"===(null===(n=((null===(t=null==e?void 0:e.mapValue)||void 0===t?void 0:t.fields)||{}).__type__)||void 0===n?void 0:n.stringValue)}function wt(e){const t=e.mapValue.fields.__previous_value__;return yt(t)?wt(t):t}function vt(e){const t=mt(e.mapValue.fields.__local_write_time__.timestampValue);return new K(t.seconds,t.nanos)}class It{constructor(e,t,n,s,i,r,o,u,c){this.databaseId=e,this.appId=t,this.persistenceKey=n,this.host=s,this.ssl=i,this.forceLongPolling=r,this.autoDetectLongPolling=o,this.longPollingOptions=u,this.useFetchStreams=c}}class bt{constructor(e,t){this.projectId=e,this.database=t||"(default)"}static empty(){return new bt("","")}get isDefaultDatabase(){return"(default)"===this.database}isEqual(e){return e instanceof bt&&e.projectId===this.projectId&&e.database===this.database}}const Et={mapValue:{fields:{__type__:{stringValue:"__max__"}}}},Tt={nullValue:"NULL_VALUE"};function St(e){return"nullValue"in e?0:"booleanValue"in e?1:"integerValue"in e||"doubleValue"in e?2:"timestampValue"in e?3:"stringValue"in e?5:"bytesValue"in e?6:"referenceValue"in e?7:"geoPointValue"in e?8:"arrayValue"in e?9:"mapValue"in e?yt(e)?4:Pt(e)?9007199254740991:10:S()}function xt(e,t){if(e===t)return!0;const n=St(e);if(n!==St(t))return!1;switch(n){case 0:case 9007199254740991:return!0;case 1:return e.booleanValue===t.booleanValue;case 4:return vt(e).isEqual(vt(t));case 3:return function(e,t){if("string"==typeof e.timestampValue&&"string"==typeof t.timestampValue&&e.timestampValue.length===t.timestampValue.length)return e.timestampValue===t.timestampValue;const n=mt(e.timestampValue),s=mt(t.timestampValue);return n.seconds===s.seconds&&n.nanos===s.nanos}(e,t);case 5:return e.stringValue===t.stringValue;case 6:return function(e,t){return pt(e.bytesValue).isEqual(pt(t.bytesValue))}(e,t);case 7:return e.referenceValue===t.referenceValue;case 8:return function(e,t){return gt(e.geoPointValue.latitude)===gt(t.geoPointValue.latitude)&&gt(e.geoPointValue.longitude)===gt(t.geoPointValue.longitude)}(e,t);case 2:return function(e,t){if("integerValue"in e&&"integerValue"in t)return gt(e.integerValue)===gt(t.integerValue);if("doubleValue"in e&&"doubleValue"in t){const n=gt(e.doubleValue),s=gt(t.doubleValue);return n===s?be(n)===be(s):isNaN(n)&&isNaN(s)}return!1}(e,t);case 9:return z(e.arrayValue.values||[],t.arrayValue.values||[],xt);case 10:return function(e,t){const n=e.mapValue.fields||{},s=t.mapValue.fields||{};if(Je(n)!==Je(s))return!1;for(const e in n)if(n.hasOwnProperty(e)&&(void 0===s[e]||!xt(n[e],s[e])))return!1;return!0}(e,t);default:return S()}}function _t(e,t){return void 0!==(e.values||[]).find((e=>xt(e,t)))}function Dt(e,t){if(e===t)return 0;const n=St(e),s=St(t);if(n!==s)return B(n,s);switch(n){case 0:case 9007199254740991:return 0;case 1:return B(e.booleanValue,t.booleanValue);case 2:return function(e,t){const n=gt(e.integerValue||e.doubleValue),s=gt(t.integerValue||t.doubleValue);return n<s?-1:n>s?1:n===s?0:isNaN(n)?isNaN(s)?0:-1:1}(e,t);case 3:return Nt(e.timestampValue,t.timestampValue);case 4:return Nt(vt(e),vt(t));case 5:return B(e.stringValue,t.stringValue);case 6:return function(e,t){const n=pt(e),s=pt(t);return n.compareTo(s)}(e.bytesValue,t.bytesValue);case 7:return function(e,t){const n=e.split("/"),s=t.split("/");for(let e=0;e<n.length&&e<s.length;e++){const t=B(n[e],s[e]);if(0!==t)return t}return B(n.length,s.length)}(e.referenceValue,t.referenceValue);case 8:return function(e,t){const n=B(gt(e.latitude),gt(t.latitude));return 0!==n?n:B(gt(e.longitude),gt(t.longitude))}(e.geoPointValue,t.geoPointValue);case 9:return function(e,t){const n=e.values||[],s=t.values||[];for(let e=0;e<n.length&&e<s.length;++e){const t=Dt(n[e],s[e]);if(t)return t}return B(n.length,s.length)}(e.arrayValue,t.arrayValue);case 10:return function(e,t){if(e===Et.mapValue&&t===Et.mapValue)return 0;if(e===Et.mapValue)return 1;if(t===Et.mapValue)return-1;const n=e.fields||{},s=Object.keys(n),i=t.fields||{},r=Object.keys(i);s.sort(),r.sort();for(let e=0;e<s.length&&e<r.length;++e){const t=B(s[e],r[e]);if(0!==t)return t;const o=Dt(n[s[e]],i[r[e]]);if(0!==o)return o}return B(s.length,r.length)}(e.mapValue,t.mapValue);default:throw S()}}function Nt(e,t){if("string"==typeof e&&"string"==typeof t&&e.length===t.length)return B(e,t);const n=mt(e),s=mt(t),i=B(n.seconds,s.seconds);return 0!==i?i:B(n.nanos,s.nanos)}function Ct(e){return At(e)}function At(e){return"nullValue"in e?"null":"booleanValue"in e?""+e.booleanValue:"integerValue"in e?""+e.integerValue:"doubleValue"in e?""+e.doubleValue:"timestampValue"in e?function(e){const t=mt(e);return`time(${t.seconds},${t.nanos})`}(e.timestampValue):"stringValue"in e?e.stringValue:"bytesValue"in e?pt(e.bytesValue).toBase64():"referenceValue"in e?(n=e.referenceValue,H.fromName(n).toString()):"geoPointValue"in e?`geo(${(t=e.geoPointValue).latitude},${t.longitude})`:"arrayValue"in e?function(e){let t="[",n=!0;for(const s of e.values||[])n?n=!1:t+=",",t+=At(s);return t+"]"}(e.arrayValue):"mapValue"in e?function(e){const t=Object.keys(e.fields||{}).sort();let n="{",s=!0;for(const i of t)s?s=!1:n+=",",n+=`${i}:${At(e.fields[i])}`;return n+"}"}(e.mapValue):S();var t,n}function kt(e,t){return{referenceValue:`projects/${e.projectId}/databases/${e.database}/documents/${t.path.canonicalString()}`}}function Rt(e){return!!e&&"integerValue"in e}function Ft(e){return!!e&&"arrayValue"in e}function Vt(e){return!!e&&"nullValue"in e}function Ot(e){return!!e&&"doubleValue"in e&&isNaN(Number(e.doubleValue))}function Mt(e){return!!e&&"mapValue"in e}function Lt(e){if(e.geoPointValue)return{geoPointValue:Object.assign({},e.geoPointValue)};if(e.timestampValue&&"object"==typeof e.timestampValue)return{timestampValue:Object.assign({},e.timestampValue)};if(e.mapValue){const t={mapValue:{fields:{}}};return Ze(e.mapValue.fields,((e,n)=>t.mapValue.fields[e]=Lt(n))),t}if(e.arrayValue){const t={arrayValue:{values:[]}};for(let n=0;n<(e.arrayValue.values||[]).length;++n)t.arrayValue.values[n]=Lt(e.arrayValue.values[n]);return t}return Object.assign({},e)}function Pt(e){return"__max__"===(((e.mapValue||{}).fields||{}).__type__||{}).stringValue}function qt(e){return"nullValue"in e?Tt:"booleanValue"in e?{booleanValue:!1}:"integerValue"in e||"doubleValue"in e?{doubleValue:NaN}:"timestampValue"in e?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"stringValue"in e?{stringValue:""}:"bytesValue"in e?{bytesValue:""}:"referenceValue"in e?kt(bt.empty(),H.empty()):"geoPointValue"in e?{geoPointValue:{latitude:-90,longitude:-180}}:"arrayValue"in e?{arrayValue:{}}:"mapValue"in e?{mapValue:{}}:S()}function Ut(e){return"nullValue"in e?{booleanValue:!1}:"booleanValue"in e?{doubleValue:NaN}:"integerValue"in e||"doubleValue"in e?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"timestampValue"in e?{stringValue:""}:"stringValue"in e?{bytesValue:""}:"bytesValue"in e?kt(bt.empty(),H.empty()):"referenceValue"in e?{geoPointValue:{latitude:-90,longitude:-180}}:"geoPointValue"in e?{arrayValue:{}}:"arrayValue"in e?{mapValue:{}}:"mapValue"in e?Et:S()}function Bt(e,t){const n=Dt(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?-1:!e.inclusive&&t.inclusive?1:0}function zt(e,t){const n=Dt(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?1:!e.inclusive&&t.inclusive?-1:0}class Gt{constructor(e){this.value=e}static empty(){return new Gt({mapValue:{}})}field(e){if(e.isEmpty())return this.value;{let t=this.value;for(let n=0;n<e.length-1;++n)if(t=(t.mapValue.fields||{})[e.get(n)],!Mt(t))return null;return t=(t.mapValue.fields||{})[e.lastSegment()],t||null}}set(e,t){this.getFieldsMap(e.popLast())[e.lastSegment()]=Lt(t)}setAll(e){let t=W.emptyPath(),n={},s=[];e.forEach(((e,i)=>{if(!t.isImmediateParentOf(i)){const e=this.getFieldsMap(t);this.applyChanges(e,n,s),n={},s=[],t=i.popLast()}e?n[i.lastSegment()]=Lt(e):s.push(i.lastSegment())}));const i=this.getFieldsMap(t);this.applyChanges(i,n,s)}delete(e){const t=this.field(e.popLast());Mt(t)&&t.mapValue.fields&&delete t.mapValue.fields[e.lastSegment()]}isEqual(e){return xt(this.value,e.value)}getFieldsMap(e){let t=this.value;t.mapValue.fields||(t.mapValue={fields:{}});for(let n=0;n<e.length;++n){let s=t.mapValue.fields[e.get(n)];Mt(s)&&s.mapValue.fields||(s={mapValue:{fields:{}}},t.mapValue.fields[e.get(n)]=s),t=s}return t.mapValue.fields}applyChanges(e,t,n){Ze(t,((t,n)=>e[t]=n));for(const t of n)delete e[t]}clone(){return new Gt(Lt(this.value))}}function Kt(e){const t=[];return Ze(e.fields,((e,n)=>{const s=new W([e]);if(Mt(n)){const e=Kt(n.mapValue).fields;if(0===e.length)t.push(s);else for(const n of e)t.push(s.child(n))}else t.push(s)})),new ct(t)}class $t{constructor(e,t,n,s,i,r,o){this.key=e,this.documentType=t,this.version=n,this.readTime=s,this.createTime=i,this.data=r,this.documentState=o}static newInvalidDocument(e){return new $t(e,0,rt.min(),rt.min(),rt.min(),Gt.empty(),0)}static newFoundDocument(e,t,n,s){return new $t(e,1,t,rt.min(),n,s,0)}static newNoDocument(e,t){return new $t(e,2,t,rt.min(),rt.min(),Gt.empty(),0)}static newUnknownDocument(e,t){return new $t(e,3,t,rt.min(),rt.min(),Gt.empty(),2)}convertToFoundDocument(e,t){return!this.createTime.isEqual(rt.min())||2!==this.documentType&&0!==this.documentType||(this.createTime=e),this.version=e,this.documentType=1,this.data=t,this.documentState=0,this}convertToNoDocument(e){return this.version=e,this.documentType=2,this.data=Gt.empty(),this.documentState=0,this}convertToUnknownDocument(e){return this.version=e,this.documentType=3,this.data=Gt.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=rt.min(),this}setReadTime(e){return this.readTime=e,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(e){return e instanceof $t&&this.key.isEqual(e.key)&&this.version.isEqual(e.version)&&this.documentType===e.documentType&&this.documentState===e.documentState&&this.data.isEqual(e.data)}mutableCopy(){return new $t(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {createTime: ${this.createTime}}), {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class jt{constructor(e,t){this.position=e,this.inclusive=t}}function Qt(e,t,n){let s=0;for(let i=0;i<e.position.length;i++){const r=t[i],o=e.position[i];if(s=r.field.isKeyField()?H.comparator(H.fromName(o.referenceValue),n.key):Dt(o,n.data.field(r.field)),"desc"===r.dir&&(s*=-1),0!==s)break}return s}function Wt(e,t){if(null===e)return null===t;if(null===t)return!1;if(e.inclusive!==t.inclusive||e.position.length!==t.position.length)return!1;for(let n=0;n<e.position.length;n++)if(!xt(e.position[n],t.position[n]))return!1;return!0}class Ht{constructor(e,t="asc"){this.field=e,this.dir=t}}function Yt(e,t){return e.dir===t.dir&&e.field.isEqual(t.field)}class Xt{}class Jt extends Xt{constructor(e,t,n){super(),this.field=e,this.op=t,this.value=n}static create(e,t,n){return e.isKeyField()?"in"===t||"not-in"===t?this.createKeyFieldInFilter(e,t,n):new un(e,t,n):"array-contains"===t?new fn(e,n):"in"===t?new mn(e,n):"not-in"===t?new gn(e,n):"array-contains-any"===t?new pn(e,n):new Jt(e,t,n)}static createKeyFieldInFilter(e,t,n){return"in"===t?new ln(e,n):new hn(e,n)}matches(e){const t=e.data.field(this.field);return"!="===this.op?null!==t&&this.matchesComparison(Dt(t,this.value)):null!==t&&St(this.value)===St(t)&&this.matchesComparison(Dt(t,this.value))}matchesComparison(e){switch(this.op){case"<":return e<0;case"<=":return e<=0;case"==":return 0===e;case"!=":return 0!==e;case">":return e>0;case">=":return e>=0;default:return S()}}isInequality(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}getFlattenedFilters(){return[this]}getFilters(){return[this]}getFirstInequalityField(){return this.isInequality()?this.field:null}}class Zt extends Xt{constructor(e,t){super(),this.filters=e,this.op=t,this.lt=null}static create(e,t){return new Zt(e,t)}matches(e){return en(this)?void 0===this.filters.find((t=>!t.matches(e))):void 0!==this.filters.find((t=>t.matches(e)))}getFlattenedFilters(){return null!==this.lt||(this.lt=this.filters.reduce(((e,t)=>e.concat(t.getFlattenedFilters())),[])),this.lt}getFilters(){return Object.assign([],this.filters)}getFirstInequalityField(){const e=this.ft((e=>e.isInequality()));return null!==e?e.field:null}ft(e){for(const t of this.getFlattenedFilters())if(e(t))return t;return null}}function en(e){return"and"===e.op}function tn(e){return"or"===e.op}function nn(e){return rn(e)&&en(e)}function rn(e){for(const t of e.filters)if(t instanceof Zt)return!1;return!0}function sn(e){if(e instanceof Jt)return e.field.canonicalString()+e.op.toString()+Ct(e.value);if(nn(e))return e.filters.map((e=>sn(e))).join(",");{const t=e.filters.map((e=>sn(e))).join(",");return`${e.op}(${t})`}}function on(e,t){return e instanceof Jt?function(e,t){return t instanceof Jt&&e.op===t.op&&e.field.isEqual(t.field)&&xt(e.value,t.value)}(e,t):e instanceof Zt?function(e,t){return t instanceof Zt&&e.op===t.op&&e.filters.length===t.filters.length&&e.filters.reduce(((e,n,s)=>e&&on(n,t.filters[s])),!0)}(e,t):void S()}function an(e,t){const n=e.filters.concat(t);return Zt.create(n,e.op)}function cn(e){return e instanceof Jt?function(e){return`${e.field.canonicalString()} ${e.op} ${Ct(e.value)}`}(e):e instanceof Zt?function(e){return e.op.toString()+" {"+e.getFilters().map(cn).join(" ,")+"}"}(e):"Filter"}class un extends Jt{constructor(e,t,n){super(e,t,n),this.key=H.fromName(n.referenceValue)}matches(e){const t=H.comparator(e.key,this.key);return this.matchesComparison(t)}}class ln extends Jt{constructor(e,t){super(e,"in",t),this.keys=dn("in",t)}matches(e){return this.keys.some((t=>t.isEqual(e.key)))}}class hn extends Jt{constructor(e,t){super(e,"not-in",t),this.keys=dn("not-in",t)}matches(e){return!this.keys.some((t=>t.isEqual(e.key)))}}function dn(e,t){var n;return((null===(n=t.arrayValue)||void 0===n?void 0:n.values)||[]).map((e=>H.fromName(e.referenceValue)))}class fn extends Jt{constructor(e,t){super(e,"array-contains",t)}matches(e){const t=e.data.field(this.field);return Ft(t)&&_t(t.arrayValue,this.value)}}class mn extends Jt{constructor(e,t){super(e,"in",t)}matches(e){const t=e.data.field(this.field);return null!==t&&_t(this.value.arrayValue,t)}}class gn extends Jt{constructor(e,t){super(e,"not-in",t)}matches(e){if(_t(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;const t=e.data.field(this.field);return null!==t&&!_t(this.value.arrayValue,t)}}class pn extends Jt{constructor(e,t){super(e,"array-contains-any",t)}matches(e){const t=e.data.field(this.field);return!(!Ft(t)||!t.arrayValue.values)&&t.arrayValue.values.some((e=>_t(this.value.arrayValue,e)))}}class yn{constructor(e,t=null,n=[],s=[],i=null,r=null,o=null){this.path=e,this.collectionGroup=t,this.orderBy=n,this.filters=s,this.limit=i,this.startAt=r,this.endAt=o,this.dt=null}}function wn(e,t=null,n=[],s=[],i=null,r=null,o=null){return new yn(e,t,n,s,i,r,o)}function vn(e){const t=D(e);if(null===t.dt){let e=t.path.canonicalString();null!==t.collectionGroup&&(e+="|cg:"+t.collectionGroup),e+="|f:",e+=t.filters.map((e=>sn(e))).join(","),e+="|ob:",e+=t.orderBy.map((e=>function(e){return e.field.canonicalString()+e.dir}(e))).join(","),Ie(t.limit)||(e+="|l:",e+=t.limit),t.startAt&&(e+="|lb:",e+=t.startAt.inclusive?"b:":"a:",e+=t.startAt.position.map((e=>Ct(e))).join(",")),t.endAt&&(e+="|ub:",e+=t.endAt.inclusive?"a:":"b:",e+=t.endAt.position.map((e=>Ct(e))).join(",")),t.dt=e}return t.dt}function In(e,t){if(e.limit!==t.limit)return!1;if(e.orderBy.length!==t.orderBy.length)return!1;for(let n=0;n<e.orderBy.length;n++)if(!Yt(e.orderBy[n],t.orderBy[n]))return!1;if(e.filters.length!==t.filters.length)return!1;for(let n=0;n<e.filters.length;n++)if(!on(e.filters[n],t.filters[n]))return!1;return e.collectionGroup===t.collectionGroup&&!!e.path.isEqual(t.path)&&!!Wt(e.startAt,t.startAt)&&Wt(e.endAt,t.endAt)}function bn(e){return H.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}function En(e,t){return e.filters.filter((e=>e instanceof Jt&&e.field.isEqual(t)))}function Tn(e,t,n){let s=Tt,i=!0;for(const n of En(e,t)){let e=Tt,t=!0;switch(n.op){case"<":case"<=":e=qt(n.value);break;case"==":case"in":case">=":e=n.value;break;case">":e=n.value,t=!1;break;case"!=":case"not-in":e=Tt}Bt({value:s,inclusive:i},{value:e,inclusive:t})<0&&(s=e,i=t)}if(null!==n)for(let r=0;r<e.orderBy.length;++r)if(e.orderBy[r].field.isEqual(t)){const e=n.position[r];Bt({value:s,inclusive:i},{value:e,inclusive:n.inclusive})<0&&(s=e,i=n.inclusive);break}return{value:s,inclusive:i}}function Sn(e,t,n){let s=Et,i=!0;for(const n of En(e,t)){let e=Et,t=!0;switch(n.op){case">=":case">":e=Ut(n.value),t=!1;break;case"==":case"in":case"<=":e=n.value;break;case"<":e=n.value,t=!1;break;case"!=":case"not-in":e=Et}zt({value:s,inclusive:i},{value:e,inclusive:t})>0&&(s=e,i=t)}if(null!==n)for(let r=0;r<e.orderBy.length;++r)if(e.orderBy[r].field.isEqual(t)){const e=n.position[r];zt({value:s,inclusive:i},{value:e,inclusive:n.inclusive})>0&&(s=e,i=n.inclusive);break}return{value:s,inclusive:i}}class xn{constructor(e,t=null,n=[],s=[],i=null,r="F",o=null,u=null){this.path=e,this.collectionGroup=t,this.explicitOrderBy=n,this.filters=s,this.limit=i,this.limitType=r,this.startAt=o,this.endAt=u,this.wt=null,this._t=null,this.startAt,this.endAt}}function _n(e,t,n,s,i,r,o,u){return new xn(e,t,n,s,i,r,o,u)}function Dn(e){return new xn(e)}function Nn(e){return 0===e.filters.length&&null===e.limit&&null==e.startAt&&null==e.endAt&&(0===e.explicitOrderBy.length||1===e.explicitOrderBy.length&&e.explicitOrderBy[0].field.isKeyField())}function Cn(e){return e.explicitOrderBy.length>0?e.explicitOrderBy[0].field:null}function An(e){for(const t of e.filters){const e=t.getFirstInequalityField();if(null!==e)return e}return null}function kn(e){return null!==e.collectionGroup}function Rn(e){const t=D(e);if(null===t.wt){t.wt=[];const e=An(t),n=Cn(t);if(null!==e&&null===n)e.isKeyField()||t.wt.push(new Ht(e)),t.wt.push(new Ht(W.keyField(),"asc"));else{let e=!1;for(const n of t.explicitOrderBy)t.wt.push(n),n.field.isKeyField()&&(e=!0);if(!e){const e=t.explicitOrderBy.length>0?t.explicitOrderBy[t.explicitOrderBy.length-1].dir:"asc";t.wt.push(new Ht(W.keyField(),e))}}}return t.wt}function Fn(e){const t=D(e);if(!t._t)if("F"===t.limitType)t._t=wn(t.path,t.collectionGroup,Rn(t),t.filters,t.limit,t.startAt,t.endAt);else{const e=[];for(const n of Rn(t)){const t="desc"===n.dir?"asc":"desc";e.push(new Ht(n.field,t))}const n=t.endAt?new jt(t.endAt.position,t.endAt.inclusive):null,s=t.startAt?new jt(t.startAt.position,t.startAt.inclusive):null;t._t=wn(t.path,t.collectionGroup,e,t.filters,t.limit,n,s)}return t._t}function Vn(e,t){t.getFirstInequalityField(),An(e);const n=e.filters.concat([t]);return new xn(e.path,e.collectionGroup,e.explicitOrderBy.slice(),n,e.limit,e.limitType,e.startAt,e.endAt)}function On(e,t,n){return new xn(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),t,n,e.startAt,e.endAt)}function Mn(e,t){return In(Fn(e),Fn(t))&&e.limitType===t.limitType}function Ln(e){return`${vn(Fn(e))}|lt:${e.limitType}`}function Pn(e){return`Query(target=${function(e){let t=e.path.canonicalString();return null!==e.collectionGroup&&(t+=" collectionGroup="+e.collectionGroup),e.filters.length>0&&(t+=`, filters: [${e.filters.map((e=>cn(e))).join(", ")}]`),Ie(e.limit)||(t+=", limit: "+e.limit),e.orderBy.length>0&&(t+=`, orderBy: [${e.orderBy.map((e=>function(e){return`${e.field.canonicalString()} (${e.dir})`}(e))).join(", ")}]`),e.startAt&&(t+=", startAt: ",t+=e.startAt.inclusive?"b:":"a:",t+=e.startAt.position.map((e=>Ct(e))).join(",")),e.endAt&&(t+=", endAt: ",t+=e.endAt.inclusive?"a:":"b:",t+=e.endAt.position.map((e=>Ct(e))).join(",")),`Target(${t})`}(Fn(e))}; limitType=${e.limitType})`}function qn(e,t){return t.isFoundDocument()&&function(e,t){const n=t.key.path;return null!==e.collectionGroup?t.key.hasCollectionId(e.collectionGroup)&&e.path.isPrefixOf(n):H.isDocumentKey(e.path)?e.path.isEqual(n):e.path.isImmediateParentOf(n)}(e,t)&&function(e,t){for(const n of Rn(e))if(!n.field.isKeyField()&&null===t.data.field(n.field))return!1;return!0}(e,t)&&function(e,t){for(const n of e.filters)if(!n.matches(t))return!1;return!0}(e,t)&&function(e,t){return!(e.startAt&&!function(e,t,n){const s=Qt(e,t,n);return e.inclusive?s<=0:s<0}(e.startAt,Rn(e),t))&&!(e.endAt&&!function(e,t,n){const s=Qt(e,t,n);return e.inclusive?s>=0:s>0}(e.endAt,Rn(e),t))}(e,t)}function Un(e){return e.collectionGroup||(e.path.length%2==1?e.path.lastSegment():e.path.get(e.path.length-2))}function Bn(e){return(t,n)=>{let s=!1;for(const i of Rn(e)){const e=zn(i,t,n);if(0!==e)return e;s=s||i.field.isKeyField()}return 0}}function zn(e,t,n){const s=e.field.isKeyField()?H.comparator(t.key,n.key):function(e,t,n){const s=t.data.field(e),i=n.data.field(e);return null!==s&&null!==i?Dt(s,i):S()}(e.field,t,n);switch(e.dir){case"asc":return s;case"desc":return-1*s;default:return S()}}class Gn{constructor(e,t){this.mapKeyFn=e,this.equalsFn=t,this.inner={},this.innerSize=0}get(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0!==n)for(const[t,s]of n)if(this.equalsFn(t,e))return s}has(e){return void 0!==this.get(e)}set(e,t){const n=this.mapKeyFn(e),s=this.inner[n];if(void 0===s)return this.inner[n]=[[e,t]],void this.innerSize++;for(let n=0;n<s.length;n++)if(this.equalsFn(s[n][0],e))return void(s[n]=[e,t]);s.push([e,t]),this.innerSize++}delete(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0===n)return!1;for(let s=0;s<n.length;s++)if(this.equalsFn(n[s][0],e))return 1===n.length?delete this.inner[t]:n.splice(s,1),this.innerSize--,!0;return!1}forEach(e){Ze(this.inner,((t,n)=>{for(const[t,s]of n)e(t,s)}))}isEmpty(){return et(this.inner)}size(){return this.innerSize}}const Kn=new tt(H.comparator);function $n(){return Kn}const jn=new tt(H.comparator);function Qn(...e){let t=jn;for(const n of e)t=t.insert(n.key,n);return t}function Wn(e){let t=jn;return e.forEach(((e,n)=>t=t.insert(e,n.overlayedDocument))),t}function Hn(){return Xn()}function Yn(){return Xn()}function Xn(){return new Gn((e=>e.toString()),((e,t)=>e.isEqual(t)))}const Jn=new tt(H.comparator),Zn=new it(H.comparator);function er(...e){let t=Zn;for(const n of e)t=t.add(n);return t}const nr=new it(B);function rr(){return nr}function sr(e,t){if(e.useProto3Json){if(isNaN(t))return{doubleValue:"NaN"};if(t===1/0)return{doubleValue:"Infinity"};if(t===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:be(t)?"-0":t}}function ir(e){return{integerValue:""+e}}function or(e,t){return Ee(t)?ir(t):sr(e,t)}class ar{constructor(){this._=void 0}}function cr(e,t,n){return e instanceof dr?function(e,t){const n={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:e.seconds,nanos:e.nanoseconds}}}};return t&&yt(t)&&(t=wt(t)),t&&(n.fields.__previous_value__=t),{mapValue:n}}(n,t):e instanceof fr?mr(e,t):e instanceof gr?pr(e,t):function(e,t){const n=lr(e,t),s=wr(n)+wr(e.gt);return Rt(n)&&Rt(e.gt)?ir(s):sr(e.serializer,s)}(e,t)}function ur(e,t,n){return e instanceof fr?mr(e,t):e instanceof gr?pr(e,t):n}function lr(e,t){return e instanceof yr?Rt(n=t)||function(e){return!!e&&"doubleValue"in e}(n)?t:{integerValue:0}:null;var n}class dr extends ar{}class fr extends ar{constructor(e){super(),this.elements=e}}function mr(e,t){const n=vr(t);for(const t of e.elements)n.some((e=>xt(e,t)))||n.push(t);return{arrayValue:{values:n}}}class gr extends ar{constructor(e){super(),this.elements=e}}function pr(e,t){let n=vr(t);for(const t of e.elements)n=n.filter((e=>!xt(e,t)));return{arrayValue:{values:n}}}class yr extends ar{constructor(e,t){super(),this.serializer=e,this.gt=t}}function wr(e){return gt(e.integerValue||e.doubleValue)}function vr(e){return Ft(e)&&e.arrayValue.values?e.arrayValue.values.slice():[]}class Ir{constructor(e,t){this.field=e,this.transform=t}}class Er{constructor(e,t){this.version=e,this.transformResults=t}}class Tr{constructor(e,t){this.updateTime=e,this.exists=t}static none(){return new Tr}static exists(e){return new Tr(void 0,e)}static updateTime(e){return new Tr(e)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(e){return this.exists===e.exists&&(this.updateTime?!!e.updateTime&&this.updateTime.isEqual(e.updateTime):!e.updateTime)}}function Sr(e,t){return void 0!==e.updateTime?t.isFoundDocument()&&t.version.isEqual(e.updateTime):void 0===e.exists||e.exists===t.isFoundDocument()}class xr{}function _r(e,t){if(!e.hasLocalMutations||t&&0===t.fields.length)return null;if(null===t)return e.isNoDocument()?new Mr(e.key,Tr.none()):new kr(e.key,e.data,Tr.none());{const n=e.data,s=Gt.empty();let i=new it(W.comparator);for(let e of t.fields)if(!i.has(e)){let t=n.field(e);null===t&&e.length>1&&(e=e.popLast(),t=n.field(e)),null===t?s.delete(e):s.set(e,t),i=i.add(e)}return new Rr(e.key,s,new ct(i.toArray()),Tr.none())}}function Dr(e,t,n){e instanceof kr?function(e,t,n){const s=e.value.clone(),i=Vr(e.fieldTransforms,t,n.transformResults);s.setAll(i),t.convertToFoundDocument(n.version,s).setHasCommittedMutations()}(e,t,n):e instanceof Rr?function(e,t,n){if(!Sr(e.precondition,t))return void t.convertToUnknownDocument(n.version);const s=Vr(e.fieldTransforms,t,n.transformResults),i=t.data;i.setAll(Fr(e)),i.setAll(s),t.convertToFoundDocument(n.version,i).setHasCommittedMutations()}(e,t,n):function(e,t,n){t.convertToNoDocument(n.version).setHasCommittedMutations()}(0,t,n)}function Nr(e,t,n,s){return e instanceof kr?function(e,t,n,s){if(!Sr(e.precondition,t))return n;const i=e.value.clone(),r=Or(e.fieldTransforms,s,t);return i.setAll(r),t.convertToFoundDocument(t.version,i).setHasLocalMutations(),null}(e,t,n,s):e instanceof Rr?function(e,t,n,s){if(!Sr(e.precondition,t))return n;const i=Or(e.fieldTransforms,s,t),r=t.data;return r.setAll(Fr(e)),r.setAll(i),t.convertToFoundDocument(t.version,r).setHasLocalMutations(),null===n?null:n.unionWith(e.fieldMask.fields).unionWith(e.fieldTransforms.map((e=>e.field)))}(e,t,n,s):function(e,t,n){return Sr(e.precondition,t)?(t.convertToNoDocument(t.version).setHasLocalMutations(),null):n}(e,t,n)}function Cr(e,t){let n=null;for(const s of e.fieldTransforms){const e=t.data.field(s.field),i=lr(s.transform,e||null);null!=i&&(null===n&&(n=Gt.empty()),n.set(s.field,i))}return n||null}function Ar(e,t){return e.type===t.type&&!!e.key.isEqual(t.key)&&!!e.precondition.isEqual(t.precondition)&&!!function(e,t){return void 0===e&&void 0===t||!(!e||!t)&&z(e,t,((e,t)=>function(e,t){return e.field.isEqual(t.field)&&function(e,t){return e instanceof fr&&t instanceof fr||e instanceof gr&&t instanceof gr?z(e.elements,t.elements,xt):e instanceof yr&&t instanceof yr?xt(e.gt,t.gt):e instanceof dr&&t instanceof dr}(e.transform,t.transform)}(e,t)))}(e.fieldTransforms,t.fieldTransforms)&&(0===e.type?e.value.isEqual(t.value):1!==e.type||e.data.isEqual(t.data)&&e.fieldMask.isEqual(t.fieldMask))}class kr extends xr{constructor(e,t,n,s=[]){super(),this.key=e,this.value=t,this.precondition=n,this.fieldTransforms=s,this.type=0}getFieldMask(){return null}}class Rr extends xr{constructor(e,t,n,s,i=[]){super(),this.key=e,this.data=t,this.fieldMask=n,this.precondition=s,this.fieldTransforms=i,this.type=1}getFieldMask(){return this.fieldMask}}function Fr(e){const t=new Map;return e.fieldMask.fields.forEach((n=>{if(!n.isEmpty()){const s=e.data.field(n);t.set(n,s)}})),t}function Vr(e,t,n){const s=new Map;x(e.length===n.length);for(let i=0;i<n.length;i++){const r=e[i],o=r.transform,u=t.data.field(r.field);s.set(r.field,ur(o,u,n[i]))}return s}function Or(e,t,n){const s=new Map;for(const i of e){const e=i.transform,r=n.data.field(i.field);s.set(i.field,cr(e,r,t))}return s}class Mr extends xr{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}}class Lr extends xr{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}}class Pr{constructor(e,t,n,s){this.batchId=e,this.localWriteTime=t,this.baseMutations=n,this.mutations=s}applyToRemoteDocument(e,t){const n=t.mutationResults;for(let t=0;t<this.mutations.length;t++){const s=this.mutations[t];s.key.isEqual(e.key)&&Dr(s,e,n[t])}}applyToLocalView(e,t){for(const n of this.baseMutations)n.key.isEqual(e.key)&&(t=Nr(n,e,t,this.localWriteTime));for(const n of this.mutations)n.key.isEqual(e.key)&&(t=Nr(n,e,t,this.localWriteTime));return t}applyToLocalDocumentSet(e,t){const n=Yn();return this.mutations.forEach((s=>{const i=e.get(s.key),r=i.overlayedDocument;let o=this.applyToLocalView(r,i.mutatedFields);o=t.has(s.key)?null:o;const u=_r(r,o);null!==u&&n.set(s.key,u),r.isValidDocument()||r.convertToNoDocument(rt.min())})),n}keys(){return this.mutations.reduce(((e,t)=>e.add(t.key)),er())}isEqual(e){return this.batchId===e.batchId&&z(this.mutations,e.mutations,((e,t)=>Ar(e,t)))&&z(this.baseMutations,e.baseMutations,((e,t)=>Ar(e,t)))}}class qr{constructor(e,t,n,s){this.batch=e,this.commitVersion=t,this.mutationResults=n,this.docVersions=s}static from(e,t,n){x(e.mutations.length===n.length);let s=Jn;const i=e.mutations;for(let e=0;e<i.length;e++)s=s.insert(i[e].key,n[e].version);return new qr(e,t,n,s)}}class Ur{constructor(e,t){this.largestBatchId=e,this.mutation=t}getKey(){return this.mutation.key}isEqual(e){return null!==e&&this.mutation===e.mutation}toString(){return`Overlay{\n      largestBatchId: ${this.largestBatchId},\n      mutation: ${this.mutation.toString()}\n    }`}}class Br{constructor(e,t){this.count=e,this.unchangedNames=t}}var zr,Gr;function Kr(e){switch(e){default:return S();case q.CANCELLED:case q.UNKNOWN:case q.DEADLINE_EXCEEDED:case q.RESOURCE_EXHAUSTED:case q.INTERNAL:case q.UNAVAILABLE:case q.UNAUTHENTICATED:return!1;case q.INVALID_ARGUMENT:case q.NOT_FOUND:case q.ALREADY_EXISTS:case q.PERMISSION_DENIED:case q.FAILED_PRECONDITION:case q.ABORTED:case q.OUT_OF_RANGE:case q.UNIMPLEMENTED:case q.DATA_LOSS:return!0}}function $r(e){if(void 0===e)return I("GRPC error has no .code"),q.UNKNOWN;switch(e){case zr.OK:return q.OK;case zr.CANCELLED:return q.CANCELLED;case zr.UNKNOWN:return q.UNKNOWN;case zr.DEADLINE_EXCEEDED:return q.DEADLINE_EXCEEDED;case zr.RESOURCE_EXHAUSTED:return q.RESOURCE_EXHAUSTED;case zr.INTERNAL:return q.INTERNAL;case zr.UNAVAILABLE:return q.UNAVAILABLE;case zr.UNAUTHENTICATED:return q.UNAUTHENTICATED;case zr.INVALID_ARGUMENT:return q.INVALID_ARGUMENT;case zr.NOT_FOUND:return q.NOT_FOUND;case zr.ALREADY_EXISTS:return q.ALREADY_EXISTS;case zr.PERMISSION_DENIED:return q.PERMISSION_DENIED;case zr.FAILED_PRECONDITION:return q.FAILED_PRECONDITION;case zr.ABORTED:return q.ABORTED;case zr.OUT_OF_RANGE:return q.OUT_OF_RANGE;case zr.UNIMPLEMENTED:return q.UNIMPLEMENTED;case zr.DATA_LOSS:return q.DATA_LOSS;default:return S()}}(Gr=zr||(zr={}))[Gr.OK=0]="OK",Gr[Gr.CANCELLED=1]="CANCELLED",Gr[Gr.UNKNOWN=2]="UNKNOWN",Gr[Gr.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",Gr[Gr.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",Gr[Gr.NOT_FOUND=5]="NOT_FOUND",Gr[Gr.ALREADY_EXISTS=6]="ALREADY_EXISTS",Gr[Gr.PERMISSION_DENIED=7]="PERMISSION_DENIED",Gr[Gr.UNAUTHENTICATED=16]="UNAUTHENTICATED",Gr[Gr.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",Gr[Gr.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",Gr[Gr.ABORTED=10]="ABORTED",Gr[Gr.OUT_OF_RANGE=11]="OUT_OF_RANGE",Gr[Gr.UNIMPLEMENTED=12]="UNIMPLEMENTED",Gr[Gr.INTERNAL=13]="INTERNAL",Gr[Gr.UNAVAILABLE=14]="UNAVAILABLE",Gr[Gr.DATA_LOSS=15]="DATA_LOSS";class jr{constructor(){this.onExistenceFilterMismatchCallbacks=new Map}static get instance(){return Qr}static getOrCreateInstance(){return null===Qr&&(Qr=new jr),Qr}onExistenceFilterMismatch(e){const t=Symbol();return this.onExistenceFilterMismatchCallbacks.set(t,e),()=>this.onExistenceFilterMismatchCallbacks.delete(t)}notifyOnExistenceFilterMismatch(e){this.onExistenceFilterMismatchCallbacks.forEach((t=>t(e)))}}let Qr=null;function Wr(){return new TextEncoder}const li=new h.e([4294967295,4294967295],0);function Hr(e){const t=Wr().encode(e),n=new h.f;return n.update(t),new Uint8Array(n.digest())}function Yr(e){const t=new DataView(e.buffer),n=t.getUint32(0,!0),s=t.getUint32(4,!0),i=t.getUint32(8,!0),r=t.getUint32(12,!0);return[new h.e([n,s],0),new h.e([i,r],0)]}class Xr{constructor(e,t,n){if(this.bitmap=e,this.padding=t,this.hashCount=n,t<0||t>=8)throw new Jr(`Invalid padding: ${t}`);if(n<0)throw new Jr(`Invalid hash count: ${n}`);if(e.length>0&&0===this.hashCount)throw new Jr(`Invalid hash count: ${n}`);if(0===e.length&&0!==t)throw new Jr(`Invalid padding when bitmap length is 0: ${t}`);this.It=8*e.length-t,this.Tt=h.e.fromNumber(this.It)}Et(e,t,n){let s=e.add(t.multiply(h.e.fromNumber(n)));return 1===s.compare(li)&&(s=new h.e([s.getBits(0),s.getBits(1)],0)),s.modulo(this.Tt).toNumber()}At(e){return!!(this.bitmap[Math.floor(e/8)]&1<<e%8)}vt(e){if(0===this.It)return!1;const t=Hr(e),[n,s]=Yr(t);for(let e=0;e<this.hashCount;e++){const t=this.Et(n,s,e);if(!this.At(t))return!1}return!0}static create(e,t,n){const s=e%8==0?0:8-e%8,i=new Uint8Array(Math.ceil(e/8)),r=new Xr(i,s,t);return n.forEach((e=>r.insert(e))),r}insert(e){if(0===this.It)return;const t=Hr(e),[n,s]=Yr(t);for(let e=0;e<this.hashCount;e++){const t=this.Et(n,s,e);this.Rt(t)}}Rt(e){const t=Math.floor(e/8),n=e%8;this.bitmap[t]|=1<<n}}class Jr extends Error{constructor(){super(...arguments),this.name="BloomFilterError"}}class Zr{constructor(e,t,n,s,i){this.snapshotVersion=e,this.targetChanges=t,this.targetMismatches=n,this.documentUpdates=s,this.resolvedLimboDocuments=i}static createSynthesizedRemoteEventForCurrentChange(e,t,n){const s=new Map;return s.set(e,es.createSynthesizedTargetChangeForCurrentChange(e,t,n)),new Zr(rt.min(),s,new tt(B),$n(),er())}}class es{constructor(e,t,n,s,i){this.resumeToken=e,this.current=t,this.addedDocuments=n,this.modifiedDocuments=s,this.removedDocuments=i}static createSynthesizedTargetChangeForCurrentChange(e,t,n){return new es(n,t,er(),er(),er())}}class ts{constructor(e,t,n,s){this.Pt=e,this.removedTargetIds=t,this.key=n,this.bt=s}}class ns{constructor(e,t){this.targetId=e,this.Vt=t}}class rs{constructor(e,t,n=ht.EMPTY_BYTE_STRING,s=null){this.state=e,this.targetIds=t,this.resumeToken=n,this.cause=s}}class ss{constructor(){this.St=0,this.Dt=as(),this.Ct=ht.EMPTY_BYTE_STRING,this.xt=!1,this.Nt=!0}get current(){return this.xt}get resumeToken(){return this.Ct}get kt(){return 0!==this.St}get Mt(){return this.Nt}$t(e){e.approximateByteSize()>0&&(this.Nt=!0,this.Ct=e)}Ot(){let e=er(),t=er(),n=er();return this.Dt.forEach(((s,i)=>{switch(i){case 0:e=e.add(s);break;case 2:t=t.add(s);break;case 1:n=n.add(s);break;default:S()}})),new es(this.Ct,this.xt,e,t,n)}Ft(){this.Nt=!1,this.Dt=as()}Bt(e,t){this.Nt=!0,this.Dt=this.Dt.insert(e,t)}Lt(e){this.Nt=!0,this.Dt=this.Dt.remove(e)}qt(){this.St+=1}Ut(){this.St-=1}Kt(){this.Nt=!0,this.xt=!0}}class is{constructor(e){this.Gt=e,this.Qt=new Map,this.jt=$n(),this.zt=os(),this.Wt=new tt(B)}Ht(e){for(const t of e.Pt)e.bt&&e.bt.isFoundDocument()?this.Jt(t,e.bt):this.Yt(t,e.key,e.bt);for(const t of e.removedTargetIds)this.Yt(t,e.key,e.bt)}Xt(e){this.forEachTarget(e,(t=>{const n=this.Zt(t);switch(e.state){case 0:this.te(t)&&n.$t(e.resumeToken);break;case 1:n.Ut(),n.kt||n.Ft(),n.$t(e.resumeToken);break;case 2:n.Ut(),n.kt||this.removeTarget(t);break;case 3:this.te(t)&&(n.Kt(),n.$t(e.resumeToken));break;case 4:this.te(t)&&(this.ee(t),n.$t(e.resumeToken));break;default:S()}}))}forEachTarget(e,t){e.targetIds.length>0?e.targetIds.forEach(t):this.Qt.forEach(((e,n)=>{this.te(n)&&t(n)}))}ne(e){var t;const n=e.targetId,s=e.Vt.count,i=this.se(n);if(i){const r=i.target;if(bn(r))if(0===s){const e=new H(r.path);this.Yt(n,e,$t.newNoDocument(e,rt.min()))}else x(1===s);else{const i=this.ie(n);if(i!==s){const s=this.re(e,i);if(0!==s){this.ee(n);const e=2===s?"TargetPurposeExistenceFilterMismatchBloom":"TargetPurposeExistenceFilterMismatch";this.Wt=this.Wt.insert(n,e)}null===(t=jr.instance)||void 0===t||t.notifyOnExistenceFilterMismatch(function(e,t,n){var s,i,r,o,u,c;const a={localCacheCount:t,existenceFilterCount:n.count},l=n.unchangedNames;return l&&(a.bloomFilter={applied:0===e,hashCount:null!==(s=null==l?void 0:l.hashCount)&&void 0!==s?s:0,bitmapLength:null!==(o=null===(r=null===(i=null==l?void 0:l.bits)||void 0===i?void 0:i.bitmap)||void 0===r?void 0:r.length)&&void 0!==o?o:0,padding:null!==(c=null===(u=null==l?void 0:l.bits)||void 0===u?void 0:u.padding)&&void 0!==c?c:0}),a}(s,i,e.Vt))}}}}re(e,t){const{unchangedNames:n,count:s}=e.Vt;if(!n||!n.bits)return 1;const{bits:{bitmap:i="",padding:r=0},hashCount:o=0}=n;let u,c;try{u=pt(i).toUint8Array()}catch(e){if(e instanceof ut)return E("Decoding the base64 bloom filter in existence filter failed ("+e.message+"); ignoring the bloom filter and falling back to full re-query."),1;throw e}try{c=new Xr(u,r,o)}catch(e){return E(e instanceof Jr?"BloomFilter error: ":"Applying bloom filter failed: ",e),1}return 0===c.It?1:s!==t-this.oe(e.targetId,c)?2:0}oe(e,t){const n=this.Gt.getRemoteKeysForTarget(e);let s=0;return n.forEach((n=>{const i=this.Gt.ue(),r=`projects/${i.projectId}/databases/${i.database}/documents/${n.path.canonicalString()}`;t.vt(r)||(this.Yt(e,n,null),s++)})),s}ce(e){const t=new Map;this.Qt.forEach(((n,s)=>{const i=this.se(s);if(i){if(n.current&&bn(i.target)){const t=new H(i.target.path);null!==this.jt.get(t)||this.ae(s,t)||this.Yt(s,t,$t.newNoDocument(t,e))}n.Mt&&(t.set(s,n.Ot()),n.Ft())}}));let n=er();this.zt.forEach(((e,t)=>{let s=!0;t.forEachWhile((e=>{const t=this.se(e);return!t||"TargetPurposeLimboResolution"===t.purpose||(s=!1,!1)})),s&&(n=n.add(e))})),this.jt.forEach(((t,n)=>n.setReadTime(e)));const s=new Zr(e,t,this.Wt,this.jt,n);return this.jt=$n(),this.zt=os(),this.Wt=new tt(B),s}Jt(e,t){if(!this.te(e))return;const n=this.ae(e,t.key)?2:0;this.Zt(e).Bt(t.key,n),this.jt=this.jt.insert(t.key,t),this.zt=this.zt.insert(t.key,this.he(t.key).add(e))}Yt(e,t,n){if(!this.te(e))return;const s=this.Zt(e);this.ae(e,t)?s.Bt(t,1):s.Lt(t),this.zt=this.zt.insert(t,this.he(t).delete(e)),n&&(this.jt=this.jt.insert(t,n))}removeTarget(e){this.Qt.delete(e)}ie(e){const t=this.Zt(e).Ot();return this.Gt.getRemoteKeysForTarget(e).size+t.addedDocuments.size-t.removedDocuments.size}qt(e){this.Zt(e).qt()}Zt(e){let t=this.Qt.get(e);return t||(t=new ss,this.Qt.set(e,t)),t}he(e){let t=this.zt.get(e);return t||(t=new it(B),this.zt=this.zt.insert(e,t)),t}te(e){const t=null!==this.se(e);return t||v("WatchChangeAggregator","Detected inactive target",e),t}se(e){const t=this.Qt.get(e);return t&&t.kt?null:this.Gt.le(e)}ee(e){this.Qt.set(e,new ss),this.Gt.getRemoteKeysForTarget(e).forEach((t=>{this.Yt(e,t,null)}))}ae(e,t){return this.Gt.getRemoteKeysForTarget(e).has(t)}}function os(){return new tt(H.comparator)}function as(){return new tt(H.comparator)}const cs={asc:"ASCENDING",desc:"DESCENDING"},us={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"},ls={and:"AND",or:"OR"};class hs{constructor(e,t){this.databaseId=e,this.useProto3Json=t}}function ds(e,t){return e.useProto3Json||Ie(t)?t:{value:t}}function fs(e,t){return e.useProto3Json?`${new Date(1e3*t.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+t.nanoseconds).slice(-9)}Z`:{seconds:""+t.seconds,nanos:t.nanoseconds}}function ms(e,t){return e.useProto3Json?t.toBase64():t.toUint8Array()}function gs(e,t){return fs(e,t.toTimestamp())}function ps(e){return x(!!e),rt.fromTimestamp(function(e){const t=mt(e);return new K(t.seconds,t.nanos)}(e))}function ys(e,t){return function(e){return new j(["projects",e.projectId,"databases",e.database])}(e).child("documents").child(t).canonicalString()}function ws(e){const t=j.fromString(e);return x(qs(t)),t}function vs(e,t){return ys(e.databaseId,t.path)}function Is(e,t){const n=ws(t);if(n.get(1)!==e.databaseId.projectId)throw new N(q.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+n.get(1)+" vs "+e.databaseId.projectId);if(n.get(3)!==e.databaseId.database)throw new N(q.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+n.get(3)+" vs "+e.databaseId.database);return new H(Ss(n))}function bs(e,t){return ys(e.databaseId,t)}function Es(e){const t=ws(e);return 4===t.length?j.emptyPath():Ss(t)}function Ts(e){return new j(["projects",e.databaseId.projectId,"databases",e.databaseId.database]).canonicalString()}function Ss(e){return x(e.length>4&&"documents"===e.get(4)),e.popFirst(5)}function xs(e,t,n){return{name:vs(e,t),fields:n.value.mapValue.fields}}function _s(e,t,n){const s=Is(e,t.name),i=ps(t.updateTime),r=t.createTime?ps(t.createTime):rt.min(),o=new Gt({mapValue:{fields:t.fields}}),u=$t.newFoundDocument(s,i,r,o);return n&&u.setHasCommittedMutations(),n?u.setHasCommittedMutations():u}function Ds(e,t){let n;if(t instanceof kr)n={update:xs(e,t.key,t.value)};else if(t instanceof Mr)n={delete:vs(e,t.key)};else if(t instanceof Rr)n={update:xs(e,t.key,t.data),updateMask:Ps(t.fieldMask)};else{if(!(t instanceof Lr))return S();n={verify:vs(e,t.key)}}return t.fieldTransforms.length>0&&(n.updateTransforms=t.fieldTransforms.map((e=>function(e,t){const n=t.transform;if(n instanceof dr)return{fieldPath:t.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(n instanceof fr)return{fieldPath:t.field.canonicalString(),appendMissingElements:{values:n.elements}};if(n instanceof gr)return{fieldPath:t.field.canonicalString(),removeAllFromArray:{values:n.elements}};if(n instanceof yr)return{fieldPath:t.field.canonicalString(),increment:n.gt};throw S()}(0,e)))),t.precondition.isNone||(n.currentDocument=function(e,t){return void 0!==t.updateTime?{updateTime:gs(e,t.updateTime)}:void 0!==t.exists?{exists:t.exists}:S()}(e,t.precondition)),n}function Ns(e,t){const n=t.currentDocument?function(e){return void 0!==e.updateTime?Tr.updateTime(ps(e.updateTime)):void 0!==e.exists?Tr.exists(e.exists):Tr.none()}(t.currentDocument):Tr.none(),s=t.updateTransforms?t.updateTransforms.map((t=>function(e,t){let n=null;if("setToServerValue"in t)x("REQUEST_TIME"===t.setToServerValue),n=new dr;else if("appendMissingElements"in t){const e=t.appendMissingElements.values||[];n=new fr(e)}else if("removeAllFromArray"in t){const e=t.removeAllFromArray.values||[];n=new gr(e)}else"increment"in t?n=new yr(e,t.increment):S();const s=W.fromServerFormat(t.fieldPath);return new Ir(s,n)}(e,t))):[];if(t.update){t.update.name;const i=Is(e,t.update.name),r=new Gt({mapValue:{fields:t.update.fields}});if(t.updateMask){const e=function(e){const t=e.fieldPaths||[];return new ct(t.map((e=>W.fromServerFormat(e))))}(t.updateMask);return new Rr(i,r,e,n,s)}return new kr(i,r,n,s)}if(t.delete){const s=Is(e,t.delete);return new Mr(s,n)}if(t.verify){const s=Is(e,t.verify);return new Lr(s,n)}return S()}function Cs(e,t){return{documents:[bs(e,t.path)]}}function As(e,t){const n={structuredQuery:{}},s=t.path;null!==t.collectionGroup?(n.parent=bs(e,s),n.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(n.parent=bs(e,s.popLast()),n.structuredQuery.from=[{collectionId:s.lastSegment()}]);const i=function(e){if(0!==e.length)return Ls(Zt.create(e,"and"))}(t.filters);i&&(n.structuredQuery.where=i);const r=function(e){if(0!==e.length)return e.map((e=>function(e){return{field:Os(e.field),direction:tr(e.dir)}}(e)))}(t.orderBy);r&&(n.structuredQuery.orderBy=r);const o=ds(e,t.limit);var u;return null!==o&&(n.structuredQuery.limit=o),t.startAt&&(n.structuredQuery.startAt={before:(u=t.startAt).inclusive,values:u.position}),t.endAt&&(n.structuredQuery.endAt=function(e){return{before:!e.inclusive,values:e.position}}(t.endAt)),n}function ks(e){let t=Es(e.parent);const n=e.structuredQuery,s=n.from?n.from.length:0;let i=null;if(s>0){x(1===s);const e=n.from[0];e.allDescendants?i=e.collectionId:t=t.child(e.collectionId)}let r=[];n.where&&(r=function(e){const t=Rs(e);return t instanceof Zt&&nn(t)?t.getFilters():[t]}(n.where));let o=[];n.orderBy&&(o=n.orderBy.map((e=>function(e){return new Ht(Ms(e.field),function(e){switch(e){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(e.direction))}(e))));let u=null;n.limit&&(u=function(e){let t;return t="object"==typeof e?e.value:e,Ie(t)?null:t}(n.limit));let c=null;n.startAt&&(c=function(e){const t=!!e.before,n=e.values||[];return new jt(n,t)}(n.startAt));let a=null;return n.endAt&&(a=function(e){const t=!e.before,n=e.values||[];return new jt(n,t)}(n.endAt)),_n(t,i,o,r,u,"F",c,a)}function Rs(e){return void 0!==e.unaryFilter?function(e){switch(e.unaryFilter.op){case"IS_NAN":const t=Ms(e.unaryFilter.field);return Jt.create(t,"==",{doubleValue:NaN});case"IS_NULL":const n=Ms(e.unaryFilter.field);return Jt.create(n,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":const s=Ms(e.unaryFilter.field);return Jt.create(s,"!=",{doubleValue:NaN});case"IS_NOT_NULL":const i=Ms(e.unaryFilter.field);return Jt.create(i,"!=",{nullValue:"NULL_VALUE"});default:return S()}}(e):void 0!==e.fieldFilter?function(e){return Jt.create(Ms(e.fieldFilter.field),function(e){switch(e){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return S()}}(e.fieldFilter.op),e.fieldFilter.value)}(e):void 0!==e.compositeFilter?function(e){return Zt.create(e.compositeFilter.filters.map((e=>Rs(e))),function(e){switch(e){case"AND":return"and";case"OR":return"or";default:return S()}}(e.compositeFilter.op))}(e):S()}function tr(e){return cs[e]}function Fs(e){return us[e]}function Vs(e){return ls[e]}function Os(e){return{fieldPath:e.canonicalString()}}function Ms(e){return W.fromServerFormat(e.fieldPath)}function Ls(e){return e instanceof Jt?function(e){if("=="===e.op){if(Ot(e.value))return{unaryFilter:{field:Os(e.field),op:"IS_NAN"}};if(Vt(e.value))return{unaryFilter:{field:Os(e.field),op:"IS_NULL"}}}else if("!="===e.op){if(Ot(e.value))return{unaryFilter:{field:Os(e.field),op:"IS_NOT_NAN"}};if(Vt(e.value))return{unaryFilter:{field:Os(e.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:Os(e.field),op:Fs(e.op),value:e.value}}}(e):e instanceof Zt?function(e){const t=e.getFilters().map((e=>Ls(e)));return 1===t.length?t[0]:{compositeFilter:{op:Vs(e.op),filters:t}}}(e):S()}function Ps(e){const t=[];return e.fields.forEach((e=>t.push(e.canonicalString()))),{fieldPaths:t}}function qs(e){return e.length>=4&&"projects"===e.get(0)&&"databases"===e.get(2)}class Us{constructor(e,t,n,s,i=rt.min(),r=rt.min(),o=ht.EMPTY_BYTE_STRING,u=null){this.target=e,this.targetId=t,this.purpose=n,this.sequenceNumber=s,this.snapshotVersion=i,this.lastLimboFreeSnapshotVersion=r,this.resumeToken=o,this.expectedCount=u}withSequenceNumber(e){return new Us(this.target,this.targetId,this.purpose,e,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,this.expectedCount)}withResumeToken(e,t){return new Us(this.target,this.targetId,this.purpose,this.sequenceNumber,t,this.lastLimboFreeSnapshotVersion,e,null)}withExpectedCount(e){return new Us(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,e)}withLastLimboFreeSnapshotVersion(e){return new Us(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,e,this.resumeToken,this.expectedCount)}}class Bs{constructor(e){this.fe=e}}function zs(e,t){const n=t.key,s={prefixPath:n.getCollectionPath().popLast().toArray(),collectionGroup:n.collectionGroup,documentId:n.path.lastSegment(),readTime:Gs(t.readTime),hasCommittedMutations:t.hasCommittedMutations};if(t.isFoundDocument())s.document=function(e,t){return{name:vs(e,t.key),fields:t.data.value.mapValue.fields,updateTime:fs(e,t.version.toTimestamp()),createTime:fs(e,t.createTime.toTimestamp())}}(e.fe,t);else if(t.isNoDocument())s.noDocument={path:n.path.toArray(),readTime:Ks(t.version)};else{if(!t.isUnknownDocument())return S();s.unknownDocument={path:n.path.toArray(),version:Ks(t.version)}}return s}function Gs(e){const t=e.toTimestamp();return[t.seconds,t.nanoseconds]}function Ks(e){const t=e.toTimestamp();return{seconds:t.seconds,nanoseconds:t.nanoseconds}}function $s(e){const t=new K(e.seconds,e.nanoseconds);return rt.fromTimestamp(t)}function js(e,t){const n=(t.baseMutations||[]).map((t=>Ns(e.fe,t)));for(let e=0;e<t.mutations.length-1;++e){const n=t.mutations[e];if(e+1<t.mutations.length&&void 0!==t.mutations[e+1].transform){const s=t.mutations[e+1];n.updateTransforms=s.transform.fieldTransforms,t.mutations.splice(e+1,1),++e}}const s=t.mutations.map((t=>Ns(e.fe,t))),i=K.fromMillis(t.localWriteTimeMs);return new Pr(t.batchId,i,n,s)}function Qs(e){const t=$s(e.readTime),n=void 0!==e.lastLimboFreeSnapshotVersion?$s(e.lastLimboFreeSnapshotVersion):rt.min();let s;var i;return void 0!==e.query.documents?(x(1===(i=e.query).documents.length),s=Fn(Dn(Es(i.documents[0])))):s=function(e){return Fn(ks(e))}(e.query),new Us(s,e.targetId,"TargetPurposeListen",e.lastListenSequenceNumber,t,n,ht.fromBase64String(e.resumeToken))}function Ws(e,t){const n=Ks(t.snapshotVersion),s=Ks(t.lastLimboFreeSnapshotVersion);let i;i=bn(t.target)?Cs(e.fe,t.target):As(e.fe,t.target);const r=t.resumeToken.toBase64();return{targetId:t.targetId,canonicalId:vn(t.target),readTime:n,resumeToken:r,lastListenSequenceNumber:t.sequenceNumber,lastLimboFreeSnapshotVersion:s,query:i}}function Hs(e){const t=ks({parent:e.parent,structuredQuery:e.structuredQuery});return"LAST"===e.limitType?On(t,t.limit,"L"):t}function Ys(e,t){return new Ur(t.largestBatchId,Ns(e.fe,t.overlayMutation))}function Xs(e,t){const n=t.path.lastSegment();return[e,Te(t.path.popLast()),n]}function Js(e,t,n,s){return{indexId:e,uid:t.uid||"",sequenceNumber:n,readTime:Ks(s.readTime),documentKey:Te(s.documentKey.path),largestBatchId:s.largestBatchId}}class Zs{getBundleMetadata(e,t){return ei(e).get(t).next((e=>{if(e)return{id:(t=e).bundleId,createTime:$s(t.createTime),version:t.version};var t}))}saveBundleMetadata(e,t){return ei(e).put({bundleId:(n=t).id,createTime:Ks(ps(n.createTime)),version:n.version});var n}getNamedQuery(e,t){return ti(e).get(t).next((e=>{if(e)return{name:(t=e).name,query:Hs(t.bundledQuery),readTime:$s(t.readTime)};var t}))}saveNamedQuery(e,t){return ti(e).put(function(e){return{name:e.name,readTime:Ks(ps(e.readTime)),bundledQuery:e.bundledQuery}}(t))}}function ei(e){return Xe(e,"bundles")}function ti(e){return Xe(e,"namedQueries")}class ni{constructor(e,t){this.serializer=e,this.userId=t}static de(e,t){const n=t.uid||"";return new ni(e,n)}getOverlay(e,t){return ri(e).get(Xs(this.userId,t)).next((e=>e?Ys(this.serializer,e):null))}getOverlays(e,t){const n=Hn();return ae.forEach(t,(t=>this.getOverlay(e,t).next((e=>{null!==e&&n.set(t,e)})))).next((()=>n))}saveOverlays(e,t,n){const s=[];return n.forEach(((n,i)=>{const r=new Ur(t,i);s.push(this.we(e,r))})),ae.waitFor(s)}removeOverlaysForBatchId(e,t,n){const s=new Set;t.forEach((e=>s.add(Te(e.getCollectionPath()))));const i=[];return s.forEach((t=>{const s=IDBKeyRange.bound([this.userId,t,n],[this.userId,t,n+1],!1,!0);i.push(ri(e).J("collectionPathOverlayIndex",s))})),ae.waitFor(i)}getOverlaysForCollection(e,t,n){const s=Hn(),i=Te(t),r=IDBKeyRange.bound([this.userId,i,n],[this.userId,i,Number.POSITIVE_INFINITY],!0);return ri(e).j("collectionPathOverlayIndex",r).next((e=>{for(const t of e){const e=Ys(this.serializer,t);s.set(e.getKey(),e)}return s}))}getOverlaysForCollectionGroup(e,t,n,s){const i=Hn();let r;const o=IDBKeyRange.bound([this.userId,t,n],[this.userId,t,Number.POSITIVE_INFINITY],!0);return ri(e).X({index:"collectionGroupOverlayIndex",range:o},((e,t,n)=>{const o=Ys(this.serializer,t);i.size()<s||o.largestBatchId===r?(i.set(o.getKey(),o),r=o.largestBatchId):n.done()})).next((()=>i))}we(e,t){return ri(e).put(function(e,t,n){const[s,i,r]=Xs(t,n.mutation.key);return{userId:t,collectionPath:i,documentId:r,collectionGroup:n.mutation.key.getCollectionGroup(),largestBatchId:n.largestBatchId,overlayMutation:Ds(e.fe,n.mutation)}}(this.serializer,this.userId,t))}}function ri(e){return Xe(e,"documentOverlays")}class br{constructor(){}_e(e,t){this.me(e,t),t.ge()}me(e,t){if("nullValue"in e)this.ye(t,5);else if("booleanValue"in e)this.ye(t,10),t.pe(e.booleanValue?1:0);else if("integerValue"in e)this.ye(t,15),t.pe(gt(e.integerValue));else if("doubleValue"in e){const n=gt(e.doubleValue);isNaN(n)?this.ye(t,13):(this.ye(t,15),be(n)?t.pe(0):t.pe(n))}else if("timestampValue"in e){const n=e.timestampValue;this.ye(t,20),"string"==typeof n?t.Ie(n):(t.Ie(`${n.seconds||""}`),t.pe(n.nanos||0))}else if("stringValue"in e)this.Te(e.stringValue,t),this.Ee(t);else if("bytesValue"in e)this.ye(t,30),t.Ae(pt(e.bytesValue)),this.Ee(t);else if("referenceValue"in e)this.ve(e.referenceValue,t);else if("geoPointValue"in e){const n=e.geoPointValue;this.ye(t,45),t.pe(n.latitude||0),t.pe(n.longitude||0)}else"mapValue"in e?Pt(e)?this.ye(t,Number.MAX_SAFE_INTEGER):(this.Re(e.mapValue,t),this.Ee(t)):"arrayValue"in e?(this.Pe(e.arrayValue,t),this.Ee(t)):S()}Te(e,t){this.ye(t,25),this.be(e,t)}be(e,t){t.Ie(e)}Re(e,t){const n=e.fields||{};this.ye(t,55);for(const e of Object.keys(n))this.Te(e,t),this.me(n[e],t)}Pe(e,t){const n=e.values||[];this.ye(t,50);for(const e of n)this.me(e,t)}ve(e,t){this.ye(t,37),H.fromName(e).path.forEach((e=>{this.ye(t,60),this.be(e,t)}))}ye(e,t){e.pe(t)}Ee(e){e.pe(2)}}function si(e){if(0===e)return 8;let t=0;return!(e>>4)&&(t+=4,e<<=4),!(e>>6)&&(t+=2,e<<=2),!(e>>7)&&(t+=1),t}function ii(e){const t=64-function(e){let t=0;for(let n=0;n<8;++n){const s=si(255&e[n]);if(t+=s,8!==s)break}return t}(e);return Math.ceil(t/8)}br.Ve=new br;class oi{constructor(){this.buffer=new Uint8Array(1024),this.position=0}Se(e){const t=e[Symbol.iterator]();let n=t.next();for(;!n.done;)this.De(n.value),n=t.next();this.Ce()}xe(e){const t=e[Symbol.iterator]();let n=t.next();for(;!n.done;)this.Ne(n.value),n=t.next();this.ke()}Me(e){for(const t of e){const e=t.charCodeAt(0);if(e<128)this.De(e);else if(e<2048)this.De(960|e>>>6),this.De(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.De(480|e>>>12),this.De(128|63&e>>>6),this.De(128|63&e);else{const e=t.codePointAt(0);this.De(240|e>>>18),this.De(128|63&e>>>12),this.De(128|63&e>>>6),this.De(128|63&e)}}this.Ce()}$e(e){for(const t of e){const e=t.charCodeAt(0);if(e<128)this.Ne(e);else if(e<2048)this.Ne(960|e>>>6),this.Ne(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.Ne(480|e>>>12),this.Ne(128|63&e>>>6),this.Ne(128|63&e);else{const e=t.codePointAt(0);this.Ne(240|e>>>18),this.Ne(128|63&e>>>12),this.Ne(128|63&e>>>6),this.Ne(128|63&e)}}this.ke()}Oe(e){const t=this.Fe(e),n=ii(t);this.Be(1+n),this.buffer[this.position++]=255&n;for(let e=t.length-n;e<t.length;++e)this.buffer[this.position++]=255&t[e]}Le(e){const t=this.Fe(e),n=ii(t);this.Be(1+n),this.buffer[this.position++]=~(255&n);for(let e=t.length-n;e<t.length;++e)this.buffer[this.position++]=~(255&t[e])}qe(){this.Ue(255),this.Ue(255)}Ke(){this.Ge(255),this.Ge(255)}reset(){this.position=0}seed(e){this.Be(e.length),this.buffer.set(e,this.position),this.position+=e.length}Qe(){return this.buffer.slice(0,this.position)}Fe(e){const t=function(e){const t=new DataView(new ArrayBuffer(8));return t.setFloat64(0,e,!1),new Uint8Array(t.buffer)}(e),n=!!(128&t[0]);t[0]^=n?255:128;for(let e=1;e<t.length;++e)t[e]^=n?255:0;return t}De(e){const t=255&e;0===t?(this.Ue(0),this.Ue(255)):255===t?(this.Ue(255),this.Ue(0)):this.Ue(t)}Ne(e){const t=255&e;0===t?(this.Ge(0),this.Ge(255)):255===t?(this.Ge(255),this.Ge(0)):this.Ge(e)}Ce(){this.Ue(0),this.Ue(1)}ke(){this.Ge(0),this.Ge(1)}Ue(e){this.Be(1),this.buffer[this.position++]=e}Ge(e){this.Be(1),this.buffer[this.position++]=~e}Be(e){const t=e+this.position;if(t<=this.buffer.length)return;let n=2*this.buffer.length;n<t&&(n=t);const s=new Uint8Array(n);s.set(this.buffer),this.buffer=s}}class ai{constructor(e){this.je=e}Ae(e){this.je.Se(e)}Ie(e){this.je.Me(e)}pe(e){this.je.Oe(e)}ge(){this.je.qe()}}class ci{constructor(e){this.je=e}Ae(e){this.je.xe(e)}Ie(e){this.je.$e(e)}pe(e){this.je.Le(e)}ge(){this.je.Ke()}}class ui{constructor(){this.je=new oi,this.ze=new ai(this.je),this.We=new ci(this.je)}seed(e){this.je.seed(e)}He(e){return 0===e?this.ze:this.We}Qe(){return this.je.Qe()}reset(){this.je.reset()}}class hi{constructor(e,t,n,s){this.indexId=e,this.documentKey=t,this.arrayValue=n,this.directionalValue=s}Je(){const e=this.directionalValue.length,t=0===e||255===this.directionalValue[e-1]?e+1:e,n=new Uint8Array(t);return n.set(this.directionalValue,0),t!==e?n.set([0],this.directionalValue.length):++n[n.length-1],new hi(this.indexId,this.documentKey,this.arrayValue,n)}}function di(e,t){let n=e.indexId-t.indexId;return 0!==n?n:(n=fi(e.arrayValue,t.arrayValue),0!==n?n:(n=fi(e.directionalValue,t.directionalValue),0!==n?n:H.comparator(e.documentKey,t.documentKey)))}function fi(e,t){for(let n=0;n<e.length&&n<t.length;++n){const s=e[n]-t[n];if(0!==s)return s}return e.length-t.length}class mi{constructor(e){this.collectionId=null!=e.collectionGroup?e.collectionGroup:e.path.lastSegment(),this.Ye=e.orderBy,this.Xe=[];for(const t of e.filters){const e=t;e.isInequality()?this.Ze=e:this.Xe.push(e)}}tn(e){x(e.collectionGroup===this.collectionId);const t=X(e);if(void 0!==t&&!this.en(t))return!1;const n=dt(e);let s=new Set,i=0,r=0;for(;i<n.length&&this.en(n[i]);++i)s=s.add(n[i].fieldPath.canonicalString());if(i===n.length)return!0;if(void 0!==this.Ze){if(!s.has(this.Ze.field.canonicalString())){const e=n[i];if(!this.nn(this.Ze,e)||!this.sn(this.Ye[r++],e))return!1}++i}for(;i<n.length;++i){const e=n[i];if(r>=this.Ye.length||!this.sn(this.Ye[r++],e))return!1}return!0}en(e){for(const t of this.Xe)if(this.nn(t,e))return!0;return!1}nn(e,t){if(void 0===e||!e.field.isEqual(t.fieldPath))return!1;const n="array-contains"===e.op||"array-contains-any"===e.op;return 2===t.kind===n}sn(e,t){return!!e.field.isEqual(t.fieldPath)&&(0===t.kind&&"asc"===e.dir||1===t.kind&&"desc"===e.dir)}}function gi(e){var t,n;if(x(e instanceof Jt||e instanceof Zt),e instanceof Jt){if(e instanceof mn){const s=(null===(n=null===(t=e.value.arrayValue)||void 0===t?void 0:t.values)||void 0===n?void 0:n.map((t=>Jt.create(e.field,"==",t))))||[];return Zt.create(s,"or")}return e}const s=e.filters.map((e=>gi(e)));return Zt.create(s,e.op)}function pi(e){if(0===e.getFilters().length)return[];const t=Ii(gi(e));return x(vi(t)),yi(t)||wi(t)?[t]:t.getFilters()}function yi(e){return e instanceof Jt}function wi(e){return e instanceof Zt&&nn(e)}function vi(e){return yi(e)||wi(e)||function(e){if(e instanceof Zt&&tn(e)){for(const t of e.getFilters())if(!yi(t)&&!wi(t))return!1;return!0}return!1}(e)}function Ii(e){if(x(e instanceof Jt||e instanceof Zt),e instanceof Jt)return e;if(1===e.filters.length)return Ii(e.filters[0]);const t=e.filters.map((e=>Ii(e)));let n=Zt.create(t,e.op);return n=Ti(n),vi(n)?n:(x(n instanceof Zt),x(en(n)),x(n.filters.length>1),n.filters.reduce(((e,t)=>bi(e,t))))}function bi(e,t){let n;return x(e instanceof Jt||e instanceof Zt),x(t instanceof Jt||t instanceof Zt),n=e instanceof Jt?t instanceof Jt?function(e,t){return Zt.create([e,t],"and")}(e,t):Ei(e,t):t instanceof Jt?Ei(t,e):function(e,t){if(x(e.filters.length>0&&t.filters.length>0),en(e)&&en(t))return an(e,t.getFilters());const n=tn(e)?e:t,s=tn(e)?t:e,i=n.filters.map((e=>bi(e,s)));return Zt.create(i,"or")}(e,t),Ti(n)}function Ei(e,t){if(en(t))return an(t,e.getFilters());{const n=t.filters.map((t=>bi(e,t)));return Zt.create(n,"or")}}function Ti(e){if(x(e instanceof Jt||e instanceof Zt),e instanceof Jt)return e;const t=e.getFilters();if(1===t.length)return Ti(t[0]);if(rn(e))return e;const n=t.map((e=>Ti(e))),s=[];return n.forEach((t=>{t instanceof Jt?s.push(t):t instanceof Zt&&(t.op===e.op?s.push(...t.filters):s.push(t))})),1===s.length?s[0]:Zt.create(s,e.op)}class Si{constructor(){this.rn=new xi}addToCollectionParentIndex(e,t){return this.rn.add(t),ae.resolve()}getCollectionParents(e,t){return ae.resolve(this.rn.getEntries(t))}addFieldIndex(e,t){return ae.resolve()}deleteFieldIndex(e,t){return ae.resolve()}getDocumentsMatchingTarget(e,t){return ae.resolve(null)}getIndexType(e,t){return ae.resolve(0)}getFieldIndexes(e,t){return ae.resolve([])}getNextCollectionGroupToUpdate(e){return ae.resolve(null)}getMinOffset(e,t){return ae.resolve(ne.min())}getMinOffsetFromCollectionGroup(e,t){return ae.resolve(ne.min())}updateCollectionGroup(e,t,n){return ae.resolve()}updateIndexEntries(e,t){return ae.resolve()}}class xi{constructor(){this.index={}}add(e){const t=e.lastSegment(),n=e.popLast(),s=this.index[t]||new it(j.comparator),i=!s.has(n);return this.index[t]=s.add(n),i}has(e){const t=e.lastSegment(),n=e.popLast(),s=this.index[t];return s&&s.has(n)}getEntries(e){return(this.index[e]||new it(j.comparator)).toArray()}}const _i=new Uint8Array(0);class Di{constructor(e,t){this.user=e,this.databaseId=t,this.on=new xi,this.un=new Gn((e=>vn(e)),((e,t)=>In(e,t))),this.uid=e.uid||""}addToCollectionParentIndex(e,t){if(!this.on.has(t)){const n=t.lastSegment(),s=t.popLast();e.addOnCommittedListener((()=>{this.on.add(t)}));const i={collectionId:n,parent:Te(s)};return Ni(e).put(i)}return ae.resolve()}getCollectionParents(e,t){const n=[],s=IDBKeyRange.bound([t,""],[G(t),""],!1,!0);return Ni(e).j(s).next((e=>{for(const s of e){if(s.collectionId!==t)break;n.push(_e(s.parent))}return n}))}addFieldIndex(e,t){const n=Ai(e),s=function(e){return{indexId:e.indexId,collectionGroup:e.collectionGroup,fields:e.fields.map((e=>[e.fieldPath.canonicalString(),e.kind]))}}(t);delete s.indexId;const i=n.add(s);if(t.indexState){const n=ki(e);return i.next((e=>{n.put(Js(e,this.user,t.indexState.sequenceNumber,t.indexState.offset))}))}return i.next()}deleteFieldIndex(e,t){const n=Ai(e),s=ki(e),i=Ci(e);return n.delete(t.indexId).next((()=>s.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0)))).next((()=>i.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0))))}getDocumentsMatchingTarget(e,t){const n=Ci(e);let s=!0;const i=new Map;return ae.forEach(this.cn(t),(t=>this.an(e,t).next((e=>{s&&(s=!!e),i.set(t,e)})))).next((()=>{if(s){let e=er();const s=[];return ae.forEach(i,((i,r)=>{var o;v("IndexedDbIndexManager",`Using index ${o=i,`id=${o.indexId}|cg=${o.collectionGroup}|f=${o.fields.map((e=>`${e.fieldPath}:${e.kind}`)).join(",")}`} to execute ${vn(t)}`);const u=function(e,t){const n=X(t);if(void 0===n)return null;for(const t of En(e,n.fieldPath))switch(t.op){case"array-contains-any":return t.value.arrayValue.values||[];case"array-contains":return[t.value]}return null}(r,i),c=function(e,t){const n=new Map;for(const s of dt(t))for(const t of En(e,s.fieldPath))switch(t.op){case"==":case"in":n.set(s.fieldPath.canonicalString(),t.value);break;case"not-in":case"!=":return n.set(s.fieldPath.canonicalString(),t.value),Array.from(n.values())}return null}(r,i),a=function(e,t){const n=[];let s=!0;for(const i of dt(t)){const t=0===i.kind?Tn(e,i.fieldPath,e.startAt):Sn(e,i.fieldPath,e.startAt);n.push(t.value),s&&(s=t.inclusive)}return new jt(n,s)}(r,i),l=function(e,t){const n=[];let s=!0;for(const i of dt(t)){const t=0===i.kind?Sn(e,i.fieldPath,e.endAt):Tn(e,i.fieldPath,e.endAt);n.push(t.value),s&&(s=t.inclusive)}return new jt(n,s)}(r,i),h=this.hn(i,r,a),d=this.hn(i,r,l),f=this.ln(i,r,c),m=this.fn(i.indexId,u,h,a.inclusive,d,l.inclusive,f);return ae.forEach(m,(i=>n.H(i,t.limit).next((t=>{t.forEach((t=>{const n=H.fromSegments(t.documentKey);e.has(n)||(e=e.add(n),s.push(n))}))}))))})).next((()=>s))}return ae.resolve(null)}))}cn(e){let t=this.un.get(e);return t||(t=0===e.filters.length?[e]:pi(Zt.create(e.filters,"and")).map((t=>wn(e.path,e.collectionGroup,e.orderBy,t.getFilters(),e.limit,e.startAt,e.endAt))),this.un.set(e,t),t)}fn(e,t,n,s,i,r,o){const u=(null!=t?t.length:1)*Math.max(n.length,i.length),c=u/(null!=t?t.length:1),a=[];for(let l=0;l<u;++l){const u=t?this.dn(t[l/c]):_i,h=this.wn(e,u,n[l%c],s),d=this._n(e,u,i[l%c],r),f=o.map((t=>this.wn(e,u,t,!0)));a.push(...this.createRange(h,d,f))}return a}wn(e,t,n,s){const i=new hi(e,H.empty(),t,n);return s?i:i.Je()}_n(e,t,n,s){const i=new hi(e,H.empty(),t,n);return s?i.Je():i}an(e,t){const n=new mi(t),s=null!=t.collectionGroup?t.collectionGroup:t.path.lastSegment();return this.getFieldIndexes(e,s).next((e=>{let t=null;for(const s of e)n.tn(s)&&(!t||s.fields.length>t.fields.length)&&(t=s);return t}))}getIndexType(e,t){let n=2;const s=this.cn(t);return ae.forEach(s,(t=>this.an(e,t).next((e=>{e?0!==n&&e.fields.length<function(e){let t=new it(W.comparator),n=!1;for(const s of e.filters)for(const e of s.getFlattenedFilters())e.field.isKeyField()||("array-contains"===e.op||"array-contains-any"===e.op?n=!0:t=t.add(e.field));for(const n of e.orderBy)n.field.isKeyField()||(t=t.add(n.field));return t.size+(n?1:0)}(t)&&(n=1):n=0})))).next((()=>function(e){return null!==e.limit}(t)&&s.length>1&&2===n?1:n))}mn(e,t){const n=new ui;for(const s of dt(e)){const e=t.data.field(s.fieldPath);if(null==e)return null;const i=n.He(s.kind);br.Ve._e(e,i)}return n.Qe()}dn(e){const t=new ui;return br.Ve._e(e,t.He(0)),t.Qe()}gn(e,t){const n=new ui;return br.Ve._e(kt(this.databaseId,t),n.He(function(e){const t=dt(e);return 0===t.length?0:t[t.length-1].kind}(e))),n.Qe()}ln(e,t,n){if(null===n)return[];let s=[];s.push(new ui);let i=0;for(const r of dt(e)){const e=n[i++];for(const n of s)if(this.yn(t,r.fieldPath)&&Ft(e))s=this.pn(s,r,e);else{const t=n.He(r.kind);br.Ve._e(e,t)}}return this.In(s)}hn(e,t,n){return this.ln(e,t,n.position)}In(e){const t=[];for(let n=0;n<e.length;++n)t[n]=e[n].Qe();return t}pn(e,t,n){const s=[...e],i=[];for(const e of n.arrayValue.values||[])for(const n of s){const s=new ui;s.seed(n.Qe()),br.Ve._e(e,s.He(t.kind)),i.push(s)}return i}yn(e,t){return!!e.filters.find((e=>e instanceof Jt&&e.field.isEqual(t)&&("in"===e.op||"not-in"===e.op)))}getFieldIndexes(e,t){const n=Ai(e),s=ki(e);return(t?n.j("collectionGroupIndex",IDBKeyRange.bound(t,t)):n.j()).next((e=>{const t=[];return ae.forEach(e,(e=>s.get([e.indexId,this.uid]).next((n=>{t.push(function(e,t){const n=t?new Z(t.sequenceNumber,new ne($s(t.readTime),new H(_e(t.documentKey)),t.largestBatchId)):Z.empty(),s=e.fields.map((([e,t])=>new J(W.fromServerFormat(e),t)));return new Y(e.indexId,e.collectionGroup,s,n)}(e,n))})))).next((()=>t))}))}getNextCollectionGroupToUpdate(e){return this.getFieldIndexes(e).next((e=>0===e.length?null:(e.sort(((e,t)=>{const n=e.indexState.sequenceNumber-t.indexState.sequenceNumber;return 0!==n?n:B(e.collectionGroup,t.collectionGroup)})),e[0].collectionGroup)))}updateCollectionGroup(e,t,n){const s=Ai(e),i=ki(e);return this.Tn(e).next((e=>s.j("collectionGroupIndex",IDBKeyRange.bound(t,t)).next((t=>ae.forEach(t,(t=>i.put(Js(t.indexId,this.user,e,n))))))))}updateIndexEntries(e,t){const n=new Map;return ae.forEach(t,((t,s)=>{const i=n.get(t.collectionGroup);return(i?ae.resolve(i):this.getFieldIndexes(e,t.collectionGroup)).next((i=>(n.set(t.collectionGroup,i),ae.forEach(i,(n=>this.En(e,t,n).next((t=>{const i=this.An(s,n);return t.isEqual(i)?ae.resolve():this.vn(e,s,n,t,i)})))))))}))}Rn(e,t,n,s){return Ci(e).put({indexId:s.indexId,uid:this.uid,arrayValue:s.arrayValue,directionalValue:s.directionalValue,orderedDocumentKey:this.gn(n,t.key),documentKey:t.key.path.toArray()})}Pn(e,t,n,s){return Ci(e).delete([s.indexId,this.uid,s.arrayValue,s.directionalValue,this.gn(n,t.key),t.key.path.toArray()])}En(e,t,n){const s=Ci(e);let i=new it(di);return s.X({index:"documentKeyIndex",range:IDBKeyRange.only([n.indexId,this.uid,this.gn(n,t)])},((e,s)=>{i=i.add(new hi(n.indexId,t,s.arrayValue,s.directionalValue))})).next((()=>i))}An(e,t){let n=new it(di);const s=this.mn(t,e);if(null==s)return n;const i=X(t);if(null!=i){const r=e.data.field(i.fieldPath);if(Ft(r))for(const i of r.arrayValue.values||[])n=n.add(new hi(t.indexId,e.key,this.dn(i),s))}else n=n.add(new hi(t.indexId,e.key,_i,s));return n}vn(e,t,n,s,i){v("IndexedDbIndexManager","Updating index entries for document '%s'",t.key);const r=[];return function(e,t,n,s,i){const r=e.getIterator(),o=t.getIterator();let u=at(r),c=at(o);for(;u||c;){let e=!1,t=!1;if(u&&c){const s=n(u,c);s<0?t=!0:s>0&&(e=!0)}else null!=u?t=!0:e=!0;e?(s(c),c=at(o)):t?(i(u),u=at(r)):(u=at(r),c=at(o))}}(s,i,di,(s=>{r.push(this.Rn(e,t,n,s))}),(s=>{r.push(this.Pn(e,t,n,s))})),ae.waitFor(r)}Tn(e){let t=1;return ki(e).X({index:"sequenceNumberIndex",reverse:!0,range:IDBKeyRange.upperBound([this.uid,Number.MAX_SAFE_INTEGER])},((e,n,s)=>{s.done(),t=n.sequenceNumber+1})).next((()=>t))}createRange(e,t,n){n=n.sort(((e,t)=>di(e,t))).filter(((e,t,n)=>!t||0!==di(e,n[t-1])));const s=[];s.push(e);for(const i of n){const n=di(i,e),r=di(i,t);if(0===n)s[0]=e.Je();else if(n>0&&r<0)s.push(i),s.push(i.Je());else if(r>0)break}s.push(t);const i=[];for(let e=0;e<s.length;e+=2){if(this.bn(s[e],s[e+1]))return[];const t=[s[e].indexId,this.uid,s[e].arrayValue,s[e].directionalValue,_i,[]],n=[s[e+1].indexId,this.uid,s[e+1].arrayValue,s[e+1].directionalValue,_i,[]];i.push(IDBKeyRange.bound(t,n))}return i}bn(e,t){return di(e,t)>0}getMinOffsetFromCollectionGroup(e,t){return this.getFieldIndexes(e,t).next(Ri)}getMinOffset(e,t){return ae.mapArray(this.cn(t),(t=>this.an(e,t).next((e=>e||S())))).next(Ri)}}function Ni(e){return Xe(e,"collectionParents")}function Ci(e){return Xe(e,"indexEntries")}function Ai(e){return Xe(e,"indexConfiguration")}function ki(e){return Xe(e,"indexState")}function Ri(e){x(0!==e.length);let t=e[0].indexState.offset,n=t.largestBatchId;for(let s=1;s<e.length;s++){const i=e[s].indexState.offset;re(i,t)<0&&(t=i),n<i.largestBatchId&&(n=i.largestBatchId)}return new ne(t.readTime,t.documentKey,n)}const Fi={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0};class Vi{constructor(e,t,n){this.cacheSizeCollectionThreshold=e,this.percentileToCollect=t,this.maximumSequenceNumbersToCollect=n}static withCacheSize(e){return new Vi(e,Vi.DEFAULT_COLLECTION_PERCENTILE,Vi.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}}function Oi(e,t,n){const s=e.store("mutations"),i=e.store("documentMutations"),r=[],o=IDBKeyRange.only(n.batchId);let u=0;const c=s.X({range:o},((e,t,n)=>(u++,n.delete())));r.push(c.next((()=>{x(1===u)})));const a=[];for(const e of n.mutations){const s=Ce(t,e.key.path,n.batchId);r.push(i.delete(s)),a.push(e.key)}return ae.waitFor(r).next((()=>a))}function Mi(e){if(!e)return 0;let t;if(e.document)t=e.document;else if(e.unknownDocument)t=e.unknownDocument;else{if(!e.noDocument)throw S();t=e.noDocument}return JSON.stringify(t).length}Vi.DEFAULT_COLLECTION_PERCENTILE=10,Vi.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,Vi.DEFAULT=new Vi(41943040,Vi.DEFAULT_COLLECTION_PERCENTILE,Vi.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),Vi.DISABLED=new Vi(-1,0,0);class Li{constructor(e,t,n,s){this.userId=e,this.serializer=t,this.indexManager=n,this.referenceDelegate=s,this.Vn={}}static de(e,t,n,s){x(""!==e.uid);const i=e.isAuthenticated()?e.uid:"";return new Li(i,t,n,s)}checkEmpty(e){let t=!0;const n=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return qi(e).X({index:"userMutationsIndex",range:n},((e,n,s)=>{t=!1,s.done()})).next((()=>t))}addMutationBatch(e,t,n,s){const i=Ui(e),r=qi(e);return r.add({}).next((o=>{x("number"==typeof o);const u=new Pr(o,t,n,s),c=function(e,t,n){const s=n.baseMutations.map((t=>Ds(e.fe,t))),i=n.mutations.map((t=>Ds(e.fe,t)));return{userId:t,batchId:n.batchId,localWriteTimeMs:n.localWriteTime.toMillis(),baseMutations:s,mutations:i}}(this.serializer,this.userId,u),a=[];let l=new it(((e,t)=>B(e.canonicalString(),t.canonicalString())));for(const e of s){const t=Ce(this.userId,e.key.path,o);l=l.add(e.key.path.popLast()),a.push(r.put(c)),a.push(i.put(t,Ae))}return l.forEach((t=>{a.push(this.indexManager.addToCollectionParentIndex(e,t))})),e.addOnCommittedListener((()=>{this.Vn[o]=u.keys()})),ae.waitFor(a).next((()=>u))}))}lookupMutationBatch(e,t){return qi(e).get(t).next((e=>e?(x(e.userId===this.userId),js(this.serializer,e)):null))}Sn(e,t){return this.Vn[t]?ae.resolve(this.Vn[t]):this.lookupMutationBatch(e,t).next((e=>{if(e){const n=e.keys();return this.Vn[t]=n,n}return null}))}getNextMutationBatchAfterBatchId(e,t){const n=t+1,s=IDBKeyRange.lowerBound([this.userId,n]);let i=null;return qi(e).X({index:"userMutationsIndex",range:s},((e,t,s)=>{t.userId===this.userId&&(x(t.batchId>=n),i=js(this.serializer,t)),s.done()})).next((()=>i))}getHighestUnacknowledgedBatchId(e){const t=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]);let n=-1;return qi(e).X({index:"userMutationsIndex",range:t,reverse:!0},((e,t,s)=>{n=t.batchId,s.done()})).next((()=>n))}getAllMutationBatches(e){const t=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return qi(e).j("userMutationsIndex",t).next((e=>e.map((e=>js(this.serializer,e)))))}getAllMutationBatchesAffectingDocumentKey(e,t){const n=Ne(this.userId,t.path),s=IDBKeyRange.lowerBound(n),i=[];return Ui(e).X({range:s},((n,s,r)=>{const[o,u,c]=n,a=_e(u);if(o===this.userId&&t.path.isEqual(a))return qi(e).get(c).next((e=>{if(!e)throw S();x(e.userId===this.userId),i.push(js(this.serializer,e))}));r.done()})).next((()=>i))}getAllMutationBatchesAffectingDocumentKeys(e,t){let n=new it(B);const s=[];return t.forEach((t=>{const i=Ne(this.userId,t.path),r=IDBKeyRange.lowerBound(i),o=Ui(e).X({range:r},((e,s,i)=>{const[r,o,u]=e,c=_e(o);r===this.userId&&t.path.isEqual(c)?n=n.add(u):i.done()}));s.push(o)})),ae.waitFor(s).next((()=>this.Dn(e,n)))}getAllMutationBatchesAffectingQuery(e,t){const n=t.path,s=n.length+1,i=Ne(this.userId,n),r=IDBKeyRange.lowerBound(i);let o=new it(B);return Ui(e).X({range:r},((e,t,i)=>{const[r,u,c]=e,a=_e(u);r===this.userId&&n.isPrefixOf(a)?a.length===s&&(o=o.add(c)):i.done()})).next((()=>this.Dn(e,o)))}Dn(e,t){const n=[],s=[];return t.forEach((t=>{s.push(qi(e).get(t).next((e=>{if(null===e)throw S();x(e.userId===this.userId),n.push(js(this.serializer,e))})))})),ae.waitFor(s).next((()=>n))}removeMutationBatch(e,t){return Oi(e.ht,this.userId,t).next((n=>(e.addOnCommittedListener((()=>{this.Cn(t.batchId)})),ae.forEach(n,(t=>this.referenceDelegate.markPotentiallyOrphaned(e,t))))))}Cn(e){delete this.Vn[e]}performConsistencyCheck(e){return this.checkEmpty(e).next((t=>{if(!t)return ae.resolve();const n=IDBKeyRange.lowerBound([this.userId]),s=[];return Ui(e).X({range:n},((e,t,n)=>{if(e[0]===this.userId){const t=_e(e[1]);s.push(t)}else n.done()})).next((()=>{x(0===s.length)}))}))}containsKey(e,t){return Pi(e,this.userId,t)}xn(e){return Bi(e).get(this.userId).next((e=>e||{userId:this.userId,lastAcknowledgedBatchId:-1,lastStreamToken:""}))}}function Pi(e,t,n){const s=Ne(t,n.path),i=s[1],r=IDBKeyRange.lowerBound(s);let o=!1;return Ui(e).X({range:r,Y:!0},((e,n,s)=>{const[r,u,c]=e;r===t&&u===i&&(o=!0),s.done()})).next((()=>o))}function qi(e){return Xe(e,"mutations")}function Ui(e){return Xe(e,"documentMutations")}function Bi(e){return Xe(e,"mutationQueues")}class zi{constructor(e){this.Nn=e}next(){return this.Nn+=2,this.Nn}static kn(){return new zi(0)}static Mn(){return new zi(-1)}}class Gi{constructor(e,t){this.referenceDelegate=e,this.serializer=t}allocateTargetId(e){return this.$n(e).next((t=>{const n=new zi(t.highestTargetId);return t.highestTargetId=n.next(),this.On(e,t).next((()=>t.highestTargetId))}))}getLastRemoteSnapshotVersion(e){return this.$n(e).next((e=>rt.fromTimestamp(new K(e.lastRemoteSnapshotVersion.seconds,e.lastRemoteSnapshotVersion.nanoseconds))))}getHighestSequenceNumber(e){return this.$n(e).next((e=>e.highestListenSequenceNumber))}setTargetsMetadata(e,t,n){return this.$n(e).next((s=>(s.highestListenSequenceNumber=t,n&&(s.lastRemoteSnapshotVersion=n.toTimestamp()),t>s.highestListenSequenceNumber&&(s.highestListenSequenceNumber=t),this.On(e,s))))}addTargetData(e,t){return this.Fn(e,t).next((()=>this.$n(e).next((n=>(n.targetCount+=1,this.Bn(t,n),this.On(e,n))))))}updateTargetData(e,t){return this.Fn(e,t)}removeTargetData(e,t){return this.removeMatchingKeysForTargetId(e,t.targetId).next((()=>Ki(e).delete(t.targetId))).next((()=>this.$n(e))).next((t=>(x(t.targetCount>0),t.targetCount-=1,this.On(e,t))))}removeTargets(e,t,n){let s=0;const i=[];return Ki(e).X(((r,o)=>{const u=Qs(o);u.sequenceNumber<=t&&null===n.get(u.targetId)&&(s++,i.push(this.removeTargetData(e,u)))})).next((()=>ae.waitFor(i))).next((()=>s))}forEachTarget(e,t){return Ki(e).X(((e,n)=>{const s=Qs(n);t(s)}))}$n(e){return $i(e).get("targetGlobalKey").next((e=>(x(null!==e),e)))}On(e,t){return $i(e).put("targetGlobalKey",t)}Fn(e,t){return Ki(e).put(Ws(this.serializer,t))}Bn(e,t){let n=!1;return e.targetId>t.highestTargetId&&(t.highestTargetId=e.targetId,n=!0),e.sequenceNumber>t.highestListenSequenceNumber&&(t.highestListenSequenceNumber=e.sequenceNumber,n=!0),n}getTargetCount(e){return this.$n(e).next((e=>e.targetCount))}getTargetData(e,t){const n=vn(t),s=IDBKeyRange.bound([n,Number.NEGATIVE_INFINITY],[n,Number.POSITIVE_INFINITY]);let i=null;return Ki(e).X({range:s,index:"queryTargetsIndex"},((e,n,s)=>{const r=Qs(n);In(t,r.target)&&(i=r,s.done())})).next((()=>i))}addMatchingKeys(e,t,n){const s=[],i=ji(e);return t.forEach((t=>{const r=Te(t.path);s.push(i.put({targetId:n,path:r})),s.push(this.referenceDelegate.addReference(e,n,t))})),ae.waitFor(s)}removeMatchingKeys(e,t,n){const s=ji(e);return ae.forEach(t,(t=>{const i=Te(t.path);return ae.waitFor([s.delete([n,i]),this.referenceDelegate.removeReference(e,n,t)])}))}removeMatchingKeysForTargetId(e,t){const n=ji(e),s=IDBKeyRange.bound([t],[t+1],!1,!0);return n.delete(s)}getMatchingKeysForTargetId(e,t){const n=IDBKeyRange.bound([t],[t+1],!1,!0),s=ji(e);let i=er();return s.X({range:n,Y:!0},((e,t,n)=>{const s=_e(e[1]),r=new H(s);i=i.add(r)})).next((()=>i))}containsKey(e,t){const n=Te(t.path),s=IDBKeyRange.bound([n],[G(n)],!1,!0);let i=0;return ji(e).X({index:"documentTargetsIndex",Y:!0,range:s},(([e,t],n,s)=>{0!==e&&(i++,s.done())})).next((()=>i>0))}le(e,t){return Ki(e).get(t).next((e=>e?Qs(e):null))}}function Ki(e){return Xe(e,"targets")}function $i(e){return Xe(e,"targetGlobal")}function ji(e){return Xe(e,"targetDocuments")}function Qi([e,t],[n,s]){const i=B(e,n);return 0===i?B(t,s):i}class Wi{constructor(e){this.Ln=e,this.buffer=new it(Qi),this.qn=0}Un(){return++this.qn}Kn(e){const t=[e,this.Un()];if(this.buffer.size<this.Ln)this.buffer=this.buffer.add(t);else{const e=this.buffer.last();Qi(t,e)<0&&(this.buffer=this.buffer.delete(e).add(t))}}get maxValue(){return this.buffer.last()[0]}}class Hi{constructor(e,t,n){this.garbageCollector=e,this.asyncQueue=t,this.localStore=n,this.Gn=null}start(){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this.Qn(6e4)}stop(){this.Gn&&(this.Gn.cancel(),this.Gn=null)}get started(){return null!==this.Gn}Qn(e){v("LruGarbageCollector",`Garbage collection scheduled in ${e}ms`),this.Gn=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",e,(async()=>{this.Gn=null;try{await this.localStore.collectGarbage(this.garbageCollector)}catch(e){de(e)?v("LruGarbageCollector","Ignoring IndexedDB error during garbage collection: ",e):await oe(e)}await this.Qn(3e5)}))}}class Yi{constructor(e,t){this.jn=e,this.params=t}calculateTargetCount(e,t){return this.jn.zn(e).next((e=>Math.floor(t/100*e)))}nthSequenceNumber(e,t){if(0===t)return ae.resolve(ve.ct);const n=new Wi(t);return this.jn.forEachTarget(e,(e=>n.Kn(e.sequenceNumber))).next((()=>this.jn.Wn(e,(e=>n.Kn(e))))).next((()=>n.maxValue))}removeTargets(e,t,n){return this.jn.removeTargets(e,t,n)}removeOrphanedDocuments(e,t){return this.jn.removeOrphanedDocuments(e,t)}collect(e,t){return-1===this.params.cacheSizeCollectionThreshold?(v("LruGarbageCollector","Garbage collection skipped; disabled"),ae.resolve(Fi)):this.getCacheSize(e).next((n=>n<this.params.cacheSizeCollectionThreshold?(v("LruGarbageCollector",`Garbage collection skipped; Cache size ${n} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),Fi):this.Hn(e,t)))}getCacheSize(e){return this.jn.getCacheSize(e)}Hn(e,t){let n,s,i,r,o,l,a;const h=Date.now();return this.calculateTargetCount(e,this.params.percentileToCollect).next((t=>(t>this.params.maximumSequenceNumbersToCollect?(v("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${t}`),s=this.params.maximumSequenceNumbersToCollect):s=t,r=Date.now(),this.nthSequenceNumber(e,s)))).next((s=>(n=s,o=Date.now(),this.removeTargets(e,n,t)))).next((t=>(i=t,l=Date.now(),this.removeOrphanedDocuments(e,n)))).next((e=>(a=Date.now(),y()<=c.a.DEBUG&&v("LruGarbageCollector",`LRU Garbage Collection\n\tCounted targets in ${r-h}ms\n\tDetermined least recently used ${s} in `+(o-r)+"ms\n"+`\tRemoved ${i} targets in `+(l-o)+"ms\n"+`\tRemoved ${e} documents in `+(a-l)+"ms\n"+`Total Duration: ${a-h}ms`),ae.resolve({didRun:!0,sequenceNumbersCollected:s,targetsRemoved:i,documentsRemoved:e}))))}}function Xi(e,t){return new Yi(e,t)}class Ji{constructor(e,t){this.db=e,this.garbageCollector=Xi(this,t)}zn(e){const t=this.Jn(e);return this.db.getTargetCache().getTargetCount(e).next((e=>t.next((t=>e+t))))}Jn(e){let t=0;return this.Wn(e,(e=>{t++})).next((()=>t))}forEachTarget(e,t){return this.db.getTargetCache().forEachTarget(e,t)}Wn(e,t){return this.Yn(e,((e,n)=>t(n)))}addReference(e,t,n){return Zi(e,n)}removeReference(e,t,n){return Zi(e,n)}removeTargets(e,t,n){return this.db.getTargetCache().removeTargets(e,t,n)}markPotentiallyOrphaned(e,t){return Zi(e,t)}Xn(e,t){return function(e,t){let n=!1;return Bi(e).Z((s=>Pi(e,s,t).next((e=>(e&&(n=!0),ae.resolve(!e)))))).next((()=>n))}(e,t)}removeOrphanedDocuments(e,t){const n=this.db.getRemoteDocumentCache().newChangeBuffer(),s=[];let i=0;return this.Yn(e,((r,o)=>{if(o<=t){const t=this.Xn(e,r).next((t=>{if(!t)return i++,n.getEntry(e,r).next((()=>(n.removeEntry(r,rt.min()),ji(e).delete([0,Te(r.path)]))))}));s.push(t)}})).next((()=>ae.waitFor(s))).next((()=>n.apply(e))).next((()=>i))}removeTarget(e,t){const n=t.withSequenceNumber(e.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(e,n)}updateLimboDocument(e,t){return Zi(e,t)}Yn(e,t){const n=ji(e);let s,i=ve.ct;return n.X({index:"documentTargetsIndex"},(([e,n],{path:r,sequenceNumber:o})=>{0===e?(i!==ve.ct&&t(new H(_e(s)),i),i=o,s=r):i=ve.ct})).next((()=>{i!==ve.ct&&t(new H(_e(s)),i)}))}getCacheSize(e){return this.db.getRemoteDocumentCache().getSize(e)}}function Zi(e,t){return ji(e).put(function(e,t){return{targetId:0,path:Te(e.path),sequenceNumber:t}}(t,e.currentSequenceNumber))}class eo{constructor(){this.changes=new Gn((e=>e.toString()),((e,t)=>e.isEqual(t))),this.changesApplied=!1}addEntry(e){this.assertNotApplied(),this.changes.set(e.key,e)}removeEntry(e,t){this.assertNotApplied(),this.changes.set(e,$t.newInvalidDocument(e).setReadTime(t))}getEntry(e,t){this.assertNotApplied();const n=this.changes.get(t);return void 0!==n?ae.resolve(n):this.getFromCache(e,t)}getEntries(e,t){return this.getAllFromCache(e,t)}apply(e){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(e)}assertNotApplied(){}}class to{constructor(e){this.serializer=e}setIndexManager(e){this.indexManager=e}addEntry(e,t,n){return io(e).put(n)}removeEntry(e,t,n){return io(e).delete(function(e,t){const n=e.path.toArray();return[n.slice(0,n.length-2),n[n.length-2],Gs(t),n[n.length-1]]}(t,n))}updateMetadata(e,t){return this.getMetadata(e).next((n=>(n.byteSize+=t,this.Zn(e,n))))}getEntry(e,t){let n=$t.newInvalidDocument(t);return io(e).X({index:"documentKeyIndex",range:IDBKeyRange.only(oo(t))},((e,s)=>{n=this.ts(t,s)})).next((()=>n))}es(e,t){let n={size:0,document:$t.newInvalidDocument(t)};return io(e).X({index:"documentKeyIndex",range:IDBKeyRange.only(oo(t))},((e,s)=>{n={document:this.ts(t,s),size:Mi(s)}})).next((()=>n))}getEntries(e,t){let n=$n();return this.ns(e,t,((e,t)=>{const s=this.ts(e,t);n=n.insert(e,s)})).next((()=>n))}ss(e,t){let n=$n(),s=new tt(H.comparator);return this.ns(e,t,((e,t)=>{const i=this.ts(e,t);n=n.insert(e,i),s=s.insert(e,Mi(t))})).next((()=>({documents:n,rs:s})))}ns(e,t,n){if(t.isEmpty())return ae.resolve();let s=new it(co);t.forEach((e=>s=s.add(e)));const i=IDBKeyRange.bound(oo(s.first()),oo(s.last())),r=s.getIterator();let o=r.getNext();return io(e).X({index:"documentKeyIndex",range:i},((e,t,s)=>{const i=H.fromSegments([...t.prefixPath,t.collectionGroup,t.documentId]);for(;o&&co(o,i)<0;)n(o,null),o=r.getNext();o&&o.isEqual(i)&&(n(o,t),o=r.hasNext()?r.getNext():null),o?s.G(oo(o)):s.done()})).next((()=>{for(;o;)n(o,null),o=r.hasNext()?r.getNext():null}))}getDocumentsMatchingQuery(e,t,n,s){const i=t.path,r=[i.popLast().toArray(),i.lastSegment(),Gs(n.readTime),n.documentKey.path.isEmpty()?"":n.documentKey.path.lastSegment()],o=[i.popLast().toArray(),i.lastSegment(),[Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],""];return io(e).j(IDBKeyRange.bound(r,o,!0)).next((e=>{let n=$n();for(const i of e){const e=this.ts(H.fromSegments(i.prefixPath.concat(i.collectionGroup,i.documentId)),i);e.isFoundDocument()&&(qn(t,e)||s.has(e.key))&&(n=n.insert(e.key,e))}return n}))}getAllFromCollectionGroup(e,t,n,s){let i=$n();const r=ao(t,n),o=ao(t,ne.max());return io(e).X({index:"collectionGroupIndex",range:IDBKeyRange.bound(r,o,!0)},((e,t,n)=>{const r=this.ts(H.fromSegments(t.prefixPath.concat(t.collectionGroup,t.documentId)),t);i=i.insert(r.key,r),i.size===s&&n.done()})).next((()=>i))}newChangeBuffer(e){return new ro(this,!!e&&e.trackRemovals)}getSize(e){return this.getMetadata(e).next((e=>e.byteSize))}getMetadata(e){return so(e).get("remoteDocumentGlobalKey").next((e=>(x(!!e),e)))}Zn(e,t){return so(e).put("remoteDocumentGlobalKey",t)}ts(e,t){if(t){const e=function(e,t){let n;if(t.document)n=_s(e.fe,t.document,!!t.hasCommittedMutations);else if(t.noDocument){const e=H.fromSegments(t.noDocument.path),s=$s(t.noDocument.readTime);n=$t.newNoDocument(e,s),t.hasCommittedMutations&&n.setHasCommittedMutations()}else{if(!t.unknownDocument)return S();{const e=H.fromSegments(t.unknownDocument.path),s=$s(t.unknownDocument.version);n=$t.newUnknownDocument(e,s)}}return t.readTime&&n.setReadTime(function(e){const t=new K(e[0],e[1]);return rt.fromTimestamp(t)}(t.readTime)),n}(this.serializer,t);if(!e.isNoDocument()||!e.version.isEqual(rt.min()))return e}return $t.newInvalidDocument(e)}}function no(e){return new to(e)}class ro extends eo{constructor(e,t){super(),this.os=e,this.trackRemovals=t,this.us=new Gn((e=>e.toString()),((e,t)=>e.isEqual(t)))}applyChanges(e){const t=[];let n=0,s=new it(((e,t)=>B(e.canonicalString(),t.canonicalString())));return this.changes.forEach(((i,r)=>{const o=this.us.get(i);if(t.push(this.os.removeEntry(e,i,o.readTime)),r.isValidDocument()){const u=zs(this.os.serializer,r);s=s.add(i.path.popLast());const c=Mi(u);n+=c-o.size,t.push(this.os.addEntry(e,i,u))}else if(n-=o.size,this.trackRemovals){const n=zs(this.os.serializer,r.convertToNoDocument(rt.min()));t.push(this.os.addEntry(e,i,n))}})),s.forEach((n=>{t.push(this.os.indexManager.addToCollectionParentIndex(e,n))})),t.push(this.os.updateMetadata(e,n)),ae.waitFor(t)}getFromCache(e,t){return this.os.es(e,t).next((e=>(this.us.set(t,{size:e.size,readTime:e.document.readTime}),e.document)))}getAllFromCache(e,t){return this.os.ss(e,t).next((({documents:e,rs:t})=>(t.forEach(((t,n)=>{this.us.set(t,{size:n,readTime:e.get(t).readTime})})),e)))}}function so(e){return Xe(e,"remoteDocumentGlobal")}function io(e){return Xe(e,"remoteDocumentsV14")}function oo(e){const t=e.path.toArray();return[t.slice(0,t.length-2),t[t.length-2],t[t.length-1]]}function ao(e,t){const n=t.documentKey.path.toArray();return[e,Gs(t.readTime),n.slice(0,n.length-2),n.length>0?n[n.length-1]:""]}function co(e,t){const n=e.path.toArray(),s=t.path.toArray();let i=0;for(let e=0;e<n.length-2&&e<s.length-2;++e)if(i=B(n[e],s[e]),i)return i;return i=B(n.length,s.length),i||(i=B(n[n.length-2],s[s.length-2]),i||B(n[n.length-1],s[s.length-1]))}class uo{constructor(e,t){this.overlayedDocument=e,this.mutatedFields=t}}class lo{constructor(e,t,n,s){this.remoteDocumentCache=e,this.mutationQueue=t,this.documentOverlayCache=n,this.indexManager=s}getDocument(e,t){let n=null;return this.documentOverlayCache.getOverlay(e,t).next((s=>(n=s,this.remoteDocumentCache.getEntry(e,t)))).next((e=>(null!==n&&Nr(n.mutation,e,ct.empty(),K.now()),e)))}getDocuments(e,t){return this.remoteDocumentCache.getEntries(e,t).next((t=>this.getLocalViewOfDocuments(e,t,er()).next((()=>t))))}getLocalViewOfDocuments(e,t,n=er()){const s=Hn();return this.populateOverlays(e,s,t).next((()=>this.computeViews(e,t,s,n).next((e=>{let t=Qn();return e.forEach(((e,n)=>{t=t.insert(e,n.overlayedDocument)})),t}))))}getOverlayedDocuments(e,t){const n=Hn();return this.populateOverlays(e,n,t).next((()=>this.computeViews(e,t,n,er())))}populateOverlays(e,t,n){const s=[];return n.forEach((e=>{t.has(e)||s.push(e)})),this.documentOverlayCache.getOverlays(e,s).next((e=>{e.forEach(((e,n)=>{t.set(e,n)}))}))}computeViews(e,t,n,s){let i=$n();const r=Xn(),o=Xn();return t.forEach(((e,t)=>{const o=n.get(t.key);s.has(t.key)&&(void 0===o||o.mutation instanceof Rr)?i=i.insert(t.key,t):void 0!==o?(r.set(t.key,o.mutation.getFieldMask()),Nr(o.mutation,t,o.mutation.getFieldMask(),K.now())):r.set(t.key,ct.empty())})),this.recalculateAndSaveOverlays(e,i).next((e=>(e.forEach(((e,t)=>r.set(e,t))),t.forEach(((e,t)=>{var n;return o.set(e,new uo(t,null!==(n=r.get(e))&&void 0!==n?n:null))})),o)))}recalculateAndSaveOverlays(e,t){const n=Xn();let s=new tt(((e,t)=>e-t)),i=er();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(e,t).next((e=>{for(const i of e)i.keys().forEach((e=>{const r=t.get(e);if(null===r)return;let o=n.get(e)||ct.empty();o=i.applyToLocalView(r,o),n.set(e,o);const u=(s.get(i.batchId)||er()).add(e);s=s.insert(i.batchId,u)}))})).next((()=>{const r=[],o=s.getReverseIterator();for(;o.hasNext();){const s=o.getNext(),u=s.key,c=s.value,a=Yn();c.forEach((e=>{if(!i.has(e)){const s=_r(t.get(e),n.get(e));null!==s&&a.set(e,s),i=i.add(e)}})),r.push(this.documentOverlayCache.saveOverlays(e,u,a))}return ae.waitFor(r)})).next((()=>n))}recalculateAndSaveOverlaysForDocumentKeys(e,t){return this.remoteDocumentCache.getEntries(e,t).next((t=>this.recalculateAndSaveOverlays(e,t)))}getDocumentsMatchingQuery(e,t,n){return function(e){return H.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}(t)?this.getDocumentsMatchingDocumentQuery(e,t.path):kn(t)?this.getDocumentsMatchingCollectionGroupQuery(e,t,n):this.getDocumentsMatchingCollectionQuery(e,t,n)}getNextDocuments(e,t,n,s){return this.remoteDocumentCache.getAllFromCollectionGroup(e,t,n,s).next((i=>{const r=s-i.size>0?this.documentOverlayCache.getOverlaysForCollectionGroup(e,t,n.largestBatchId,s-i.size):ae.resolve(Hn());let o=-1,u=i;return r.next((t=>ae.forEach(t,((t,n)=>(o<n.largestBatchId&&(o=n.largestBatchId),i.get(t)?ae.resolve():this.remoteDocumentCache.getEntry(e,t).next((e=>{u=u.insert(t,e)}))))).next((()=>this.populateOverlays(e,t,i))).next((()=>this.computeViews(e,u,t,er()))).next((e=>({batchId:o,changes:Wn(e)})))))}))}getDocumentsMatchingDocumentQuery(e,t){return this.getDocument(e,new H(t)).next((e=>{let t=Qn();return e.isFoundDocument()&&(t=t.insert(e.key,e)),t}))}getDocumentsMatchingCollectionGroupQuery(e,t,n){const s=t.collectionGroup;let i=Qn();return this.indexManager.getCollectionParents(e,s).next((r=>ae.forEach(r,(r=>{const o=function(e,t){return new xn(t,null,e.explicitOrderBy.slice(),e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt)}(t,r.child(s));return this.getDocumentsMatchingCollectionQuery(e,o,n).next((e=>{e.forEach(((e,t)=>{i=i.insert(e,t)}))}))})).next((()=>i))))}getDocumentsMatchingCollectionQuery(e,t,n){let s;return this.documentOverlayCache.getOverlaysForCollection(e,t.path,n.largestBatchId).next((i=>(s=i,this.remoteDocumentCache.getDocumentsMatchingQuery(e,t,n,s)))).next((e=>{s.forEach(((t,n)=>{const s=n.getKey();null===e.get(s)&&(e=e.insert(s,$t.newInvalidDocument(s)))}));let n=Qn();return e.forEach(((e,i)=>{const r=s.get(e);void 0!==r&&Nr(r.mutation,i,ct.empty(),K.now()),qn(t,i)&&(n=n.insert(e,i))})),n}))}}class ho{constructor(e){this.serializer=e,this.cs=new Map,this.hs=new Map}getBundleMetadata(e,t){return ae.resolve(this.cs.get(t))}saveBundleMetadata(e,t){var n;return this.cs.set(t.id,{id:(n=t).id,version:n.version,createTime:ps(n.createTime)}),ae.resolve()}getNamedQuery(e,t){return ae.resolve(this.hs.get(t))}saveNamedQuery(e,t){return this.hs.set(t.name,function(e){return{name:e.name,query:Hs(e.bundledQuery),readTime:ps(e.readTime)}}(t)),ae.resolve()}}class fo{constructor(){this.overlays=new tt(H.comparator),this.ls=new Map}getOverlay(e,t){return ae.resolve(this.overlays.get(t))}getOverlays(e,t){const n=Hn();return ae.forEach(t,(t=>this.getOverlay(e,t).next((e=>{null!==e&&n.set(t,e)})))).next((()=>n))}saveOverlays(e,t,n){return n.forEach(((n,s)=>{this.we(e,t,s)})),ae.resolve()}removeOverlaysForBatchId(e,t,n){const s=this.ls.get(n);return void 0!==s&&(s.forEach((e=>this.overlays=this.overlays.remove(e))),this.ls.delete(n)),ae.resolve()}getOverlaysForCollection(e,t,n){const s=Hn(),i=t.length+1,r=new H(t.child("")),o=this.overlays.getIteratorFrom(r);for(;o.hasNext();){const e=o.getNext().value,r=e.getKey();if(!t.isPrefixOf(r.path))break;r.path.length===i&&e.largestBatchId>n&&s.set(e.getKey(),e)}return ae.resolve(s)}getOverlaysForCollectionGroup(e,t,n,s){let i=new tt(((e,t)=>e-t));const r=this.overlays.getIterator();for(;r.hasNext();){const e=r.getNext().value;if(e.getKey().getCollectionGroup()===t&&e.largestBatchId>n){let t=i.get(e.largestBatchId);null===t&&(t=Hn(),i=i.insert(e.largestBatchId,t)),t.set(e.getKey(),e)}}const o=Hn(),u=i.getIterator();for(;u.hasNext()&&(u.getNext().value.forEach(((e,t)=>o.set(e,t))),!(o.size()>=s)););return ae.resolve(o)}we(e,t,n){const s=this.overlays.get(n.key);if(null!==s){const e=this.ls.get(s.largestBatchId).delete(n.key);this.ls.set(s.largestBatchId,e)}this.overlays=this.overlays.insert(n.key,new Ur(t,n));let i=this.ls.get(t);void 0===i&&(i=er(),this.ls.set(t,i)),this.ls.set(t,i.add(n.key))}}class mo{constructor(){this.fs=new it(go.ds),this.ws=new it(go._s)}isEmpty(){return this.fs.isEmpty()}addReference(e,t){const n=new go(e,t);this.fs=this.fs.add(n),this.ws=this.ws.add(n)}gs(e,t){e.forEach((e=>this.addReference(e,t)))}removeReference(e,t){this.ys(new go(e,t))}ps(e,t){e.forEach((e=>this.removeReference(e,t)))}Is(e){const t=new H(new j([])),n=new go(t,e),s=new go(t,e+1),i=[];return this.ws.forEachInRange([n,s],(e=>{this.ys(e),i.push(e.key)})),i}Ts(){this.fs.forEach((e=>this.ys(e)))}ys(e){this.fs=this.fs.delete(e),this.ws=this.ws.delete(e)}Es(e){const t=new H(new j([])),n=new go(t,e),s=new go(t,e+1);let i=er();return this.ws.forEachInRange([n,s],(e=>{i=i.add(e.key)})),i}containsKey(e){const t=new go(e,0),n=this.fs.firstAfterOrEqual(t);return null!==n&&e.isEqual(n.key)}}class go{constructor(e,t){this.key=e,this.As=t}static ds(e,t){return H.comparator(e.key,t.key)||B(e.As,t.As)}static _s(e,t){return B(e.As,t.As)||H.comparator(e.key,t.key)}}class po{constructor(e,t){this.indexManager=e,this.referenceDelegate=t,this.mutationQueue=[],this.vs=1,this.Rs=new it(go.ds)}checkEmpty(e){return ae.resolve(0===this.mutationQueue.length)}addMutationBatch(e,t,n,s){const i=this.vs;this.vs++,this.mutationQueue.length>0&&this.mutationQueue[this.mutationQueue.length-1];const r=new Pr(i,t,n,s);this.mutationQueue.push(r);for(const t of s)this.Rs=this.Rs.add(new go(t.key,i)),this.indexManager.addToCollectionParentIndex(e,t.key.path.popLast());return ae.resolve(r)}lookupMutationBatch(e,t){return ae.resolve(this.Ps(t))}getNextMutationBatchAfterBatchId(e,t){const n=t+1,s=this.bs(n),i=s<0?0:s;return ae.resolve(this.mutationQueue.length>i?this.mutationQueue[i]:null)}getHighestUnacknowledgedBatchId(){return ae.resolve(0===this.mutationQueue.length?-1:this.vs-1)}getAllMutationBatches(e){return ae.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(e,t){const n=new go(t,0),s=new go(t,Number.POSITIVE_INFINITY),i=[];return this.Rs.forEachInRange([n,s],(e=>{const t=this.Ps(e.As);i.push(t)})),ae.resolve(i)}getAllMutationBatchesAffectingDocumentKeys(e,t){let n=new it(B);return t.forEach((e=>{const t=new go(e,0),s=new go(e,Number.POSITIVE_INFINITY);this.Rs.forEachInRange([t,s],(e=>{n=n.add(e.As)}))})),ae.resolve(this.Vs(n))}getAllMutationBatchesAffectingQuery(e,t){const n=t.path,s=n.length+1;let i=n;H.isDocumentKey(i)||(i=i.child(""));const r=new go(new H(i),0);let o=new it(B);return this.Rs.forEachWhile((e=>{const t=e.key.path;return!!n.isPrefixOf(t)&&(t.length===s&&(o=o.add(e.As)),!0)}),r),ae.resolve(this.Vs(o))}Vs(e){const t=[];return e.forEach((e=>{const n=this.Ps(e);null!==n&&t.push(n)})),t}removeMutationBatch(e,t){x(0===this.Ss(t.batchId,"removed")),this.mutationQueue.shift();let n=this.Rs;return ae.forEach(t.mutations,(s=>{const i=new go(s.key,t.batchId);return n=n.delete(i),this.referenceDelegate.markPotentiallyOrphaned(e,s.key)})).next((()=>{this.Rs=n}))}Cn(e){}containsKey(e,t){const n=new go(t,0),s=this.Rs.firstAfterOrEqual(n);return ae.resolve(t.isEqual(s&&s.key))}performConsistencyCheck(e){return this.mutationQueue.length,ae.resolve()}Ss(e,t){return this.bs(e)}bs(e){return 0===this.mutationQueue.length?0:e-this.mutationQueue[0].batchId}Ps(e){const t=this.bs(e);return t<0||t>=this.mutationQueue.length?null:this.mutationQueue[t]}}class yo{constructor(e){this.Ds=e,this.docs=new tt(H.comparator),this.size=0}setIndexManager(e){this.indexManager=e}addEntry(e,t){const n=t.key,s=this.docs.get(n),i=s?s.size:0,r=this.Ds(t);return this.docs=this.docs.insert(n,{document:t.mutableCopy(),size:r}),this.size+=r-i,this.indexManager.addToCollectionParentIndex(e,n.path.popLast())}removeEntry(e){const t=this.docs.get(e);t&&(this.docs=this.docs.remove(e),this.size-=t.size)}getEntry(e,t){const n=this.docs.get(t);return ae.resolve(n?n.document.mutableCopy():$t.newInvalidDocument(t))}getEntries(e,t){let n=$n();return t.forEach((e=>{const t=this.docs.get(e);n=n.insert(e,t?t.document.mutableCopy():$t.newInvalidDocument(e))})),ae.resolve(n)}getDocumentsMatchingQuery(e,t,n,s){let i=$n();const r=t.path,o=new H(r.child("")),u=this.docs.getIteratorFrom(o);for(;u.hasNext();){const{key:e,value:{document:o}}=u.getNext();if(!r.isPrefixOf(e.path))break;e.path.length>r.length+1||re(te(o),n)<=0||(s.has(o.key)||qn(t,o))&&(i=i.insert(o.key,o.mutableCopy()))}return ae.resolve(i)}getAllFromCollectionGroup(e,t,n,s){S()}Cs(e,t){return ae.forEach(this.docs,(e=>t(e)))}newChangeBuffer(e){return new wo(this)}getSize(e){return ae.resolve(this.size)}}class wo extends eo{constructor(e){super(),this.os=e}applyChanges(e){const t=[];return this.changes.forEach(((n,s)=>{s.isValidDocument()?t.push(this.os.addEntry(e,s)):this.os.removeEntry(n)})),ae.waitFor(t)}getFromCache(e,t){return this.os.getEntry(e,t)}getAllFromCache(e,t){return this.os.getEntries(e,t)}}class vo{constructor(e){this.persistence=e,this.xs=new Gn((e=>vn(e)),In),this.lastRemoteSnapshotVersion=rt.min(),this.highestTargetId=0,this.Ns=0,this.ks=new mo,this.targetCount=0,this.Ms=zi.kn()}forEachTarget(e,t){return this.xs.forEach(((e,n)=>t(n))),ae.resolve()}getLastRemoteSnapshotVersion(e){return ae.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(e){return ae.resolve(this.Ns)}allocateTargetId(e){return this.highestTargetId=this.Ms.next(),ae.resolve(this.highestTargetId)}setTargetsMetadata(e,t,n){return n&&(this.lastRemoteSnapshotVersion=n),t>this.Ns&&(this.Ns=t),ae.resolve()}Fn(e){this.xs.set(e.target,e);const t=e.targetId;t>this.highestTargetId&&(this.Ms=new zi(t),this.highestTargetId=t),e.sequenceNumber>this.Ns&&(this.Ns=e.sequenceNumber)}addTargetData(e,t){return this.Fn(t),this.targetCount+=1,ae.resolve()}updateTargetData(e,t){return this.Fn(t),ae.resolve()}removeTargetData(e,t){return this.xs.delete(t.target),this.ks.Is(t.targetId),this.targetCount-=1,ae.resolve()}removeTargets(e,t,n){let s=0;const i=[];return this.xs.forEach(((r,o)=>{o.sequenceNumber<=t&&null===n.get(o.targetId)&&(this.xs.delete(r),i.push(this.removeMatchingKeysForTargetId(e,o.targetId)),s++)})),ae.waitFor(i).next((()=>s))}getTargetCount(e){return ae.resolve(this.targetCount)}getTargetData(e,t){const n=this.xs.get(t)||null;return ae.resolve(n)}addMatchingKeys(e,t,n){return this.ks.gs(t,n),ae.resolve()}removeMatchingKeys(e,t,n){this.ks.ps(t,n);const s=this.persistence.referenceDelegate,i=[];return s&&t.forEach((t=>{i.push(s.markPotentiallyOrphaned(e,t))})),ae.waitFor(i)}removeMatchingKeysForTargetId(e,t){return this.ks.Is(t),ae.resolve()}getMatchingKeysForTargetId(e,t){const n=this.ks.Es(t);return ae.resolve(n)}containsKey(e,t){return ae.resolve(this.ks.containsKey(t))}}class Io{constructor(e,t){this.$s={},this.overlays={},this.Os=new ve(0),this.Fs=!1,this.Fs=!0,this.referenceDelegate=e(this),this.Bs=new vo(this),this.indexManager=new Si,this.remoteDocumentCache=function(e){return new yo(e)}((e=>this.referenceDelegate.Ls(e))),this.serializer=new Bs(t),this.qs=new ho(this.serializer)}start(){return Promise.resolve()}shutdown(){return this.Fs=!1,Promise.resolve()}get started(){return this.Fs}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(e){return this.indexManager}getDocumentOverlayCache(e){let t=this.overlays[e.toKey()];return t||(t=new fo,this.overlays[e.toKey()]=t),t}getMutationQueue(e,t){let n=this.$s[e.toKey()];return n||(n=new po(t,this.referenceDelegate),this.$s[e.toKey()]=n),n}getTargetCache(){return this.Bs}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.qs}runTransaction(e,t,n){v("MemoryPersistence","Starting transaction:",e);const s=new bo(this.Os.next());return this.referenceDelegate.Us(),n(s).next((e=>this.referenceDelegate.Ks(s).next((()=>e)))).toPromise().then((e=>(s.raiseOnCommittedEvent(),e)))}Gs(e,t){return ae.or(Object.values(this.$s).map((n=>()=>n.containsKey(e,t))))}}class bo extends ie{constructor(e){super(),this.currentSequenceNumber=e}}class Eo{constructor(e){this.persistence=e,this.Qs=new mo,this.js=null}static zs(e){return new Eo(e)}get Ws(){if(this.js)return this.js;throw S()}addReference(e,t,n){return this.Qs.addReference(n,t),this.Ws.delete(n.toString()),ae.resolve()}removeReference(e,t,n){return this.Qs.removeReference(n,t),this.Ws.add(n.toString()),ae.resolve()}markPotentiallyOrphaned(e,t){return this.Ws.add(t.toString()),ae.resolve()}removeTarget(e,t){this.Qs.Is(t.targetId).forEach((e=>this.Ws.add(e.toString())));const n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(e,t.targetId).next((e=>{e.forEach((e=>this.Ws.add(e.toString())))})).next((()=>n.removeTargetData(e,t)))}Us(){this.js=new Set}Ks(e){const t=this.persistence.getRemoteDocumentCache().newChangeBuffer();return ae.forEach(this.Ws,(n=>{const s=H.fromPath(n);return this.Hs(e,s).next((e=>{e||t.removeEntry(s,rt.min())}))})).next((()=>(this.js=null,t.apply(e))))}updateLimboDocument(e,t){return this.Hs(e,t).next((e=>{e?this.Ws.delete(t.toString()):this.Ws.add(t.toString())}))}Ls(e){return 0}Hs(e,t){return ae.or([()=>ae.resolve(this.Qs.containsKey(t)),()=>this.persistence.getTargetCache().containsKey(e,t),()=>this.persistence.Gs(e,t)])}}class To{constructor(e){this.serializer=e}O(e,t,n,s){const i=new ce("createOrUpgrade",t);n<1&&s>=1&&(function(e){e.createObjectStore("owner")}(e),function(e){e.createObjectStore("mutationQueues",{keyPath:"userId"}),e.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",De,{unique:!0}),e.createObjectStore("documentMutations")}(e),So(e),function(e){e.createObjectStore("remoteDocuments")}(e));let r=ae.resolve();return n<3&&s>=3&&(0!==n&&(function(e){e.deleteObjectStore("targetDocuments"),e.deleteObjectStore("targets"),e.deleteObjectStore("targetGlobal")}(e),So(e)),r=r.next((()=>function(e){const t=e.store("targetGlobal"),n={highestTargetId:0,highestListenSequenceNumber:0,lastRemoteSnapshotVersion:rt.min().toTimestamp(),targetCount:0};return t.put("targetGlobalKey",n)}(i)))),n<4&&s>=4&&(0!==n&&(r=r.next((()=>function(e,t){return t.store("mutations").j().next((n=>{e.deleteObjectStore("mutations"),e.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",De,{unique:!0});const s=t.store("mutations"),i=n.map((e=>s.put(e)));return ae.waitFor(i)}))}(e,i)))),r=r.next((()=>{!function(e){e.createObjectStore("clientMetadata",{keyPath:"clientId"})}(e)}))),n<5&&s>=5&&(r=r.next((()=>this.Ys(i)))),n<6&&s>=6&&(r=r.next((()=>(function(e){e.createObjectStore("remoteDocumentGlobal")}(e),this.Xs(i))))),n<7&&s>=7&&(r=r.next((()=>this.Zs(i)))),n<8&&s>=8&&(r=r.next((()=>this.ti(e,i)))),n<9&&s>=9&&(r=r.next((()=>{!function(e){e.objectStoreNames.contains("remoteDocumentChanges")&&e.deleteObjectStore("remoteDocumentChanges")}(e)}))),n<10&&s>=10&&(r=r.next((()=>this.ei(i)))),n<11&&s>=11&&(r=r.next((()=>{!function(e){e.createObjectStore("bundles",{keyPath:"bundleId"})}(e),function(e){e.createObjectStore("namedQueries",{keyPath:"name"})}(e)}))),n<12&&s>=12&&(r=r.next((()=>{!function(e){const t=e.createObjectStore("documentOverlays",{keyPath:ze});t.createIndex("collectionPathOverlayIndex",Ge,{unique:!1}),t.createIndex("collectionGroupOverlayIndex",Ke,{unique:!1})}(e)}))),n<13&&s>=13&&(r=r.next((()=>function(e){const t=e.createObjectStore("remoteDocumentsV14",{keyPath:ke});t.createIndex("documentKeyIndex",Re),t.createIndex("collectionGroupIndex",Fe)}(e))).next((()=>this.ni(e,i))).next((()=>e.deleteObjectStore("remoteDocuments")))),n<14&&s>=14&&(r=r.next((()=>this.si(e,i)))),n<15&&s>=15&&(r=r.next((()=>function(e){e.createObjectStore("indexConfiguration",{keyPath:"indexId",autoIncrement:!0}).createIndex("collectionGroupIndex","collectionGroup",{unique:!1}),e.createObjectStore("indexState",{keyPath:Pe}).createIndex("sequenceNumberIndex",qe,{unique:!1}),e.createObjectStore("indexEntries",{keyPath:Ue}).createIndex("documentKeyIndex",Be,{unique:!1})}(e)))),r}Xs(e){let t=0;return e.store("remoteDocuments").X(((e,n)=>{t+=Mi(n)})).next((()=>{const n={byteSize:t};return e.store("remoteDocumentGlobal").put("remoteDocumentGlobalKey",n)}))}Ys(e){const t=e.store("mutationQueues"),n=e.store("mutations");return t.j().next((t=>ae.forEach(t,(t=>{const s=IDBKeyRange.bound([t.userId,-1],[t.userId,t.lastAcknowledgedBatchId]);return n.j("userMutationsIndex",s).next((n=>ae.forEach(n,(n=>{x(n.userId===t.userId);const s=js(this.serializer,n);return Oi(e,t.userId,s).next((()=>{}))}))))}))))}Zs(e){const t=e.store("targetDocuments"),n=e.store("remoteDocuments");return e.store("targetGlobal").get("targetGlobalKey").next((e=>{const s=[];return n.X(((n,i)=>{const r=new j(n),o=function(e){return[0,Te(e)]}(r);s.push(t.get(o).next((n=>n?ae.resolve():(n=>t.put({targetId:0,path:Te(n),sequenceNumber:e.highestListenSequenceNumber}))(r))))})).next((()=>ae.waitFor(s)))}))}ti(e,t){e.createObjectStore("collectionParents",{keyPath:Le});const n=t.store("collectionParents"),s=new xi,i=e=>{if(s.add(e)){const t=e.lastSegment(),s=e.popLast();return n.put({collectionId:t,parent:Te(s)})}};return t.store("remoteDocuments").X({Y:!0},((e,t)=>{const n=new j(e);return i(n.popLast())})).next((()=>t.store("documentMutations").X({Y:!0},(([e,t,n],s)=>{const r=_e(t);return i(r.popLast())}))))}ei(e){const t=e.store("targets");return t.X(((e,n)=>{const s=Qs(n),i=Ws(this.serializer,s);return t.put(i)}))}ni(e,t){const n=t.store("remoteDocuments"),s=[];return n.X(((e,n)=>{const i=t.store("remoteDocumentsV14"),r=(o=n,o.document?new H(j.fromString(o.document.name).popFirst(5)):o.noDocument?H.fromSegments(o.noDocument.path):o.unknownDocument?H.fromSegments(o.unknownDocument.path):S()).path.toArray();var o;const u={prefixPath:r.slice(0,r.length-2),collectionGroup:r[r.length-2],documentId:r[r.length-1],readTime:n.readTime||[0,0],unknownDocument:n.unknownDocument,noDocument:n.noDocument,document:n.document,hasCommittedMutations:!!n.hasCommittedMutations};s.push(i.put(u))})).next((()=>ae.waitFor(s)))}si(e,t){const n=t.store("mutations"),s=no(this.serializer),i=new Io(Eo.zs,this.serializer.fe);return n.j().next((e=>{const n=new Map;return e.forEach((e=>{var t;let s=null!==(t=n.get(e.userId))&&void 0!==t?t:er();js(this.serializer,e).keys().forEach((e=>s=s.add(e))),n.set(e.userId,s)})),ae.forEach(n,((e,n)=>{const r=new d(n),o=ni.de(this.serializer,r),u=i.getIndexManager(r),c=Li.de(r,this.serializer,u,i.referenceDelegate);return new lo(s,c,o,u).recalculateAndSaveOverlaysForDocumentKeys(new Ye(t,ve.ct),e).next()}))}))}}function So(e){e.createObjectStore("targetDocuments",{keyPath:Oe}).createIndex("documentTargetsIndex",Me,{unique:!0}),e.createObjectStore("targets",{keyPath:"targetId"}).createIndex("queryTargetsIndex",Ve,{unique:!0}),e.createObjectStore("targetGlobal")}const xo="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.";class _o{constructor(e,t,n,s,i,r,o,u,c,a,l=15){if(this.allowTabSynchronization=e,this.persistenceKey=t,this.clientId=n,this.ii=i,this.window=r,this.document=o,this.ri=c,this.oi=a,this.ui=l,this.Os=null,this.Fs=!1,this.isPrimary=!1,this.networkEnabled=!0,this.ci=null,this.inForeground=!1,this.ai=null,this.hi=null,this.li=Number.NEGATIVE_INFINITY,this.fi=e=>Promise.resolve(),!_o.D())throw new N(q.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new Ji(this,s),this.di=t+"main",this.serializer=new Bs(u),this.wi=new ue(this.di,this.ui,new To(this.serializer)),this.Bs=new Gi(this.referenceDelegate,this.serializer),this.remoteDocumentCache=no(this.serializer),this.qs=new Zs,this.window&&this.window.localStorage?this._i=this.window.localStorage:(this._i=null,!1===a&&I("IndexedDbPersistence","LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.mi().then((()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new N(q.FAILED_PRECONDITION,xo);return this.gi(),this.yi(),this.pi(),this.runTransaction("getHighestListenSequenceNumber","readonly",(e=>this.Bs.getHighestSequenceNumber(e)))})).then((e=>{this.Os=new ve(e,this.ri)})).then((()=>{this.Fs=!0})).catch((e=>(this.wi&&this.wi.close(),Promise.reject(e))))}Ii(e){return this.fi=async t=>{if(this.started)return e(t)},e(this.isPrimary)}setDatabaseDeletedListener(e){this.wi.B((async t=>{null===t.newVersion&&await e()}))}setNetworkEnabled(e){this.networkEnabled!==e&&(this.networkEnabled=e,this.ii.enqueueAndForget((async()=>{this.started&&await this.mi()})))}mi(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",(e=>No(e).put({clientId:this.clientId,updateTimeMs:Date.now(),networkEnabled:this.networkEnabled,inForeground:this.inForeground}).next((()=>{if(this.isPrimary)return this.Ti(e).next((e=>{e||(this.isPrimary=!1,this.ii.enqueueRetryable((()=>this.fi(!1))))}))})).next((()=>this.Ei(e))).next((t=>this.isPrimary&&!t?this.Ai(e).next((()=>!1)):!!t&&this.vi(e).next((()=>!0)))))).catch((e=>{if(de(e))return v("IndexedDbPersistence","Failed to extend owner lease: ",e),this.isPrimary;if(!this.allowTabSynchronization)throw e;return v("IndexedDbPersistence","Releasing owner lease after error during lease refresh",e),!1})).then((e=>{this.isPrimary!==e&&this.ii.enqueueRetryable((()=>this.fi(e))),this.isPrimary=e}))}Ti(e){return Do(e).get("owner").next((e=>ae.resolve(this.Ri(e))))}Pi(e){return No(e).delete(this.clientId)}async bi(){if(this.isPrimary&&!this.Vi(this.li,18e5)){this.li=Date.now();const e=await this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",(e=>{const t=Xe(e,"clientMetadata");return t.j().next((e=>{const n=this.Si(e,18e5),s=e.filter((e=>-1===n.indexOf(e)));return ae.forEach(s,(e=>t.delete(e.clientId))).next((()=>s))}))})).catch((()=>[]));if(this._i)for(const t of e)this._i.removeItem(this.Di(t.clientId))}}pi(){this.hi=this.ii.enqueueAfterDelay("client_metadata_refresh",4e3,(()=>this.mi().then((()=>this.bi())).then((()=>this.pi()))))}Ri(e){return!!e&&e.ownerId===this.clientId}Ei(e){return this.oi?ae.resolve(!0):Do(e).get("owner").next((t=>{if(null!==t&&this.Vi(t.leaseTimestampMs,5e3)&&!this.Ci(t.ownerId)){if(this.Ri(t)&&this.networkEnabled)return!0;if(!this.Ri(t)){if(!t.allowTabSynchronization)throw new N(q.FAILED_PRECONDITION,xo);return!1}}return!(!this.networkEnabled||!this.inForeground)||No(e).j().next((e=>void 0===this.Si(e,5e3).find((e=>{if(this.clientId!==e.clientId){const t=!this.networkEnabled&&e.networkEnabled,n=!this.inForeground&&e.inForeground,s=this.networkEnabled===e.networkEnabled;if(t||n&&s)return!0}return!1}))))})).next((e=>(this.isPrimary!==e&&v("IndexedDbPersistence",`Client ${e?"is":"is not"} eligible for a primary lease.`),e)))}async shutdown(){this.Fs=!1,this.xi(),this.hi&&(this.hi.cancel(),this.hi=null),this.Ni(),this.ki(),await this.wi.runTransaction("shutdown","readwrite",["owner","clientMetadata"],(e=>{const t=new Ye(e,ve.ct);return this.Ai(t).next((()=>this.Pi(t)))})),this.wi.close(),this.Mi()}Si(e,t){return e.filter((e=>this.Vi(e.updateTimeMs,t)&&!this.Ci(e.clientId)))}$i(){return this.runTransaction("getActiveClients","readonly",(e=>No(e).j().next((e=>this.Si(e,18e5).map((e=>e.clientId))))))}get started(){return this.Fs}getMutationQueue(e,t){return Li.de(e,this.serializer,t,this.referenceDelegate)}getTargetCache(){return this.Bs}getRemoteDocumentCache(){return this.remoteDocumentCache}getIndexManager(e){return new Di(e,this.serializer.fe.databaseId)}getDocumentOverlayCache(e){return ni.de(this.serializer,e)}getBundleCache(){return this.qs}runTransaction(e,t,n){v("IndexedDbPersistence","Starting transaction:",e);const s="readonly"===t?"readonly":"readwrite",i=15===(r=this.ui)?He:14===r?We:13===r?Qe:12===r?je:11===r?$e:void S();var r;let o;return this.wi.runTransaction(e,s,i,(s=>(o=new Ye(s,this.Os?this.Os.next():ve.ct),"readwrite-primary"===t?this.Ti(o).next((e=>!!e||this.Ei(o))).next((t=>{if(!t)throw I(`Failed to obtain primary lease for action '${e}'.`),this.isPrimary=!1,this.ii.enqueueRetryable((()=>this.fi(!1))),new N(q.FAILED_PRECONDITION,se);return n(o)})).next((e=>this.vi(o).next((()=>e)))):this.Oi(o).next((()=>n(o)))))).then((e=>(o.raiseOnCommittedEvent(),e)))}Oi(e){return Do(e).get("owner").next((e=>{if(null!==e&&this.Vi(e.leaseTimestampMs,5e3)&&!this.Ci(e.ownerId)&&!this.Ri(e)&&!(this.oi||this.allowTabSynchronization&&e.allowTabSynchronization))throw new N(q.FAILED_PRECONDITION,xo)}))}vi(e){const t={ownerId:this.clientId,allowTabSynchronization:this.allowTabSynchronization,leaseTimestampMs:Date.now()};return Do(e).put("owner",t)}static D(){return ue.D()}Ai(e){const t=Do(e);return t.get("owner").next((e=>this.Ri(e)?(v("IndexedDbPersistence","Releasing primary lease."),t.delete("owner")):ae.resolve()))}Vi(e,t){const n=Date.now();return!(e<n-t||e>n&&(I(`Detected an update time that is in the future: ${e} > ${n}`),1))}gi(){null!==this.document&&"function"==typeof this.document.addEventListener&&(this.ai=()=>{this.ii.enqueueAndForget((()=>(this.inForeground="visible"===this.document.visibilityState,this.mi())))},this.document.addEventListener("visibilitychange",this.ai),this.inForeground="visible"===this.document.visibilityState)}Ni(){this.ai&&(this.document.removeEventListener("visibilitychange",this.ai),this.ai=null)}yi(){var e;"function"==typeof(null===(e=this.window)||void 0===e?void 0:e.addEventListener)&&(this.ci=()=>{this.xi();const e=/(?:Version|Mobile)\/1[456]/;Object(l.L)()&&(navigator.appVersion.match(e)||navigator.userAgent.match(e))&&this.ii.enterRestrictedMode(!0),this.ii.enqueueAndForget((()=>this.shutdown()))},this.window.addEventListener("pagehide",this.ci))}ki(){this.ci&&(this.window.removeEventListener("pagehide",this.ci),this.ci=null)}Ci(e){var t;try{const n=null!==(null===(t=this._i)||void 0===t?void 0:t.getItem(this.Di(e)));return v("IndexedDbPersistence",`Client '${e}' ${n?"is":"is not"} zombied in LocalStorage`),n}catch(e){return I("IndexedDbPersistence","Failed to get zombied client id.",e),!1}}xi(){if(this._i)try{this._i.setItem(this.Di(this.clientId),String(Date.now()))}catch(e){I("Failed to set zombie client id.",e)}}Mi(){if(this._i)try{this._i.removeItem(this.Di(this.clientId))}catch(e){}}Di(e){return`firestore_zombie_${this.persistenceKey}_${e}`}}function Do(e){return Xe(e,"owner")}function No(e){return Xe(e,"clientMetadata")}function Co(e,t){let n=e.projectId;return e.isDefaultDatabase||(n+="."+e.database),"firestore/"+t+"/"+n+"/"}class Ao{constructor(e,t,n,s){this.targetId=e,this.fromCache=t,this.Fi=n,this.Bi=s}static Li(e,t){let n=er(),s=er();for(const e of t.docChanges)switch(e.type){case 0:n=n.add(e.doc.key);break;case 1:s=s.add(e.doc.key)}return new Ao(e,t.fromCache,n,s)}}class ko{constructor(){this.qi=!1}initialize(e,t){this.Ui=e,this.indexManager=t,this.qi=!0}getDocumentsMatchingQuery(e,t,n,s){return this.Ki(e,t).next((i=>i||this.Gi(e,t,s,n))).next((n=>n||this.Qi(e,t)))}Ki(e,t){if(Nn(t))return ae.resolve(null);let n=Fn(t);return this.indexManager.getIndexType(e,n).next((s=>0===s?null:(null!==t.limit&&1===s&&(t=On(t,null,"F"),n=Fn(t)),this.indexManager.getDocumentsMatchingTarget(e,n).next((s=>{const i=er(...s);return this.Ui.getDocuments(e,i).next((s=>this.indexManager.getMinOffset(e,n).next((n=>{const r=this.ji(t,s);return this.zi(t,r,i,n.readTime)?this.Ki(e,On(t,null,"F")):this.Wi(e,r,t,n)}))))})))))}Gi(e,t,n,s){return Nn(t)||s.isEqual(rt.min())?this.Qi(e,t):this.Ui.getDocuments(e,n).next((i=>{const r=this.ji(t,i);return this.zi(t,r,n,s)?this.Qi(e,t):(y()<=c.a.DEBUG&&v("QueryEngine","Re-using previous result from %s to execute query: %s",s.toString(),Pn(t)),this.Wi(e,r,t,ee(s,-1)))}))}ji(e,t){let n=new it(Bn(e));return t.forEach(((t,s)=>{qn(e,s)&&(n=n.add(s))})),n}zi(e,t,n,s){if(null===e.limit)return!1;if(n.size!==t.size)return!0;const i="F"===e.limitType?t.last():t.first();return!!i&&(i.hasPendingWrites||i.version.compareTo(s)>0)}Qi(e,t){return y()<=c.a.DEBUG&&v("QueryEngine","Using full collection scan to execute query:",Pn(t)),this.Ui.getDocumentsMatchingQuery(e,t,ne.min())}Wi(e,t,n,s){return this.Ui.getDocumentsMatchingQuery(e,n,s).next((e=>(t.forEach((t=>{e=e.insert(t.key,t)})),e)))}}class Ro{constructor(e,t,n,s){this.persistence=e,this.Hi=t,this.serializer=s,this.Ji=new tt(B),this.Yi=new Gn((e=>vn(e)),In),this.Xi=new Map,this.Zi=e.getRemoteDocumentCache(),this.Bs=e.getTargetCache(),this.qs=e.getBundleCache(),this.tr(n)}tr(e){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(e),this.indexManager=this.persistence.getIndexManager(e),this.mutationQueue=this.persistence.getMutationQueue(e,this.indexManager),this.localDocuments=new lo(this.Zi,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.Zi.setIndexManager(this.indexManager),this.Hi.initialize(this.localDocuments,this.indexManager)}collectGarbage(e){return this.persistence.runTransaction("Collect garbage","readwrite-primary",(t=>e.collect(t,this.Ji)))}}function Fo(e,t,n,s){return new Ro(e,t,n,s)}async function Vo(e,t){const n=D(e);return await n.persistence.runTransaction("Handle user change","readonly",(e=>{let s;return n.mutationQueue.getAllMutationBatches(e).next((i=>(s=i,n.tr(t),n.mutationQueue.getAllMutationBatches(e)))).next((t=>{const i=[],r=[];let o=er();for(const e of s){i.push(e.batchId);for(const t of e.mutations)o=o.add(t.key)}for(const e of t){r.push(e.batchId);for(const t of e.mutations)o=o.add(t.key)}return n.localDocuments.getDocuments(e,o).next((e=>({er:e,removedBatchIds:i,addedBatchIds:r})))}))}))}function Oo(e){const t=D(e);return t.persistence.runTransaction("Get last remote snapshot version","readonly",(e=>t.Bs.getLastRemoteSnapshotVersion(e)))}function Mo(e,t,n){let s=er(),i=er();return n.forEach((e=>s=s.add(e))),t.getEntries(e,s).next((e=>{let s=$n();return n.forEach(((n,r)=>{const o=e.get(n);r.isFoundDocument()!==o.isFoundDocument()&&(i=i.add(n)),r.isNoDocument()&&r.version.isEqual(rt.min())?(t.removeEntry(n,r.readTime),s=s.insert(n,r)):!o.isValidDocument()||r.version.compareTo(o.version)>0||0===r.version.compareTo(o.version)&&o.hasPendingWrites?(t.addEntry(r),s=s.insert(n,r)):v("LocalStore","Ignoring outdated watch update for ",n,". Current version:",o.version," Watch version:",r.version)})),{nr:s,sr:i}}))}function Lo(e,t){const n=D(e);return n.persistence.runTransaction("Get next mutation batch","readonly",(e=>(void 0===t&&(t=-1),n.mutationQueue.getNextMutationBatchAfterBatchId(e,t))))}function Po(e,t){const n=D(e);return n.persistence.runTransaction("Allocate target","readwrite",(e=>{let s;return n.Bs.getTargetData(e,t).next((i=>i?(s=i,ae.resolve(s)):n.Bs.allocateTargetId(e).next((i=>(s=new Us(t,i,"TargetPurposeListen",e.currentSequenceNumber),n.Bs.addTargetData(e,s).next((()=>s)))))))})).then((e=>{const s=n.Ji.get(e.targetId);return(null===s||e.snapshotVersion.compareTo(s.snapshotVersion)>0)&&(n.Ji=n.Ji.insert(e.targetId,e),n.Yi.set(t,e.targetId)),e}))}async function qo(e,t,n){const s=D(e),i=s.Ji.get(t),r=n?"readwrite":"readwrite-primary";try{n||await s.persistence.runTransaction("Release target",r,(e=>s.persistence.referenceDelegate.removeTarget(e,i)))}catch(e){if(!de(e))throw e;v("LocalStore",`Failed to update sequence numbers for target ${t}: ${e}`)}s.Ji=s.Ji.remove(t),s.Yi.delete(i.target)}function Uo(e,t,n){const s=D(e);let i=rt.min(),r=er();return s.persistence.runTransaction("Execute query","readonly",(e=>function(e,t,n){const s=D(e),i=s.Yi.get(n);return void 0!==i?ae.resolve(s.Ji.get(i)):s.Bs.getTargetData(t,n)}(s,e,Fn(t)).next((t=>{if(t)return i=t.lastLimboFreeSnapshotVersion,s.Bs.getMatchingKeysForTargetId(e,t.targetId).next((e=>{r=e}))})).next((()=>s.Hi.getDocumentsMatchingQuery(e,t,n?i:rt.min(),n?r:er()))).next((e=>(Go(s,Un(t),e),{documents:e,ir:r})))))}function Bo(e,t){const n=D(e),s=D(n.Bs),i=n.Ji.get(t);return i?Promise.resolve(i.target):n.persistence.runTransaction("Get target data","readonly",(e=>s.le(e,t).next((e=>e?e.target:null))))}function zo(e,t){const n=D(e),s=n.Xi.get(t)||rt.min();return n.persistence.runTransaction("Get new document changes","readonly",(e=>n.Zi.getAllFromCollectionGroup(e,t,ee(s,-1),Number.MAX_SAFE_INTEGER))).then((e=>(Go(n,t,e),e)))}function Go(e,t,n){let s=e.Xi.get(t)||rt.min();n.forEach(((e,t)=>{t.readTime.compareTo(s)>0&&(s=t.readTime)})),e.Xi.set(t,s)}async function Ko(e,t,n=er()){const s=await Po(e,Fn(Hs(t.bundledQuery))),i=D(e);return i.persistence.runTransaction("Save named query","readwrite",(e=>{const r=ps(t.readTime);if(s.snapshotVersion.compareTo(r)>=0)return i.qs.saveNamedQuery(e,t);const o=s.withResumeToken(ht.EMPTY_BYTE_STRING,r);return i.Ji=i.Ji.insert(o.targetId,o),i.Bs.updateTargetData(e,o).next((()=>i.Bs.removeMatchingKeysForTargetId(e,s.targetId))).next((()=>i.Bs.addMatchingKeys(e,n,s.targetId))).next((()=>i.qs.saveNamedQuery(e,t)))}))}function $o(e,t){return`firestore_clients_${e}_${t}`}function jo(e,t,n){let s=`firestore_mutations_${e}_${n}`;return t.isAuthenticated()&&(s+=`_${t.uid}`),s}function Qo(e,t){return`firestore_targets_${e}_${t}`}class Wo{constructor(e,t,n,s){this.user=e,this.batchId=t,this.state=n,this.error=s}static ar(e,t,n){const s=JSON.parse(n);let i,r="object"==typeof s&&-1!==["pending","acknowledged","rejected"].indexOf(s.state)&&(void 0===s.error||"object"==typeof s.error);return r&&s.error&&(r="string"==typeof s.error.message&&"string"==typeof s.error.code,r&&(i=new N(s.error.code,s.error.message))),r?new Wo(e,t,s.state,i):(I("SharedClientState",`Failed to parse mutation state for ID '${t}': ${n}`),null)}hr(){const e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class Ho{constructor(e,t,n){this.targetId=e,this.state=t,this.error=n}static ar(e,t){const n=JSON.parse(t);let s,i="object"==typeof n&&-1!==["not-current","current","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error);return i&&n.error&&(i="string"==typeof n.error.message&&"string"==typeof n.error.code,i&&(s=new N(n.error.code,n.error.message))),i?new Ho(e,n.state,s):(I("SharedClientState",`Failed to parse target state for ID '${e}': ${t}`),null)}hr(){const e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class Yo{constructor(e,t){this.clientId=e,this.activeTargetIds=t}static ar(e,t){const n=JSON.parse(t);let s="object"==typeof n&&n.activeTargetIds instanceof Array,i=rr();for(let e=0;s&&e<n.activeTargetIds.length;++e)s=Ee(n.activeTargetIds[e]),i=i.add(n.activeTargetIds[e]);return s?new Yo(e,i):(I("SharedClientState",`Failed to parse client data for instance '${e}': ${t}`),null)}}class Xo{constructor(e,t){this.clientId=e,this.onlineState=t}static ar(e){const t=JSON.parse(e);return"object"==typeof t&&-1!==["Unknown","Online","Offline"].indexOf(t.onlineState)&&"string"==typeof t.clientId?new Xo(t.clientId,t.onlineState):(I("SharedClientState",`Failed to parse online state: ${e}`),null)}}class Jo{constructor(){this.activeTargetIds=rr()}lr(e){this.activeTargetIds=this.activeTargetIds.add(e)}dr(e){this.activeTargetIds=this.activeTargetIds.delete(e)}hr(){const e={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(e)}}class Zo{constructor(e,t,n,s,i){this.window=e,this.ii=t,this.persistenceKey=n,this.wr=s,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this._r=this.mr.bind(this),this.gr=new tt(B),this.started=!1,this.yr=[];const r=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=i,this.pr=$o(this.persistenceKey,this.wr),this.Ir=function(e){return`firestore_sequence_number_${e}`}(this.persistenceKey),this.gr=this.gr.insert(this.wr,new Jo),this.Tr=new RegExp(`^firestore_clients_${r}_([^_]*)$`),this.Er=new RegExp(`^firestore_mutations_${r}_(\\d+)(?:_(.*))?$`),this.Ar=new RegExp(`^firestore_targets_${r}_(\\d+)$`),this.vr=function(e){return`firestore_online_state_${e}`}(this.persistenceKey),this.Rr=function(e){return`firestore_bundle_loaded_v2_${e}`}(this.persistenceKey),this.window.addEventListener("storage",this._r)}static D(e){return!(!e||!e.localStorage)}async start(){const e=await this.syncEngine.$i();for(const t of e){if(t===this.wr)continue;const e=this.getItem($o(this.persistenceKey,t));if(e){const n=Yo.ar(t,e);n&&(this.gr=this.gr.insert(n.clientId,n))}}this.Pr();const t=this.storage.getItem(this.vr);if(t){const e=this.br(t);e&&this.Vr(e)}for(const e of this.yr)this.mr(e);this.yr=[],this.window.addEventListener("pagehide",(()=>this.shutdown())),this.started=!0}writeSequenceNumber(e){this.setItem(this.Ir,JSON.stringify(e))}getAllActiveQueryTargets(){return this.Sr(this.gr)}isActiveQueryTarget(e){let t=!1;return this.gr.forEach(((n,s)=>{s.activeTargetIds.has(e)&&(t=!0)})),t}addPendingMutation(e){this.Dr(e,"pending")}updateMutationState(e,t,n){this.Dr(e,t,n),this.Cr(e)}addLocalQueryTarget(e){let t="not-current";if(this.isActiveQueryTarget(e)){const n=this.storage.getItem(Qo(this.persistenceKey,e));if(n){const s=Ho.ar(e,n);s&&(t=s.state)}}return this.Nr.lr(e),this.Pr(),t}removeLocalQueryTarget(e){this.Nr.dr(e),this.Pr()}isLocalQueryTarget(e){return this.Nr.activeTargetIds.has(e)}clearQueryState(e){this.removeItem(Qo(this.persistenceKey,e))}updateQueryState(e,t,n){this.kr(e,t,n)}handleUserChange(e,t,n){t.forEach((e=>{this.Cr(e)})),this.currentUser=e,n.forEach((e=>{this.addPendingMutation(e)}))}setOnlineState(e){this.Mr(e)}notifyBundleLoaded(e){this.$r(e)}shutdown(){this.started&&(this.window.removeEventListener("storage",this._r),this.removeItem(this.pr),this.started=!1)}getItem(e){const t=this.storage.getItem(e);return v("SharedClientState","READ",e,t),t}setItem(e,t){v("SharedClientState","SET",e,t),this.storage.setItem(e,t)}removeItem(e){v("SharedClientState","REMOVE",e),this.storage.removeItem(e)}mr(e){const t=e;if(t.storageArea===this.storage){if(v("SharedClientState","EVENT",t.key,t.newValue),t.key===this.pr)return void I("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.ii.enqueueRetryable((async()=>{if(this.started){if(null!==t.key)if(this.Tr.test(t.key)){if(null==t.newValue){const e=this.Or(t.key);return this.Fr(e,null)}{const e=this.Br(t.key,t.newValue);if(e)return this.Fr(e.clientId,e)}}else if(this.Er.test(t.key)){if(null!==t.newValue){const e=this.Lr(t.key,t.newValue);if(e)return this.qr(e)}}else if(this.Ar.test(t.key)){if(null!==t.newValue){const e=this.Ur(t.key,t.newValue);if(e)return this.Kr(e)}}else if(t.key===this.vr){if(null!==t.newValue){const e=this.br(t.newValue);if(e)return this.Vr(e)}}else if(t.key===this.Ir){const e=function(e){let t=ve.ct;if(null!=e)try{const n=JSON.parse(e);x("number"==typeof n),t=n}catch(e){I("SharedClientState","Failed to read sequence number from WebStorage",e)}return t}(t.newValue);e!==ve.ct&&this.sequenceNumberHandler(e)}else if(t.key===this.Rr){const e=this.Gr(t.newValue);await Promise.all(e.map((e=>this.syncEngine.Qr(e))))}}else this.yr.push(t)}))}}get Nr(){return this.gr.get(this.wr)}Pr(){this.setItem(this.pr,this.Nr.hr())}Dr(e,t,n){const s=new Wo(this.currentUser,e,t,n),i=jo(this.persistenceKey,this.currentUser,e);this.setItem(i,s.hr())}Cr(e){const t=jo(this.persistenceKey,this.currentUser,e);this.removeItem(t)}Mr(e){const t={clientId:this.wr,onlineState:e};this.storage.setItem(this.vr,JSON.stringify(t))}kr(e,t,n){const s=Qo(this.persistenceKey,e),i=new Ho(e,t,n);this.setItem(s,i.hr())}$r(e){const t=JSON.stringify(Array.from(e));this.setItem(this.Rr,t)}Or(e){const t=this.Tr.exec(e);return t?t[1]:null}Br(e,t){const n=this.Or(e);return Yo.ar(n,t)}Lr(e,t){const n=this.Er.exec(e),s=Number(n[1]),i=void 0!==n[2]?n[2]:null;return Wo.ar(new d(i),s,t)}Ur(e,t){const n=this.Ar.exec(e),s=Number(n[1]);return Ho.ar(s,t)}br(e){return Xo.ar(e)}Gr(e){return JSON.parse(e)}async qr(e){if(e.user.uid===this.currentUser.uid)return this.syncEngine.jr(e.batchId,e.state,e.error);v("SharedClientState",`Ignoring mutation for non-active user ${e.user.uid}`)}Kr(e){return this.syncEngine.zr(e.targetId,e.state,e.error)}Fr(e,t){const n=t?this.gr.insert(e,t):this.gr.remove(e),s=this.Sr(this.gr),i=this.Sr(n),r=[],o=[];return i.forEach((e=>{s.has(e)||r.push(e)})),s.forEach((e=>{i.has(e)||o.push(e)})),this.syncEngine.Wr(r,o).then((()=>{this.gr=n}))}Vr(e){this.gr.get(e.clientId)&&this.onlineStateHandler(e.onlineState)}Sr(e){let t=rr();return e.forEach(((e,n)=>{t=t.unionWith(n.activeTargetIds)})),t}}class ea{constructor(){this.Hr=new Jo,this.Jr={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(e){}updateMutationState(e,t,n){}addLocalQueryTarget(e){return this.Hr.lr(e),this.Jr[e]||"not-current"}updateQueryState(e,t,n){this.Jr[e]=t}removeLocalQueryTarget(e){this.Hr.dr(e)}isLocalQueryTarget(e){return this.Hr.activeTargetIds.has(e)}clearQueryState(e){delete this.Jr[e]}getAllActiveQueryTargets(){return this.Hr.activeTargetIds}isActiveQueryTarget(e){return this.Hr.activeTargetIds.has(e)}start(){return this.Hr=new Jo,Promise.resolve()}handleUserChange(e,t,n){}setOnlineState(e){}shutdown(){}writeSequenceNumber(e){}notifyBundleLoaded(e){}}class ta{Yr(e){}shutdown(){}}class na{constructor(){this.Xr=()=>this.Zr(),this.eo=()=>this.no(),this.so=[],this.io()}Yr(e){this.so.push(e)}shutdown(){window.removeEventListener("online",this.Xr),window.removeEventListener("offline",this.eo)}io(){window.addEventListener("online",this.Xr),window.addEventListener("offline",this.eo)}Zr(){v("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(const e of this.so)e(0)}no(){v("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(const e of this.so)e(1)}static D(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}let ra=null;function sa(){return null===ra?ra=268435456+Math.round(2147483648*Math.random()):ra++,"0x"+ra.toString(16)}const ia={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"};class oa{constructor(e){this.ro=e.ro,this.oo=e.oo}uo(e){this.co=e}ao(e){this.ho=e}onMessage(e){this.lo=e}close(){this.oo()}send(e){this.ro(e)}fo(){this.co()}wo(e){this.ho(e)}_o(e){this.lo(e)}}const aa="WebChannelConnection";class ca extends class{constructor(e){this.databaseInfo=e,this.databaseId=e.databaseId;const t=e.ssl?"https":"http";this.mo=t+"://"+e.host,this.yo="projects/"+this.databaseId.projectId+"/databases/"+this.databaseId.database+"/documents"}get po(){return!1}Io(e,t,n,s,i){const r=sa(),o=this.To(e,t);v("RestConnection",`Sending RPC '${e}' ${r}:`,o,n);const u={};return this.Eo(u,s,i),this.Ao(e,o,u,n).then((t=>(v("RestConnection",`Received RPC '${e}' ${r}: `,t),t)),(t=>{throw E("RestConnection",`RPC '${e}' ${r} failed with error: `,t,"url: ",o,"request:",n),t}))}vo(e,t,n,s,i,r){return this.Io(e,t,n,s,i)}Eo(e,t,n){e["X-Goog-Api-Client"]="gl-js/ fire/"+f,e["Content-Type"]="text/plain",this.databaseInfo.appId&&(e["X-Firebase-GMPID"]=this.databaseInfo.appId),t&&t.headers.forEach(((t,n)=>e[n]=t)),n&&n.headers.forEach(((t,n)=>e[n]=t))}To(e,t){const n=ia[e];return`${this.mo}/v1/${t}:${n}`}}{constructor(e){super(e),this.forceLongPolling=e.forceLongPolling,this.autoDetectLongPolling=e.autoDetectLongPolling,this.useFetchStreams=e.useFetchStreams,this.longPollingOptions=e.longPollingOptions}Ao(e,t,n,s){const i=sa();return new Promise(((r,o)=>{const u=new h.i;u.setWithCredentials(!0),u.listenOnce(h.c.COMPLETE,(()=>{try{switch(u.getLastErrorCode()){case h.a.NO_ERROR:const t=u.getResponseJson();v(aa,`XHR for RPC '${e}' ${i} received:`,JSON.stringify(t)),r(t);break;case h.a.TIMEOUT:v(aa,`RPC '${e}' ${i} timed out`),o(new N(q.DEADLINE_EXCEEDED,"Request time out"));break;case h.a.HTTP_ERROR:const n=u.getStatus();if(v(aa,`RPC '${e}' ${i} failed with status:`,n,"response text:",u.getResponseText()),n>0){let e=u.getResponseJson();Array.isArray(e)&&(e=e[0]);const t=null==e?void 0:e.error;if(t&&t.status&&t.message){const e=function(e){const t=e.toLowerCase().replace(/_/g,"-");return Object.values(q).indexOf(t)>=0?t:q.UNKNOWN}(t.status);o(new N(e,t.message))}else o(new N(q.UNKNOWN,"Server responded with status "+u.getStatus()))}else o(new N(q.UNAVAILABLE,"Connection failed."));break;default:S()}}finally{v(aa,`RPC '${e}' ${i} completed.`)}}));const c=JSON.stringify(s);v(aa,`RPC '${e}' ${i} sending request:`,s),u.send(t,"POST",c,n,15)}))}Ro(e,t,n){const s=sa(),i=[this.mo,"/","google.firestore.v1.Firestore","/",e,"/channel"],r=Object(h.j)(),o=Object(h.k)(),u={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling},c=this.longPollingOptions.timeoutSeconds;void 0!==c&&(u.longPollingTimeout=Math.round(1e3*c)),this.useFetchStreams&&(u.xmlHttpFactory=new h.d({})),this.Eo(u.initMessageHeaders,t,n),u.encodeInitMessageHeaders=!0;const a=i.join("");v(aa,`Creating RPC '${e}' stream ${s}: ${a}`,u);const l=r.createWebChannel(a,u);let d=!1,f=!1;const m=new oa({ro:t=>{f?v(aa,`Not sending because RPC '${e}' stream ${s} is closed:`,t):(d||(v(aa,`Opening RPC '${e}' stream ${s} transport.`),l.open(),d=!0),v(aa,`RPC '${e}' stream ${s} sending:`,t),l.send(t))},oo:()=>l.close()}),y=(e,t,n)=>{e.listen(t,(e=>{try{n(e)}catch(e){setTimeout((()=>{throw e}),0)}}))};return y(l,h.h.EventType.OPEN,(()=>{f||v(aa,`RPC '${e}' stream ${s} transport opened.`)})),y(l,h.h.EventType.CLOSE,(()=>{f||(f=!0,v(aa,`RPC '${e}' stream ${s} transport closed`),m.wo())})),y(l,h.h.EventType.ERROR,(t=>{f||(f=!0,E(aa,`RPC '${e}' stream ${s} transport errored:`,t),m.wo(new N(q.UNAVAILABLE,"The operation could not be completed")))})),y(l,h.h.EventType.MESSAGE,(t=>{var n;if(!f){const i=t.data[0];x(!!i);const r=i,o=r.error||(null===(n=r[0])||void 0===n?void 0:n.error);if(o){v(aa,`RPC '${e}' stream ${s} received error:`,o);const t=o.status;let n=function(e){const t=zr[e];if(void 0!==t)return $r(t)}(t),i=o.message;void 0===n&&(n=q.INTERNAL,i="Unknown error status: "+t+" with message "+o.message),f=!0,m.wo(new N(n,i)),l.close()}else v(aa,`RPC '${e}' stream ${s} received:`,i),m._o(i)}})),y(o,h.b.STAT_EVENT,(t=>{t.stat===h.g.PROXY?v(aa,`RPC '${e}' stream ${s} detected buffering proxy`):t.stat===h.g.NOPROXY&&v(aa,`RPC '${e}' stream ${s} detected no buffering proxy`)})),setTimeout((()=>{m.fo()}),0),m}}function ua(){return"undefined"!=typeof window?window:null}function la(){return"undefined"!=typeof document?document:null}function ha(e){return new hs(e,!0)}class da{constructor(e,t,n=1e3,s=1.5,i=6e4){this.ii=e,this.timerId=t,this.Po=n,this.bo=s,this.Vo=i,this.So=0,this.Do=null,this.Co=Date.now(),this.reset()}reset(){this.So=0}xo(){this.So=this.Vo}No(e){this.cancel();const t=Math.floor(this.So+this.ko()),n=Math.max(0,Date.now()-this.Co),s=Math.max(0,t-n);s>0&&v("ExponentialBackoff",`Backing off for ${s} ms (base delay: ${this.So} ms, delay with jitter: ${t} ms, last attempt: ${n} ms ago)`),this.Do=this.ii.enqueueAfterDelay(this.timerId,s,(()=>(this.Co=Date.now(),e()))),this.So*=this.bo,this.So<this.Po&&(this.So=this.Po),this.So>this.Vo&&(this.So=this.Vo)}Mo(){null!==this.Do&&(this.Do.skipDelay(),this.Do=null)}cancel(){null!==this.Do&&(this.Do.cancel(),this.Do=null)}ko(){return(Math.random()-.5)*this.So}}class fa{constructor(e,t,n,s,i,r,o,u){this.ii=e,this.$o=n,this.Oo=s,this.connection=i,this.authCredentialsProvider=r,this.appCheckCredentialsProvider=o,this.listener=u,this.state=0,this.Fo=0,this.Bo=null,this.Lo=null,this.stream=null,this.qo=new da(e,t)}Uo(){return 1===this.state||5===this.state||this.Ko()}Ko(){return 2===this.state||3===this.state}start(){4!==this.state?this.auth():this.Go()}async stop(){this.Uo()&&await this.close(0)}Qo(){this.state=0,this.qo.reset()}jo(){this.Ko()&&null===this.Bo&&(this.Bo=this.ii.enqueueAfterDelay(this.$o,6e4,(()=>this.zo())))}Wo(e){this.Ho(),this.stream.send(e)}async zo(){if(this.Ko())return this.close(0)}Ho(){this.Bo&&(this.Bo.cancel(),this.Bo=null)}Jo(){this.Lo&&(this.Lo.cancel(),this.Lo=null)}async close(e,t){this.Ho(),this.Jo(),this.qo.cancel(),this.Fo++,4!==e?this.qo.reset():t&&t.code===q.RESOURCE_EXHAUSTED?(I(t.toString()),I("Using maximum backoff delay to prevent overloading the backend."),this.qo.xo()):t&&t.code===q.UNAUTHENTICATED&&3!==this.state&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),null!==this.stream&&(this.Yo(),this.stream.close(),this.stream=null),this.state=e,await this.listener.ao(t)}Yo(){}auth(){this.state=1;const e=this.Xo(this.Fo),t=this.Fo;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then((([e,n])=>{this.Fo===t&&this.Zo(e,n)}),(t=>{e((()=>{const e=new N(q.UNKNOWN,"Fetching auth token failed: "+t.message);return this.tu(e)}))}))}Zo(e,t){const n=this.Xo(this.Fo);this.stream=this.eu(e,t),this.stream.uo((()=>{n((()=>(this.state=2,this.Lo=this.ii.enqueueAfterDelay(this.Oo,1e4,(()=>(this.Ko()&&(this.state=3),Promise.resolve()))),this.listener.uo())))})),this.stream.ao((e=>{n((()=>this.tu(e)))})),this.stream.onMessage((e=>{n((()=>this.onMessage(e)))}))}Go(){this.state=5,this.qo.No((async()=>{this.state=0,this.start()}))}tu(e){return v("PersistentStream",`close with error: ${e}`),this.stream=null,this.close(4,e)}Xo(e){return t=>{this.ii.enqueueAndForget((()=>this.Fo===e?t():(v("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve())))}}}class ma extends fa{constructor(e,t,n,s,i,r){super(e,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",t,n,s,r),this.serializer=i}eu(e,t){return this.connection.Ro("Listen",e,t)}onMessage(e){this.qo.reset();const t=function(e,t){let n;if("targetChange"in t){t.targetChange;const s=function(e){return"NO_CHANGE"===e?0:"ADD"===e?1:"REMOVE"===e?2:"CURRENT"===e?3:"RESET"===e?4:S()}(t.targetChange.targetChangeType||"NO_CHANGE"),i=t.targetChange.targetIds||[],r=function(e,t){return e.useProto3Json?(x(void 0===t||"string"==typeof t),ht.fromBase64String(t||"")):(x(void 0===t||t instanceof Uint8Array),ht.fromUint8Array(t||new Uint8Array))}(e,t.targetChange.resumeToken),o=t.targetChange.cause,u=o&&function(e){const t=void 0===e.code?q.UNKNOWN:$r(e.code);return new N(t,e.message||"")}(o);n=new rs(s,i,r,u||null)}else if("documentChange"in t){t.documentChange;const s=t.documentChange;s.document,s.document.name,s.document.updateTime;const i=Is(e,s.document.name),r=ps(s.document.updateTime),o=s.document.createTime?ps(s.document.createTime):rt.min(),u=new Gt({mapValue:{fields:s.document.fields}}),c=$t.newFoundDocument(i,r,o,u),a=s.targetIds||[],l=s.removedTargetIds||[];n=new ts(a,l,c.key,c)}else if("documentDelete"in t){t.documentDelete;const s=t.documentDelete;s.document;const i=Is(e,s.document),r=s.readTime?ps(s.readTime):rt.min(),o=$t.newNoDocument(i,r),u=s.removedTargetIds||[];n=new ts([],u,o.key,o)}else if("documentRemove"in t){t.documentRemove;const s=t.documentRemove;s.document;const i=Is(e,s.document),r=s.removedTargetIds||[];n=new ts([],r,i,null)}else{if(!("filter"in t))return S();{t.filter;const e=t.filter;e.targetId;const{count:s=0,unchangedNames:i}=e,r=new Br(s,i),o=e.targetId;n=new ns(o,r)}}return n}(this.serializer,e),n=function(e){if(!("targetChange"in e))return rt.min();const t=e.targetChange;return t.targetIds&&t.targetIds.length?rt.min():t.readTime?ps(t.readTime):rt.min()}(e);return this.listener.nu(t,n)}su(e){const t={};t.database=Ts(this.serializer),t.addTarget=function(e,t){let n;const s=t.target;if(n=bn(s)?{documents:Cs(e,s)}:{query:As(e,s)},n.targetId=t.targetId,t.resumeToken.approximateByteSize()>0){n.resumeToken=ms(e,t.resumeToken);const s=ds(e,t.expectedCount);null!==s&&(n.expectedCount=s)}else if(t.snapshotVersion.compareTo(rt.min())>0){n.readTime=fs(e,t.snapshotVersion.toTimestamp());const s=ds(e,t.expectedCount);null!==s&&(n.expectedCount=s)}return n}(this.serializer,e);const n=function(e,t){const n=function(e){switch(e){case"TargetPurposeListen":return null;case"TargetPurposeExistenceFilterMismatch":return"existence-filter-mismatch";case"TargetPurposeExistenceFilterMismatchBloom":return"existence-filter-mismatch-bloom";case"TargetPurposeLimboResolution":return"limbo-document";default:return S()}}(t.purpose);return null==n?null:{"goog-listen-tags":n}}(this.serializer,e);n&&(t.labels=n),this.Wo(t)}iu(e){const t={};t.database=Ts(this.serializer),t.removeTarget=e,this.Wo(t)}}class ga extends fa{constructor(e,t,n,s,i,r){super(e,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",t,n,s,r),this.serializer=i,this.ru=!1}get ou(){return this.ru}start(){this.ru=!1,this.lastStreamToken=void 0,super.start()}Yo(){this.ru&&this.uu([])}eu(e,t){return this.connection.Ro("Write",e,t)}onMessage(e){if(x(!!e.streamToken),this.lastStreamToken=e.streamToken,this.ru){this.qo.reset();const t=function(e,t){return e&&e.length>0?(x(void 0!==t),e.map((e=>function(e,t){let n=e.updateTime?ps(e.updateTime):ps(t);return n.isEqual(rt.min())&&(n=ps(t)),new Er(n,e.transformResults||[])}(e,t)))):[]}(e.writeResults,e.commitTime),n=ps(e.commitTime);return this.listener.cu(n,t)}return x(!e.writeResults||0===e.writeResults.length),this.ru=!0,this.listener.au()}hu(){const e={};e.database=Ts(this.serializer),this.Wo(e)}uu(e){const t={streamToken:this.lastStreamToken,writes:e.map((e=>Ds(this.serializer,e)))};this.Wo(t)}}class pa extends class{}{constructor(e,t,n,s){super(),this.authCredentials=e,this.appCheckCredentials=t,this.connection=n,this.serializer=s,this.lu=!1}fu(){if(this.lu)throw new N(q.FAILED_PRECONDITION,"The client has already been terminated.")}Io(e,t,n){return this.fu(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((([s,i])=>this.connection.Io(e,t,n,s,i))).catch((e=>{throw"FirebaseError"===e.name?(e.code===q.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new N(q.UNKNOWN,e.toString())}))}vo(e,t,n,s){return this.fu(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((([i,r])=>this.connection.vo(e,t,n,i,r,s))).catch((e=>{throw"FirebaseError"===e.name?(e.code===q.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new N(q.UNKNOWN,e.toString())}))}terminate(){this.lu=!0}}class ya{constructor(e,t){this.asyncQueue=e,this.onlineStateHandler=t,this.state="Unknown",this.wu=0,this._u=null,this.mu=!0}gu(){0===this.wu&&(this.yu("Unknown"),this._u=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,(()=>(this._u=null,this.pu("Backend didn't respond within 10 seconds."),this.yu("Offline"),Promise.resolve()))))}Iu(e){"Online"===this.state?this.yu("Unknown"):(this.wu++,this.wu>=1&&(this.Tu(),this.pu(`Connection failed 1 times. Most recent error: ${e.toString()}`),this.yu("Offline")))}set(e){this.Tu(),this.wu=0,"Online"===e&&(this.mu=!1),this.yu(e)}yu(e){e!==this.state&&(this.state=e,this.onlineStateHandler(e))}pu(e){const t=`Could not reach Cloud Firestore backend. ${e}\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.mu?(I(t),this.mu=!1):v("OnlineStateTracker",t)}Tu(){null!==this._u&&(this._u.cancel(),this._u=null)}}class wa{constructor(e,t,n,s,i){this.localStore=e,this.datastore=t,this.asyncQueue=n,this.remoteSyncer={},this.Eu=[],this.Au=new Map,this.vu=new Set,this.Ru=[],this.Pu=i,this.Pu.Yr((e=>{n.enqueueAndForget((async()=>{Da(this)&&(v("RemoteStore","Restarting streams for network reachability change."),await async function(e){const t=D(e);t.vu.add(4),await Ia(t),t.bu.set("Unknown"),t.vu.delete(4),await va(t)}(this))}))})),this.bu=new ya(n,s)}}async function va(e){if(Da(e))for(const t of e.Ru)await t(!0)}async function Ia(e){for(const t of e.Ru)await t(!1)}function ba(e,t){const n=D(e);n.Au.has(t.targetId)||(n.Au.set(t.targetId,t),_a(n)?xa(n):$a(n).Ko()&&Ta(n,t))}function Ea(e,t){const n=D(e),s=$a(n);n.Au.delete(t),s.Ko()&&Sa(n,t),0===n.Au.size&&(s.Ko()?s.jo():Da(n)&&n.bu.set("Unknown"))}function Ta(e,t){if(e.Vu.qt(t.targetId),t.resumeToken.approximateByteSize()>0||t.snapshotVersion.compareTo(rt.min())>0){const n=e.remoteSyncer.getRemoteKeysForTarget(t.targetId).size;t=t.withExpectedCount(n)}$a(e).su(t)}function Sa(e,t){e.Vu.qt(t),$a(e).iu(t)}function xa(e){e.Vu=new is({getRemoteKeysForTarget:t=>e.remoteSyncer.getRemoteKeysForTarget(t),le:t=>e.Au.get(t)||null,ue:()=>e.datastore.serializer.databaseId}),$a(e).start(),e.bu.gu()}function _a(e){return Da(e)&&!$a(e).Uo()&&e.Au.size>0}function Da(e){return 0===D(e).vu.size}function Na(e){e.Vu=void 0}async function Ca(e){e.Au.forEach(((t,n)=>{Ta(e,t)}))}async function Aa(e,t){Na(e),_a(e)?(e.bu.Iu(t),xa(e)):e.bu.set("Unknown")}async function ka(e,t,n){if(e.bu.set("Online"),t instanceof rs&&2===t.state&&t.cause)try{await async function(e,t){const n=t.cause;for(const s of t.targetIds)e.Au.has(s)&&(await e.remoteSyncer.rejectListen(s,n),e.Au.delete(s),e.Vu.removeTarget(s))}(e,t)}catch(n){v("RemoteStore","Failed to remove targets %s: %s ",t.targetIds.join(","),n),await Ra(e,n)}else if(t instanceof ts?e.Vu.Ht(t):t instanceof ns?e.Vu.ne(t):e.Vu.Xt(t),!n.isEqual(rt.min()))try{const t=await Oo(e.localStore);n.compareTo(t)>=0&&await function(e,t){const n=e.Vu.ce(t);return n.targetChanges.forEach(((n,s)=>{if(n.resumeToken.approximateByteSize()>0){const i=e.Au.get(s);i&&e.Au.set(s,i.withResumeToken(n.resumeToken,t))}})),n.targetMismatches.forEach(((t,n)=>{const s=e.Au.get(t);if(!s)return;e.Au.set(t,s.withResumeToken(ht.EMPTY_BYTE_STRING,s.snapshotVersion)),Sa(e,t);const i=new Us(s.target,t,n,s.sequenceNumber);Ta(e,i)})),e.remoteSyncer.applyRemoteEvent(n)}(e,n)}catch(t){v("RemoteStore","Failed to raise snapshot:",t),await Ra(e,t)}}async function Ra(e,t,n){if(!de(t))throw t;e.vu.add(1),await Ia(e),e.bu.set("Offline"),n||(n=()=>Oo(e.localStore)),e.asyncQueue.enqueueRetryable((async()=>{v("RemoteStore","Retrying IndexedDB access"),await n(),e.vu.delete(1),await va(e)}))}function Fa(e,t){return t().catch((n=>Ra(e,n,t)))}async function Va(e){const t=D(e),n=ja(t);let s=t.Eu.length>0?t.Eu[t.Eu.length-1].batchId:-1;for(;Oa(t);)try{const e=await Lo(t.localStore,s);if(null===e){0===t.Eu.length&&n.jo();break}s=e.batchId,Ma(t,e)}catch(e){await Ra(t,e)}La(t)&&Pa(t)}function Oa(e){return Da(e)&&e.Eu.length<10}function Ma(e,t){e.Eu.push(t);const n=ja(e);n.Ko()&&n.ou&&n.uu(t.mutations)}function La(e){return Da(e)&&!ja(e).Uo()&&e.Eu.length>0}function Pa(e){ja(e).start()}async function qa(e){ja(e).hu()}async function Ua(e){const t=ja(e);for(const n of e.Eu)t.uu(n.mutations)}async function Ba(e,t,n){const s=e.Eu.shift(),i=qr.from(s,t,n);await Fa(e,(()=>e.remoteSyncer.applySuccessfulWrite(i))),await Va(e)}async function za(e,t){t&&ja(e).ou&&await async function(e,t){if(Kr(n=t.code)&&n!==q.ABORTED){const n=e.Eu.shift();ja(e).Qo(),await Fa(e,(()=>e.remoteSyncer.rejectFailedWrite(n.batchId,t))),await Va(e)}var n}(e,t),La(e)&&Pa(e)}async function Ga(e,t){const n=D(e);n.asyncQueue.verifyOperationInProgress(),v("RemoteStore","RemoteStore received new credentials");const s=Da(n);n.vu.add(3),await Ia(n),s&&n.bu.set("Unknown"),await n.remoteSyncer.handleCredentialChange(t),n.vu.delete(3),await va(n)}async function Ka(e,t){const n=D(e);t?(n.vu.delete(2),await va(n)):t||(n.vu.add(2),await Ia(n),n.bu.set("Unknown"))}function $a(e){return e.Su||(e.Su=function(e,t,n){const s=D(e);return s.fu(),new ma(t,s.connection,s.authCredentials,s.appCheckCredentials,s.serializer,n)}(e.datastore,e.asyncQueue,{uo:Ca.bind(null,e),ao:Aa.bind(null,e),nu:ka.bind(null,e)}),e.Ru.push((async t=>{t?(e.Su.Qo(),_a(e)?xa(e):e.bu.set("Unknown")):(await e.Su.stop(),Na(e))}))),e.Su}function ja(e){return e.Du||(e.Du=function(e,t,n){const s=D(e);return s.fu(),new ga(t,s.connection,s.authCredentials,s.appCheckCredentials,s.serializer,n)}(e.datastore,e.asyncQueue,{uo:qa.bind(null,e),ao:za.bind(null,e),au:Ua.bind(null,e),cu:Ba.bind(null,e)}),e.Ru.push((async t=>{t?(e.Du.Qo(),await Va(e)):(await e.Du.stop(),e.Eu.length>0&&(v("RemoteStore",`Stopping write stream with ${e.Eu.length} pending writes`),e.Eu=[]))}))),e.Du}class Qa{constructor(e,t,n,s,i){this.asyncQueue=e,this.timerId=t,this.targetTimeMs=n,this.op=s,this.removalCallback=i,this.deferred=new C,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch((e=>{}))}static createAndSchedule(e,t,n,s,i){const r=Date.now()+n,o=new Qa(e,t,r,s,i);return o.start(n),o}start(e){this.timerHandle=setTimeout((()=>this.handleDelayElapsed()),e)}skipDelay(){return this.handleDelayElapsed()}cancel(e){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new N(q.CANCELLED,"Operation cancelled"+(e?": "+e:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget((()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then((e=>this.deferred.resolve(e)))):Promise.resolve()))}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function Wa(e,t){if(I("AsyncQueue",`${t}: ${e}`),de(e))return new N(q.UNAVAILABLE,`${t}: ${e}`);throw e}class Ha{constructor(e){this.comparator=e?(t,n)=>e(t,n)||H.comparator(t.key,n.key):(e,t)=>H.comparator(e.key,t.key),this.keyedMap=Qn(),this.sortedSet=new tt(this.comparator)}static emptySet(e){return new Ha(e.comparator)}has(e){return null!=this.keyedMap.get(e)}get(e){return this.keyedMap.get(e)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(e){const t=this.keyedMap.get(e);return t?this.sortedSet.indexOf(t):-1}get size(){return this.sortedSet.size}forEach(e){this.sortedSet.inorderTraversal(((t,n)=>(e(t),!1)))}add(e){const t=this.delete(e.key);return t.copy(t.keyedMap.insert(e.key,e),t.sortedSet.insert(e,null))}delete(e){const t=this.get(e);return t?this.copy(this.keyedMap.remove(e),this.sortedSet.remove(t)):this}isEqual(e){if(!(e instanceof Ha))return!1;if(this.size!==e.size)return!1;const t=this.sortedSet.getIterator(),n=e.sortedSet.getIterator();for(;t.hasNext();){const e=t.getNext().key,s=n.getNext().key;if(!e.isEqual(s))return!1}return!0}toString(){const e=[];return this.forEach((t=>{e.push(t.toString())})),0===e.length?"DocumentSet ()":"DocumentSet (\n  "+e.join("  \n")+"\n)"}copy(e,t){const n=new Ha;return n.comparator=this.comparator,n.keyedMap=e,n.sortedSet=t,n}}class Ya{constructor(){this.Cu=new tt(H.comparator)}track(e){const t=e.doc.key,n=this.Cu.get(t);n?0!==e.type&&3===n.type?this.Cu=this.Cu.insert(t,e):3===e.type&&1!==n.type?this.Cu=this.Cu.insert(t,{type:n.type,doc:e.doc}):2===e.type&&2===n.type?this.Cu=this.Cu.insert(t,{type:2,doc:e.doc}):2===e.type&&0===n.type?this.Cu=this.Cu.insert(t,{type:0,doc:e.doc}):1===e.type&&0===n.type?this.Cu=this.Cu.remove(t):1===e.type&&2===n.type?this.Cu=this.Cu.insert(t,{type:1,doc:n.doc}):0===e.type&&1===n.type?this.Cu=this.Cu.insert(t,{type:2,doc:e.doc}):S():this.Cu=this.Cu.insert(t,e)}xu(){const e=[];return this.Cu.inorderTraversal(((t,n)=>{e.push(n)})),e}}class Xa{constructor(e,t,n,s,i,r,o,u,c){this.query=e,this.docs=t,this.oldDocs=n,this.docChanges=s,this.mutatedKeys=i,this.fromCache=r,this.syncStateChanged=o,this.excludesMetadataChanges=u,this.hasCachedResults=c}static fromInitialDocuments(e,t,n,s,i){const r=[];return t.forEach((e=>{r.push({type:0,doc:e})})),new Xa(e,t,Ha.emptySet(t),r,n,s,!0,!1,i)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(e){if(!(this.fromCache===e.fromCache&&this.hasCachedResults===e.hasCachedResults&&this.syncStateChanged===e.syncStateChanged&&this.mutatedKeys.isEqual(e.mutatedKeys)&&Mn(this.query,e.query)&&this.docs.isEqual(e.docs)&&this.oldDocs.isEqual(e.oldDocs)))return!1;const t=this.docChanges,n=e.docChanges;if(t.length!==n.length)return!1;for(let e=0;e<t.length;e++)if(t[e].type!==n[e].type||!t[e].doc.isEqual(n[e].doc))return!1;return!0}}class Ja{constructor(){this.Nu=void 0,this.listeners=[]}}class Za{constructor(){this.queries=new Gn((e=>Ln(e)),Mn),this.onlineState="Unknown",this.ku=new Set}}async function ec(e,t){const n=D(e),s=t.query;let i=!1,r=n.queries.get(s);if(r||(i=!0,r=new Ja),i)try{r.Nu=await n.onListen(s)}catch(e){const n=Wa(e,`Initialization of query '${Pn(t.query)}' failed`);return void t.onError(n)}n.queries.set(s,r),r.listeners.push(t),t.Mu(n.onlineState),r.Nu&&t.$u(r.Nu)&&sc(n)}async function tc(e,t){const n=D(e),s=t.query;let i=!1;const r=n.queries.get(s);if(r){const e=r.listeners.indexOf(t);e>=0&&(r.listeners.splice(e,1),i=0===r.listeners.length)}if(i)return n.queries.delete(s),n.onUnlisten(s)}function nc(e,t){const n=D(e);let s=!1;for(const e of t){const t=e.query,i=n.queries.get(t);if(i){for(const t of i.listeners)t.$u(e)&&(s=!0);i.Nu=e}}s&&sc(n)}function rc(e,t,n){const s=D(e),i=s.queries.get(t);if(i)for(const e of i.listeners)e.onError(n);s.queries.delete(t)}function sc(e){e.ku.forEach((e=>{e.next()}))}class ic{constructor(e,t,n){this.query=e,this.Ou=t,this.Fu=!1,this.Bu=null,this.onlineState="Unknown",this.options=n||{}}$u(e){if(!this.options.includeMetadataChanges){const t=[];for(const n of e.docChanges)3!==n.type&&t.push(n);e=new Xa(e.query,e.docs,e.oldDocs,t,e.mutatedKeys,e.fromCache,e.syncStateChanged,!0,e.hasCachedResults)}let t=!1;return this.Fu?this.Lu(e)&&(this.Ou.next(e),t=!0):this.qu(e,this.onlineState)&&(this.Uu(e),t=!0),this.Bu=e,t}onError(e){this.Ou.error(e)}Mu(e){this.onlineState=e;let t=!1;return this.Bu&&!this.Fu&&this.qu(this.Bu,e)&&(this.Uu(this.Bu),t=!0),t}qu(e,t){if(!e.fromCache)return!0;const n="Offline"!==t;return(!this.options.Ku||!n)&&(!e.docs.isEmpty()||e.hasCachedResults||"Offline"===t)}Lu(e){if(e.docChanges.length>0)return!0;const t=this.Bu&&this.Bu.hasPendingWrites!==e.hasPendingWrites;return!(!e.syncStateChanged&&!t)&&!0===this.options.includeMetadataChanges}Uu(e){e=Xa.fromInitialDocuments(e.query,e.docs,e.mutatedKeys,e.fromCache,e.hasCachedResults),this.Fu=!0,this.Ou.next(e)}}class oc{constructor(e,t){this.Gu=e,this.byteLength=t}Qu(){return"metadata"in this.Gu}}class ac{constructor(e){this.serializer=e}rr(e){return Is(this.serializer,e)}ur(e){return e.metadata.exists?_s(this.serializer,e.document,!1):$t.newNoDocument(this.rr(e.metadata.name),this.cr(e.metadata.readTime))}cr(e){return ps(e)}}class cc{constructor(e,t,n){this.ju=e,this.localStore=t,this.serializer=n,this.queries=[],this.documents=[],this.collectionGroups=new Set,this.progress=uc(e)}zu(e){this.progress.bytesLoaded+=e.byteLength;let t=this.progress.documentsLoaded;if(e.Gu.namedQuery)this.queries.push(e.Gu.namedQuery);else if(e.Gu.documentMetadata){this.documents.push({metadata:e.Gu.documentMetadata}),e.Gu.documentMetadata.exists||++t;const n=j.fromString(e.Gu.documentMetadata.name);this.collectionGroups.add(n.get(n.length-2))}else e.Gu.document&&(this.documents[this.documents.length-1].document=e.Gu.document,++t);return t!==this.progress.documentsLoaded?(this.progress.documentsLoaded=t,Object.assign({},this.progress)):null}Wu(e){const t=new Map,n=new ac(this.serializer);for(const s of e)if(s.metadata.queries){const e=n.rr(s.metadata.name);for(const n of s.metadata.queries){const s=(t.get(n)||er()).add(e);t.set(n,s)}}return t}async complete(){const e=await async function(e,t,n,s){const i=D(e);let r=er(),o=$n();for(const e of n){const n=t.rr(e.metadata.name);e.document&&(r=r.add(n));const s=t.ur(e);s.setReadTime(t.cr(e.metadata.readTime)),o=o.insert(n,s)}const u=i.Zi.newChangeBuffer({trackRemovals:!0}),c=await Po(i,function(e){return Fn(Dn(j.fromString(`__bundle__/docs/${e}`)))}(s));return i.persistence.runTransaction("Apply bundle documents","readwrite",(e=>Mo(e,u,o).next((t=>(u.apply(e),t))).next((t=>i.Bs.removeMatchingKeysForTargetId(e,c.targetId).next((()=>i.Bs.addMatchingKeys(e,r,c.targetId))).next((()=>i.localDocuments.getLocalViewOfDocuments(e,t.nr,t.sr))).next((()=>t.nr))))))}(this.localStore,new ac(this.serializer),this.documents,this.ju.id),t=this.Wu(this.documents);for(const e of this.queries)await Ko(this.localStore,e,t.get(e.name));return this.progress.taskState="Success",{progress:this.progress,Hu:this.collectionGroups,Ju:e}}}function uc(e){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:e.totalDocuments,totalBytes:e.totalBytes}}class lc{constructor(e){this.key=e}}class hc{constructor(e){this.key=e}}class dc{constructor(e,t){this.query=e,this.Yu=t,this.Xu=null,this.hasCachedResults=!1,this.current=!1,this.Zu=er(),this.mutatedKeys=er(),this.tc=Bn(e),this.ec=new Ha(this.tc)}get nc(){return this.Yu}sc(e,t){const n=t?t.ic:new Ya,s=t?t.ec:this.ec;let i=t?t.mutatedKeys:this.mutatedKeys,r=s,o=!1;const u="F"===this.query.limitType&&s.size===this.query.limit?s.last():null,c="L"===this.query.limitType&&s.size===this.query.limit?s.first():null;if(e.inorderTraversal(((e,t)=>{const a=s.get(e),l=qn(this.query,t)?t:null,h=!!a&&this.mutatedKeys.has(a.key),d=!!l&&(l.hasLocalMutations||this.mutatedKeys.has(l.key)&&l.hasCommittedMutations);let f=!1;a&&l?a.data.isEqual(l.data)?h!==d&&(n.track({type:3,doc:l}),f=!0):this.rc(a,l)||(n.track({type:2,doc:l}),f=!0,(u&&this.tc(l,u)>0||c&&this.tc(l,c)<0)&&(o=!0)):!a&&l?(n.track({type:0,doc:l}),f=!0):a&&!l&&(n.track({type:1,doc:a}),f=!0,(u||c)&&(o=!0)),f&&(l?(r=r.add(l),i=d?i.add(e):i.delete(e)):(r=r.delete(e),i=i.delete(e)))})),null!==this.query.limit)for(;r.size>this.query.limit;){const e="F"===this.query.limitType?r.last():r.first();r=r.delete(e.key),i=i.delete(e.key),n.track({type:1,doc:e})}return{ec:r,ic:n,zi:o,mutatedKeys:i}}rc(e,t){return e.hasLocalMutations&&t.hasCommittedMutations&&!t.hasLocalMutations}applyChanges(e,t,n){const s=this.ec;this.ec=e.ec,this.mutatedKeys=e.mutatedKeys;const i=e.ic.xu();i.sort(((e,t)=>function(e,t){const n=e=>{switch(e){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return S()}};return n(e)-n(t)}(e.type,t.type)||this.tc(e.doc,t.doc))),this.oc(n);const r=t?this.uc():[],o=0===this.Zu.size&&this.current?1:0,u=o!==this.Xu;return this.Xu=o,0!==i.length||u?{snapshot:new Xa(this.query,e.ec,s,i,e.mutatedKeys,0===o,u,!1,!!n&&n.resumeToken.approximateByteSize()>0),cc:r}:{cc:r}}Mu(e){return this.current&&"Offline"===e?(this.current=!1,this.applyChanges({ec:this.ec,ic:new Ya,mutatedKeys:this.mutatedKeys,zi:!1},!1)):{cc:[]}}ac(e){return!this.Yu.has(e)&&!!this.ec.has(e)&&!this.ec.get(e).hasLocalMutations}oc(e){e&&(e.addedDocuments.forEach((e=>this.Yu=this.Yu.add(e))),e.modifiedDocuments.forEach((e=>{})),e.removedDocuments.forEach((e=>this.Yu=this.Yu.delete(e))),this.current=e.current)}uc(){if(!this.current)return[];const e=this.Zu;this.Zu=er(),this.ec.forEach((e=>{this.ac(e.key)&&(this.Zu=this.Zu.add(e.key))}));const t=[];return e.forEach((e=>{this.Zu.has(e)||t.push(new hc(e))})),this.Zu.forEach((n=>{e.has(n)||t.push(new lc(n))})),t}hc(e){this.Yu=e.ir,this.Zu=er();const t=this.sc(e.documents);return this.applyChanges(t,!0)}lc(){return Xa.fromInitialDocuments(this.query,this.ec,this.mutatedKeys,0===this.Xu,this.hasCachedResults)}}class fc{constructor(e,t,n){this.query=e,this.targetId=t,this.view=n}}class mc{constructor(e){this.key=e,this.fc=!1}}class gc{constructor(e,t,n,s,i,r){this.localStore=e,this.remoteStore=t,this.eventManager=n,this.sharedClientState=s,this.currentUser=i,this.maxConcurrentLimboResolutions=r,this.dc={},this.wc=new Gn((e=>Ln(e)),Mn),this._c=new Map,this.mc=new Set,this.gc=new tt(H.comparator),this.yc=new Map,this.Ic=new mo,this.Tc={},this.Ec=new Map,this.Ac=zi.Mn(),this.onlineState="Unknown",this.vc=void 0}get isPrimaryClient(){return!0===this.vc}}async function pc(e,t){const n=zc(e);let s,i;const r=n.wc.get(t);if(r)s=r.targetId,n.sharedClientState.addLocalQueryTarget(s),i=r.view.lc();else{const e=await Po(n.localStore,Fn(t)),r=n.sharedClientState.addLocalQueryTarget(e.targetId);s=e.targetId,i=await yc(n,t,s,"current"===r,e.resumeToken),n.isPrimaryClient&&ba(n.remoteStore,e)}return i}async function yc(e,t,n,s,i){e.Rc=(t,n,s)=>async function(e,t,n,s){let i=t.view.sc(n);i.zi&&(i=await Uo(e.localStore,t.query,!1).then((({documents:e})=>t.view.sc(e,i))));const r=s&&s.targetChanges.get(t.targetId),o=t.view.applyChanges(i,e.isPrimaryClient,r);return Nc(e,t.targetId,o.cc),o.snapshot}(e,t,n,s);const r=await Uo(e.localStore,t,!0),o=new dc(t,r.ir),u=o.sc(r.documents),c=es.createSynthesizedTargetChangeForCurrentChange(n,s&&"Offline"!==e.onlineState,i),a=o.applyChanges(u,e.isPrimaryClient,c);Nc(e,n,a.cc);const l=new fc(t,n,o);return e.wc.set(t,l),e._c.has(n)?e._c.get(n).push(t):e._c.set(n,[t]),a.snapshot}async function wc(e,t){const n=D(e),s=n.wc.get(t),i=n._c.get(s.targetId);if(i.length>1)return n._c.set(s.targetId,i.filter((e=>!Mn(e,t)))),void n.wc.delete(t);n.isPrimaryClient?(n.sharedClientState.removeLocalQueryTarget(s.targetId),n.sharedClientState.isActiveQueryTarget(s.targetId)||await qo(n.localStore,s.targetId,!1).then((()=>{n.sharedClientState.clearQueryState(s.targetId),Ea(n.remoteStore,s.targetId),_c(n,s.targetId)})).catch(oe)):(_c(n,s.targetId),await qo(n.localStore,s.targetId,!0))}async function vc(e,t){const n=D(e);try{const e=await function(e,t){const n=D(e),s=t.snapshotVersion;let i=n.Ji;return n.persistence.runTransaction("Apply remote event","readwrite-primary",(e=>{const r=n.Zi.newChangeBuffer({trackRemovals:!0});i=n.Ji;const o=[];t.targetChanges.forEach(((r,u)=>{const c=i.get(u);if(!c)return;o.push(n.Bs.removeMatchingKeys(e,r.removedDocuments,u).next((()=>n.Bs.addMatchingKeys(e,r.addedDocuments,u))));let a=c.withSequenceNumber(e.currentSequenceNumber);null!==t.targetMismatches.get(u)?a=a.withResumeToken(ht.EMPTY_BYTE_STRING,rt.min()).withLastLimboFreeSnapshotVersion(rt.min()):r.resumeToken.approximateByteSize()>0&&(a=a.withResumeToken(r.resumeToken,s)),i=i.insert(u,a),function(e,t,n){return 0===e.resumeToken.approximateByteSize()||t.snapshotVersion.toMicroseconds()-e.snapshotVersion.toMicroseconds()>=3e8||n.addedDocuments.size+n.modifiedDocuments.size+n.removedDocuments.size>0}(c,a,r)&&o.push(n.Bs.updateTargetData(e,a))}));let u=$n(),c=er();if(t.documentUpdates.forEach((s=>{t.resolvedLimboDocuments.has(s)&&o.push(n.persistence.referenceDelegate.updateLimboDocument(e,s))})),o.push(Mo(e,r,t.documentUpdates).next((e=>{u=e.nr,c=e.sr}))),!s.isEqual(rt.min())){const t=n.Bs.getLastRemoteSnapshotVersion(e).next((t=>n.Bs.setTargetsMetadata(e,e.currentSequenceNumber,s)));o.push(t)}return ae.waitFor(o).next((()=>r.apply(e))).next((()=>n.localDocuments.getLocalViewOfDocuments(e,u,c))).next((()=>u))})).then((e=>(n.Ji=i,e)))}(n.localStore,t);t.targetChanges.forEach(((e,t)=>{const s=n.yc.get(t);s&&(x(e.addedDocuments.size+e.modifiedDocuments.size+e.removedDocuments.size<=1),e.addedDocuments.size>0?s.fc=!0:e.modifiedDocuments.size>0?x(s.fc):e.removedDocuments.size>0&&(x(s.fc),s.fc=!1))})),await kc(n,e,t)}catch(e){await oe(e)}}function Ic(e,t,n){const s=D(e);if(s.isPrimaryClient&&0===n||!s.isPrimaryClient&&1===n){const e=[];s.wc.forEach(((n,s)=>{const i=s.view.Mu(t);i.snapshot&&e.push(i.snapshot)})),function(e,t){const n=D(e);n.onlineState=t;let s=!1;n.queries.forEach(((e,n)=>{for(const e of n.listeners)e.Mu(t)&&(s=!0)})),s&&sc(n)}(s.eventManager,t),e.length&&s.dc.nu(e),s.onlineState=t,s.isPrimaryClient&&s.sharedClientState.setOnlineState(t)}}async function bc(e,t,n){const s=D(e);s.sharedClientState.updateQueryState(t,"rejected",n);const i=s.yc.get(t),r=i&&i.key;if(r){let e=new tt(H.comparator);e=e.insert(r,$t.newNoDocument(r,rt.min()));const n=er().add(r),i=new Zr(rt.min(),new Map,new tt(B),e,n);await vc(s,i),s.gc=s.gc.remove(r),s.yc.delete(t),Ac(s)}else await qo(s.localStore,t,!1).then((()=>_c(s,t,n))).catch(oe)}async function Ec(e,t){const n=D(e),s=t.batch.batchId;try{const e=await function(e,t){const n=D(e);return n.persistence.runTransaction("Acknowledge batch","readwrite-primary",(e=>{const s=t.batch.keys(),i=n.Zi.newChangeBuffer({trackRemovals:!0});return function(e,t,n,s){const i=n.batch,r=i.keys();let o=ae.resolve();return r.forEach((e=>{o=o.next((()=>s.getEntry(t,e))).next((t=>{const r=n.docVersions.get(e);x(null!==r),t.version.compareTo(r)<0&&(i.applyToRemoteDocument(t,n),t.isValidDocument()&&(t.setReadTime(n.commitVersion),s.addEntry(t)))}))})),o.next((()=>e.mutationQueue.removeMutationBatch(t,i)))}(n,e,t,i).next((()=>i.apply(e))).next((()=>n.mutationQueue.performConsistencyCheck(e))).next((()=>n.documentOverlayCache.removeOverlaysForBatchId(e,s,t.batch.batchId))).next((()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,function(e){let t=er();for(let n=0;n<e.mutationResults.length;++n)e.mutationResults[n].transformResults.length>0&&(t=t.add(e.batch.mutations[n].key));return t}(t)))).next((()=>n.localDocuments.getDocuments(e,s)))}))}(n.localStore,t);xc(n,s,null),Sc(n,s),n.sharedClientState.updateMutationState(s,"acknowledged"),await kc(n,e)}catch(e){await oe(e)}}async function Tc(e,t,n){const s=D(e);try{const e=await function(e,t){const n=D(e);return n.persistence.runTransaction("Reject batch","readwrite-primary",(e=>{let s;return n.mutationQueue.lookupMutationBatch(e,t).next((t=>(x(null!==t),s=t.keys(),n.mutationQueue.removeMutationBatch(e,t)))).next((()=>n.mutationQueue.performConsistencyCheck(e))).next((()=>n.documentOverlayCache.removeOverlaysForBatchId(e,s,t))).next((()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,s))).next((()=>n.localDocuments.getDocuments(e,s)))}))}(s.localStore,t);xc(s,t,n),Sc(s,t),s.sharedClientState.updateMutationState(t,"rejected",n),await kc(s,e)}catch(n){await oe(n)}}function Sc(e,t){(e.Ec.get(t)||[]).forEach((e=>{e.resolve()})),e.Ec.delete(t)}function xc(e,t,n){const s=D(e);let i=s.Tc[s.currentUser.toKey()];if(i){const e=i.get(t);e&&(n?e.reject(n):e.resolve(),i=i.remove(t)),s.Tc[s.currentUser.toKey()]=i}}function _c(e,t,n=null){e.sharedClientState.removeLocalQueryTarget(t);for(const s of e._c.get(t))e.wc.delete(s),n&&e.dc.Pc(s,n);e._c.delete(t),e.isPrimaryClient&&e.Ic.Is(t).forEach((t=>{e.Ic.containsKey(t)||Dc(e,t)}))}function Dc(e,t){e.mc.delete(t.path.canonicalString());const n=e.gc.get(t);null!==n&&(Ea(e.remoteStore,n),e.gc=e.gc.remove(t),e.yc.delete(n),Ac(e))}function Nc(e,t,n){for(const s of n)s instanceof lc?(e.Ic.addReference(s.key,t),Cc(e,s)):s instanceof hc?(v("SyncEngine","Document no longer in limbo: "+s.key),e.Ic.removeReference(s.key,t),e.Ic.containsKey(s.key)||Dc(e,s.key)):S()}function Cc(e,t){const n=t.key,s=n.path.canonicalString();e.gc.get(n)||e.mc.has(s)||(v("SyncEngine","New document in limbo: "+n),e.mc.add(s),Ac(e))}function Ac(e){for(;e.mc.size>0&&e.gc.size<e.maxConcurrentLimboResolutions;){const t=e.mc.values().next().value;e.mc.delete(t);const n=new H(j.fromString(t)),s=e.Ac.next();e.yc.set(s,new mc(n)),e.gc=e.gc.insert(n,s),ba(e.remoteStore,new Us(Fn(Dn(n.path)),s,"TargetPurposeLimboResolution",ve.ct))}}async function kc(e,t,n){const s=D(e),i=[],r=[],o=[];s.wc.isEmpty()||(s.wc.forEach(((e,u)=>{o.push(s.Rc(u,t,n).then((e=>{if((e||n)&&s.isPrimaryClient&&s.sharedClientState.updateQueryState(u.targetId,(null==e?void 0:e.fromCache)?"not-current":"current"),e){i.push(e);const t=Ao.Li(u.targetId,e);r.push(t)}})))})),await Promise.all(o),s.dc.nu(i),await async function(e,t){const n=D(e);try{await n.persistence.runTransaction("notifyLocalViewChanges","readwrite",(e=>ae.forEach(t,(t=>ae.forEach(t.Fi,(s=>n.persistence.referenceDelegate.addReference(e,t.targetId,s))).next((()=>ae.forEach(t.Bi,(s=>n.persistence.referenceDelegate.removeReference(e,t.targetId,s)))))))))}catch(e){if(!de(e))throw e;v("LocalStore","Failed to update sequence numbers: "+e)}for(const e of t){const t=e.targetId;if(!e.fromCache){const e=n.Ji.get(t),s=e.snapshotVersion,i=e.withLastLimboFreeSnapshotVersion(s);n.Ji=n.Ji.insert(t,i)}}}(s.localStore,r))}async function Rc(e,t){const n=D(e);if(!n.currentUser.isEqual(t)){v("SyncEngine","User change. New user:",t.toKey());const e=await Vo(n.localStore,t);n.currentUser=t,function(e,t){e.Ec.forEach((e=>{e.forEach((e=>{e.reject(new N(q.CANCELLED,"'waitForPendingWrites' promise is rejected due to a user change."))}))})),e.Ec.clear()}(n),n.sharedClientState.handleUserChange(t,e.removedBatchIds,e.addedBatchIds),await kc(n,e.er)}}function Fc(e,t){const n=D(e),s=n.yc.get(t);if(s&&s.fc)return er().add(s.key);{let e=er();const s=n._c.get(t);if(!s)return e;for(const t of s){const s=n.wc.get(t);e=e.unionWith(s.view.nc)}return e}}async function Vc(e,t){const n=D(e),s=await Uo(n.localStore,t.query,!0),i=t.view.hc(s);return n.isPrimaryClient&&Nc(n,t.targetId,i.cc),i}async function Oc(e,t){const n=D(e);return zo(n.localStore,t).then((e=>kc(n,e)))}async function Mc(e,t,n,s){const i=D(e),r=await function(e,t){const n=D(e),s=D(n.mutationQueue);return n.persistence.runTransaction("Lookup mutation documents","readonly",(e=>s.Sn(e,t).next((t=>t?n.localDocuments.getDocuments(e,t):ae.resolve(null)))))}(i.localStore,t);null!==r?("pending"===n?await Va(i.remoteStore):"acknowledged"===n||"rejected"===n?(xc(i,t,s||null),Sc(i,t),function(e,t){D(D(e).mutationQueue).Cn(t)}(i.localStore,t)):S(),await kc(i,r)):v("SyncEngine","Cannot apply mutation batch with id: "+t)}async function Lc(e,t,n){const s=D(e),i=[],r=[];for(const e of t){let t;const n=s._c.get(e);if(n&&0!==n.length){t=await Po(s.localStore,Fn(n[0]));for(const e of n){const t=s.wc.get(e),n=await Vc(s,t);n.snapshot&&r.push(n.snapshot)}}else{const n=await Bo(s.localStore,e);t=await Po(s.localStore,n),await yc(s,Pc(n),e,!1,t.resumeToken)}i.push(t)}return s.dc.nu(r),i}function Pc(e){return _n(e.path,e.collectionGroup,e.orderBy,e.filters,e.limit,"F",e.startAt,e.endAt)}function qc(e){const t=D(e);return D(D(t.localStore).persistence).$i()}async function Uc(e,t,n,s){const i=D(e);if(i.vc)return void v("SyncEngine","Ignoring unexpected query state notification.");const r=i._c.get(t);if(r&&r.length>0)switch(n){case"current":case"not-current":{const e=await zo(i.localStore,Un(r[0])),s=Zr.createSynthesizedRemoteEventForCurrentChange(t,"current"===n,ht.EMPTY_BYTE_STRING);await kc(i,e,s);break}case"rejected":await qo(i.localStore,t,!0),_c(i,t,s);break;default:S()}}async function Bc(e,t,n){const s=zc(e);if(s.vc){for(const e of t){if(s._c.has(e)){v("SyncEngine","Adding an already active target "+e);continue}const t=await Bo(s.localStore,e),n=await Po(s.localStore,t);await yc(s,Pc(t),n.targetId,!1,n.resumeToken),ba(s.remoteStore,n)}for(const e of n)s._c.has(e)&&await qo(s.localStore,e,!1).then((()=>{Ea(s.remoteStore,e),_c(s,e)})).catch(oe)}}function zc(e){const t=D(e);return t.remoteStore.remoteSyncer.applyRemoteEvent=vc.bind(null,t),t.remoteStore.remoteSyncer.getRemoteKeysForTarget=Fc.bind(null,t),t.remoteStore.remoteSyncer.rejectListen=bc.bind(null,t),t.dc.nu=nc.bind(null,t.eventManager),t.dc.Pc=rc.bind(null,t.eventManager),t}function Gc(e){const t=D(e);return t.remoteStore.remoteSyncer.applySuccessfulWrite=Ec.bind(null,t),t.remoteStore.remoteSyncer.rejectFailedWrite=Tc.bind(null,t),t}class Kc{constructor(){this.synchronizeTabs=!1}async initialize(e){this.serializer=ha(e.databaseInfo.databaseId),this.sharedClientState=this.createSharedClientState(e),this.persistence=this.createPersistence(e),await this.persistence.start(),this.localStore=this.createLocalStore(e),this.gcScheduler=this.createGarbageCollectionScheduler(e,this.localStore),this.indexBackfillerScheduler=this.createIndexBackfillerScheduler(e,this.localStore)}createGarbageCollectionScheduler(e,t){return null}createIndexBackfillerScheduler(e,t){return null}createLocalStore(e){return Fo(this.persistence,new ko,e.initialUser,this.serializer)}createPersistence(e){return new Io(Eo.zs,this.serializer)}createSharedClientState(e){return new ea}async terminate(){this.gcScheduler&&this.gcScheduler.stop(),await this.sharedClientState.shutdown(),await this.persistence.shutdown()}}class $c extends Kc{constructor(e,t,n){super(),this.Vc=e,this.cacheSizeBytes=t,this.forceOwnership=n,this.synchronizeTabs=!1}async initialize(e){await super.initialize(e),await this.Vc.initialize(this,e),await Gc(this.Vc.syncEngine),await Va(this.Vc.remoteStore),await this.persistence.Ii((()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(),this.indexBackfillerScheduler&&!this.indexBackfillerScheduler.started&&this.indexBackfillerScheduler.start(),Promise.resolve())))}createLocalStore(e){return Fo(this.persistence,new ko,e.initialUser,this.serializer)}createGarbageCollectionScheduler(e,t){const n=this.persistence.referenceDelegate.garbageCollector;return new Hi(n,e.asyncQueue,t)}createIndexBackfillerScheduler(e,t){const n=new we(t,this.persistence);return new ye(e.asyncQueue,n)}createPersistence(e){const t=Co(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey),n=void 0!==this.cacheSizeBytes?Vi.withCacheSize(this.cacheSizeBytes):Vi.DEFAULT;return new _o(this.synchronizeTabs,t,e.clientId,n,e.asyncQueue,ua(),la(),this.serializer,this.sharedClientState,!!this.forceOwnership)}createSharedClientState(e){return new ea}}class jc extends $c{constructor(e,t){super(e,t,!1),this.Vc=e,this.cacheSizeBytes=t,this.synchronizeTabs=!0}async initialize(e){await super.initialize(e);const t=this.Vc.syncEngine;this.sharedClientState instanceof Zo&&(this.sharedClientState.syncEngine={jr:Mc.bind(null,t),zr:Uc.bind(null,t),Wr:Bc.bind(null,t),$i:qc.bind(null,t),Qr:Oc.bind(null,t)},await this.sharedClientState.start()),await this.persistence.Ii((async e=>{await async function(e,t){const n=D(e);if(zc(n),Gc(n),!0===t&&!0!==n.vc){const e=n.sharedClientState.getAllActiveQueryTargets(),t=await Lc(n,e.toArray());n.vc=!0,await Ka(n.remoteStore,!0);for(const e of t)ba(n.remoteStore,e)}else if(!1===t&&!1!==n.vc){const e=[];let t=Promise.resolve();n._c.forEach(((s,i)=>{n.sharedClientState.isLocalQueryTarget(i)?e.push(i):t=t.then((()=>(_c(n,i),qo(n.localStore,i,!0)))),Ea(n.remoteStore,i)})),await t,await Lc(n,e),function(e){const t=D(e);t.yc.forEach(((e,n)=>{Ea(t.remoteStore,n)})),t.Ic.Ts(),t.yc=new Map,t.gc=new tt(H.comparator)}(n),n.vc=!1,await Ka(n.remoteStore,!1)}}(this.Vc.syncEngine,e),this.gcScheduler&&(e&&!this.gcScheduler.started?this.gcScheduler.start():e||this.gcScheduler.stop()),this.indexBackfillerScheduler&&(e&&!this.indexBackfillerScheduler.started?this.indexBackfillerScheduler.start():e||this.indexBackfillerScheduler.stop())}))}createSharedClientState(e){const t=ua();if(!Zo.D(t))throw new N(q.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");const n=Co(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey);return new Zo(t,e.asyncQueue,n,e.clientId,e.initialUser)}}class Qc{async initialize(e,t){this.localStore||(this.localStore=e.localStore,this.sharedClientState=e.sharedClientState,this.datastore=this.createDatastore(t),this.remoteStore=this.createRemoteStore(t),this.eventManager=this.createEventManager(t),this.syncEngine=this.createSyncEngine(t,!e.synchronizeTabs),this.sharedClientState.onlineStateHandler=e=>Ic(this.syncEngine,e,1),this.remoteStore.remoteSyncer.handleCredentialChange=Rc.bind(null,this.syncEngine),await Ka(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(e){return new Za}createDatastore(e){const t=ha(e.databaseInfo.databaseId),n=(s=e.databaseInfo,new ca(s));var s;return function(e,t,n,s){return new pa(e,t,n,s)}(e.authCredentials,e.appCheckCredentials,n,t)}createRemoteStore(e){return t=this.localStore,n=this.datastore,s=e.asyncQueue,i=e=>Ic(this.syncEngine,e,0),r=na.D()?new na:new ta,new wa(t,n,s,i,r);var t,n,s,i,r}createSyncEngine(e,t){return function(e,t,n,s,i,r,o){const u=new gc(e,t,n,s,i,r);return o&&(u.vc=!0),u}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,e.initialUser,e.maxConcurrentLimboResolutions,t)}terminate(){return async function(e){const t=D(e);v("RemoteStore","RemoteStore shutting down."),t.vu.add(5),await Ia(t),t.Pu.shutdown(),t.bu.set("Unknown")}(this.remoteStore)}}function Wc(e,t=10240){let n=0;return{async read(){if(n<e.byteLength){const s={value:e.slice(n,n+t),done:!1};return n+=t,s}return{done:!0}},async cancel(){},releaseLock(){},closed:Promise.resolve()}}class Hc{constructor(e){this.observer=e,this.muted=!1}next(e){this.observer.next&&this.Sc(this.observer.next,e)}error(e){this.observer.error?this.Sc(this.observer.error,e):I("Uncaught Error in snapshot listener:",e.toString())}Dc(){this.muted=!0}Sc(e,t){this.muted||setTimeout((()=>{this.muted||e(t)}),0)}}class Yc{constructor(e,t){this.Cc=e,this.serializer=t,this.metadata=new C,this.buffer=new Uint8Array,this.xc=new TextDecoder("utf-8"),this.Nc().then((e=>{e&&e.Qu()?this.metadata.resolve(e.Gu.metadata):this.metadata.reject(new Error(`The first element of the bundle is not a metadata, it is\n             ${JSON.stringify(null==e?void 0:e.Gu)}`))}),(e=>this.metadata.reject(e)))}close(){return this.Cc.cancel()}async getMetadata(){return this.metadata.promise}async bc(){return await this.getMetadata(),this.Nc()}async Nc(){const e=await this.kc();if(null===e)return null;const t=this.xc.decode(e),n=Number(t);isNaN(n)&&this.Mc(`length string (${t}) is not valid number`);const s=await this.$c(n);return new oc(JSON.parse(s),e.length+n)}Oc(){return this.buffer.findIndex((e=>e==="{".charCodeAt(0)))}async kc(){for(;this.Oc()<0&&!await this.Fc(););if(0===this.buffer.length)return null;const e=this.Oc();e<0&&this.Mc("Reached the end of bundle when a length string is expected.");const t=this.buffer.slice(0,e);return this.buffer=this.buffer.slice(e),t}async $c(e){for(;this.buffer.length<e;)await this.Fc()&&this.Mc("Reached the end of bundle when more is expected.");const t=this.xc.decode(this.buffer.slice(0,e));return this.buffer=this.buffer.slice(e),t}Mc(e){throw this.Cc.cancel(),new Error(`Invalid bundle format: ${e}`)}async Fc(){const e=await this.Cc.read();if(!e.done){const t=new Uint8Array(this.buffer.length+e.value.length);t.set(this.buffer),t.set(e.value,this.buffer.length),this.buffer=t}return e.done}}class Xc{constructor(e){this.datastore=e,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastWriteError=null,this.writtenDocs=new Set}async lookup(e){if(this.ensureCommitNotCalled(),this.mutations.length>0)throw new N(q.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes.");const t=await async function(e,t){const n=D(e),s=Ts(n.serializer)+"/documents",i={documents:t.map((e=>vs(n.serializer,e)))},r=await n.vo("BatchGetDocuments",s,i,t.length),o=new Map;r.forEach((e=>{const t=function(e,t){return"found"in t?function(e,t){x(!!t.found),t.found.name,t.found.updateTime;const n=Is(e,t.found.name),s=ps(t.found.updateTime),i=t.found.createTime?ps(t.found.createTime):rt.min(),r=new Gt({mapValue:{fields:t.found.fields}});return $t.newFoundDocument(n,s,i,r)}(e,t):"missing"in t?function(e,t){x(!!t.missing),x(!!t.readTime);const n=Is(e,t.missing),s=ps(t.readTime);return $t.newNoDocument(n,s)}(e,t):S()}(n.serializer,e);o.set(t.key.toString(),t)}));const u=[];return t.forEach((e=>{const t=o.get(e.toString());x(!!t),u.push(t)})),u}(this.datastore,e);return t.forEach((e=>this.recordVersion(e))),t}set(e,t){this.write(t.toMutation(e,this.precondition(e))),this.writtenDocs.add(e.toString())}update(e,t){try{this.write(t.toMutation(e,this.preconditionForUpdate(e)))}catch(e){this.lastWriteError=e}this.writtenDocs.add(e.toString())}delete(e){this.write(new Mr(e,this.precondition(e))),this.writtenDocs.add(e.toString())}async commit(){if(this.ensureCommitNotCalled(),this.lastWriteError)throw this.lastWriteError;const e=this.readVersions;this.mutations.forEach((t=>{e.delete(t.key.toString())})),e.forEach(((e,t)=>{const n=H.fromPath(t);this.mutations.push(new Lr(n,this.precondition(n)))})),await async function(e,t){const n=D(e),s=Ts(n.serializer)+"/documents",i={writes:t.map((e=>Ds(n.serializer,e)))};await n.Io("Commit",s,i)}(this.datastore,this.mutations),this.committed=!0}recordVersion(e){let t;if(e.isFoundDocument())t=e.version;else{if(!e.isNoDocument())throw S();t=rt.min()}const n=this.readVersions.get(e.key.toString());if(n){if(!t.isEqual(n))throw new N(q.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(e.key.toString(),t)}precondition(e){const t=this.readVersions.get(e.toString());return!this.writtenDocs.has(e.toString())&&t?t.isEqual(rt.min())?Tr.exists(!1):Tr.updateTime(t):Tr.none()}preconditionForUpdate(e){const t=this.readVersions.get(e.toString());if(!this.writtenDocs.has(e.toString())&&t){if(t.isEqual(rt.min()))throw new N(q.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return Tr.updateTime(t)}return Tr.exists(!0)}write(e){this.ensureCommitNotCalled(),this.mutations.push(e)}ensureCommitNotCalled(){}}class Jc{constructor(e,t,n,s,i){this.asyncQueue=e,this.datastore=t,this.options=n,this.updateFunction=s,this.deferred=i,this.Bc=n.maxAttempts,this.qo=new da(this.asyncQueue,"transaction_retry")}run(){this.Bc-=1,this.Lc()}Lc(){this.qo.No((async()=>{const e=new Xc(this.datastore),t=this.qc(e);t&&t.then((t=>{this.asyncQueue.enqueueAndForget((()=>e.commit().then((()=>{this.deferred.resolve(t)})).catch((e=>{this.Uc(e)}))))})).catch((e=>{this.Uc(e)}))}))}qc(e){try{const t=this.updateFunction(e);return!Ie(t)&&t.catch&&t.then?t:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(e){return this.deferred.reject(e),null}}Uc(e){this.Bc>0&&this.Kc(e)?(this.Bc-=1,this.asyncQueue.enqueueAndForget((()=>(this.Lc(),Promise.resolve())))):this.deferred.reject(e)}Kc(e){if("FirebaseError"===e.name){const t=e.code;return"aborted"===t||"failed-precondition"===t||"already-exists"===t||!Kr(t)}return!1}}class Zc{constructor(e,t,n,s){this.authCredentials=e,this.appCheckCredentials=t,this.asyncQueue=n,this.databaseInfo=s,this.user=d.UNAUTHENTICATED,this.clientId=U.A(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this.authCredentials.start(n,(async e=>{v("FirestoreClient","Received user=",e.uid),await this.authCredentialListener(e),this.user=e})),this.appCheckCredentials.start(n,(e=>(v("FirestoreClient","Received new app check token=",e),this.appCheckCredentialListener(e,this.user))))}async getConfiguration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(e){this.authCredentialListener=e}setAppCheckTokenChangeListener(e){this.appCheckCredentialListener=e}verifyNotTerminated(){if(this.asyncQueue.isShuttingDown)throw new N(q.FAILED_PRECONDITION,"The client has already been terminated.")}terminate(){this.asyncQueue.enterRestrictedMode();const e=new C;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted((async()=>{try{this._onlineComponents&&await this._onlineComponents.terminate(),this._offlineComponents&&await this._offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),e.resolve()}catch(t){const n=Wa(t,"Failed to shutdown persistence");e.reject(n)}})),e.promise}}async function eu(e,t){e.asyncQueue.verifyOperationInProgress(),v("FirestoreClient","Initializing OfflineComponentProvider");const n=await e.getConfiguration();await t.initialize(n);let s=n.initialUser;e.setCredentialChangeListener((async e=>{s.isEqual(e)||(await Vo(t.localStore,e),s=e)})),t.persistence.setDatabaseDeletedListener((()=>e.terminate())),e._offlineComponents=t}async function tu(e,t){e.asyncQueue.verifyOperationInProgress();const n=await ru(e);v("FirestoreClient","Initializing OnlineComponentProvider");const s=await e.getConfiguration();await t.initialize(n,s),e.setCredentialChangeListener((e=>Ga(t.remoteStore,e))),e.setAppCheckTokenChangeListener(((e,n)=>Ga(t.remoteStore,n))),e._onlineComponents=t}function nu(e){return"FirebaseError"===e.name?e.code===q.FAILED_PRECONDITION||e.code===q.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&e instanceof DOMException)||22===e.code||20===e.code||11===e.code}async function ru(e){if(!e._offlineComponents)if(e._uninitializedComponentsProvider){v("FirestoreClient","Using user provided OfflineComponentProvider");try{await eu(e,e._uninitializedComponentsProvider._offline)}catch(t){const n=t;if(!nu(n))throw n;E("Error using user provided cache. Falling back to memory cache: "+n),await eu(e,new Kc)}}else v("FirestoreClient","Using default OfflineComponentProvider"),await eu(e,new Kc);return e._offlineComponents}async function su(e){return e._onlineComponents||(e._uninitializedComponentsProvider?(v("FirestoreClient","Using user provided OnlineComponentProvider"),await tu(e,e._uninitializedComponentsProvider._online)):(v("FirestoreClient","Using default OnlineComponentProvider"),await tu(e,new Qc))),e._onlineComponents}function iu(e){return ru(e).then((e=>e.persistence))}function ou(e){return ru(e).then((e=>e.localStore))}function au(e){return su(e).then((e=>e.remoteStore))}function cu(e){return su(e).then((e=>e.syncEngine))}function uu(e){return su(e).then((e=>e.datastore))}async function lu(e){const t=await su(e),n=t.eventManager;return n.onListen=pc.bind(null,t.syncEngine),n.onUnlisten=wc.bind(null,t.syncEngine),n}function hu(e,t,n={}){const s=new C;return e.asyncQueue.enqueueAndForget((async()=>function(e,t,n,s,i){const r=new Hc({next:r=>{t.enqueueAndForget((()=>tc(e,o)));const u=r.docs.has(n);!u&&r.fromCache?i.reject(new N(q.UNAVAILABLE,"Failed to get document because the client is offline.")):u&&r.fromCache&&s&&"server"===s.source?i.reject(new N(q.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):i.resolve(r)},error:e=>i.reject(e)}),o=new ic(Dn(n.path),r,{includeMetadataChanges:!0,Ku:!0});return ec(e,o)}(await lu(e),e.asyncQueue,t,n,s))),s.promise}function du(e,t,n={}){const s=new C;return e.asyncQueue.enqueueAndForget((async()=>function(e,t,n,s,i){const r=new Hc({next:n=>{t.enqueueAndForget((()=>tc(e,o))),n.fromCache&&"server"===s.source?i.reject(new N(q.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):i.resolve(n)},error:e=>i.reject(e)}),o=new ic(n,r,{includeMetadataChanges:!0,Ku:!0});return ec(e,o)}(await lu(e),e.asyncQueue,t,n,s))),s.promise}function fu(e,t,n,s){const i=function(e,t){let n;return n="string"==typeof e?Wr().encode(e):e,function(e,t){return new Yc(e,t)}(function(e,t){if(e instanceof Uint8Array)return Wc(e,t);if(e instanceof ArrayBuffer)return Wc(new Uint8Array(e),t);if(e instanceof ReadableStream)return e.getReader();throw new Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}(n),t)}(n,ha(t));e.asyncQueue.enqueueAndForget((async()=>{!function(e,t,n){const s=D(e);(async function(e,t,n){try{const s=await t.getMetadata();if(await function(e,t){const n=D(e),s=ps(t.createTime);return n.persistence.runTransaction("hasNewerBundle","readonly",(e=>n.qs.getBundleMetadata(e,t.id))).then((e=>!!e&&e.createTime.compareTo(s)>=0))}(e.localStore,s))return await t.close(),n._completeWith(function(e){return{taskState:"Success",documentsLoaded:e.totalDocuments,bytesLoaded:e.totalBytes,totalDocuments:e.totalDocuments,totalBytes:e.totalBytes}}(s)),Promise.resolve(new Set);n._updateProgress(uc(s));const i=new cc(s,e.localStore,t.serializer);let r=await t.bc();for(;r;){const e=await i.zu(r);e&&n._updateProgress(e),r=await t.bc()}const o=await i.complete();return await kc(e,o.Ju,void 0),await function(e,t){const n=D(e);return n.persistence.runTransaction("Save bundle","readwrite",(e=>n.qs.saveBundleMetadata(e,t)))}(e.localStore,s),n._completeWith(o.progress),Promise.resolve(o.Hu)}catch(e){return E("SyncEngine",`Loading bundle failed with ${e}`),n._failWith(e),Promise.resolve(new Set)}})(s,t,n).then((e=>{s.sharedClientState.notifyBundleLoaded(e)}))}(await cu(e),i,s)}))}function th(e){const t={};return void 0!==e.timeoutSeconds&&(t.timeoutSeconds=e.timeoutSeconds),t}const mu=new Map;function gu(e,t,n){if(!n)throw new N(q.INVALID_ARGUMENT,`Function ${e}() cannot be called with an empty ${t}.`)}function pu(e,t,n,s){if(!0===t&&!0===s)throw new N(q.INVALID_ARGUMENT,`${e} and ${n} cannot be used together.`)}function yu(e){if(!H.isDocumentKey(e))throw new N(q.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${e} has ${e.length}.`)}function wu(e){if(H.isDocumentKey(e))throw new N(q.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${e} has ${e.length}.`)}function vu(e){if(void 0===e)return"undefined";if(null===e)return"null";if("string"==typeof e)return e.length>20&&(e=`${e.substring(0,20)}...`),JSON.stringify(e);if("number"==typeof e||"boolean"==typeof e)return""+e;if("object"==typeof e){if(e instanceof Array)return"an array";{const t=function(e){return e.constructor?e.constructor.name:null}(e);return t?`a custom ${t} object`:"an object"}}return"function"==typeof e?"a function":S()}function Iu(e,t){if("_delegate"in e&&(e=e._delegate),!(e instanceof t)){if(t.name===e.constructor.name)throw new N(q.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{const n=vu(e);throw new N(q.INVALID_ARGUMENT,`Expected type '${t.name}', but it was: ${n}`)}}return e}function bu(e,t){if(t<=0)throw new N(q.INVALID_ARGUMENT,`Function ${e}() requires a positive number, but it was: ${t}.`)}class Eu{constructor(e){var t,n;if(void 0===e.host){if(void 0!==e.ssl)throw new N(q.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=e.host,this.ssl=null===(t=e.ssl)||void 0===t||t;if(this.credentials=e.credentials,this.ignoreUndefinedProperties=!!e.ignoreUndefinedProperties,this.cache=e.localCache,void 0===e.cacheSizeBytes)this.cacheSizeBytes=41943040;else{if(-1!==e.cacheSizeBytes&&e.cacheSizeBytes<1048576)throw new N(q.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=e.cacheSizeBytes}pu("experimentalForceLongPolling",e.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",e.experimentalAutoDetectLongPolling),this.experimentalForceLongPolling=!!e.experimentalForceLongPolling,this.experimentalForceLongPolling?this.experimentalAutoDetectLongPolling=!1:void 0===e.experimentalAutoDetectLongPolling?this.experimentalAutoDetectLongPolling=!0:this.experimentalAutoDetectLongPolling=!!e.experimentalAutoDetectLongPolling,this.experimentalLongPollingOptions=th(null!==(n=e.experimentalLongPollingOptions)&&void 0!==n?n:{}),function(e){if(void 0!==e.timeoutSeconds){if(isNaN(e.timeoutSeconds))throw new N(q.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (must not be NaN)`);if(e.timeoutSeconds<5)throw new N(q.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (minimum allowed value is 5)`);if(e.timeoutSeconds>30)throw new N(q.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (maximum allowed value is 30)`)}}(this.experimentalLongPollingOptions),this.useFetchStreams=!!e.useFetchStreams}isEqual(e){return this.host===e.host&&this.ssl===e.ssl&&this.credentials===e.credentials&&this.cacheSizeBytes===e.cacheSizeBytes&&this.experimentalForceLongPolling===e.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===e.experimentalAutoDetectLongPolling&&(t=this.experimentalLongPollingOptions,n=e.experimentalLongPollingOptions,t.timeoutSeconds===n.timeoutSeconds)&&this.ignoreUndefinedProperties===e.ignoreUndefinedProperties&&this.useFetchStreams===e.useFetchStreams;var t,n}}class Tu{constructor(e,t,n,s){this._authCredentials=e,this._appCheckCredentials=t,this._databaseId=n,this._app=s,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new Eu({}),this._settingsFrozen=!1}get app(){if(!this._app)throw new N(q.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return void 0!==this._terminateTask}_setSettings(e){if(this._settingsFrozen)throw new N(q.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new Eu(e),void 0!==e.credentials&&(this._authCredentials=function(e){if(!e)return new k;switch(e.type){case"firstParty":return new O(e.sessionIndex||"0",e.iamToken||null,e.authTokenFactory||null);case"provider":return e.client;default:throw new N(q.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(e.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask||(this._terminateTask=this._terminate()),this._terminateTask}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(e){const t=mu.get(e);t&&(v("ComponentProvider","Removing Datastore"),mu.delete(e),t.terminate())}(this),Promise.resolve()}}function Su(e,t,n,s={}){var i;const r=(e=Iu(e,Tu))._getSettings(),o=`${t}:${n}`;if("firestore.googleapis.com"!==r.host&&r.host!==o&&E("Host has been set in both settings() and connectFirestoreEmulator(), emulator host will be used."),e._setSettings(Object.assign(Object.assign({},r),{host:o,ssl:!1})),s.mockUserToken){let t,n;if("string"==typeof s.mockUserToken)t=s.mockUserToken,n=d.MOCK_USER;else{t=Object(l.n)(s.mockUserToken,null===(i=e._app)||void 0===i?void 0:i.options.projectId);const r=s.mockUserToken.sub||s.mockUserToken.user_id;if(!r)throw new N(q.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");n=new d(r)}e._authCredentials=new R(new A(t,n))}}class xu{constructor(e,t,n){this.converter=t,this._key=n,this.type="document",this.firestore=e}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new Du(this.firestore,this.converter,this._key.path.popLast())}withConverter(e){return new xu(this.firestore,e,this._key)}}class _u{constructor(e,t,n){this.converter=t,this._query=n,this.type="query",this.firestore=e}withConverter(e){return new _u(this.firestore,e,this._query)}}class Du extends _u{constructor(e,t,n){super(e,t,Dn(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const e=this._path.popLast();return e.isEmpty()?null:new xu(this.firestore,null,new H(e))}withConverter(e){return new Du(this.firestore,e,this._path)}}function Nu(e,t,...n){if(e=Object(l.z)(e),gu("collection","path",t),e instanceof Tu){const s=j.fromString(t,...n);return wu(s),new Du(e,null,s)}{if(!(e instanceof xu||e instanceof Du))throw new N(q.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const s=e._path.child(j.fromString(t,...n));return wu(s),new Du(e.firestore,null,s)}}function Cu(e,t){if(e=Iu(e,Tu),gu("collectionGroup","collection id",t),t.indexOf("/")>=0)throw new N(q.INVALID_ARGUMENT,`Invalid collection ID '${t}' passed to function collectionGroup(). Collection IDs must not contain '/'.`);return new _u(e,null,function(e){return new xn(j.emptyPath(),e)}(t))}function Au(e,t,...n){if(e=Object(l.z)(e),1===arguments.length&&(t=U.A()),gu("doc","path",t),e instanceof Tu){const s=j.fromString(t,...n);return yu(s),new xu(e,null,new H(s))}{if(!(e instanceof xu||e instanceof Du))throw new N(q.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const s=e._path.child(j.fromString(t,...n));return yu(s),new xu(e.firestore,e instanceof Du?e.converter:null,new H(s))}}function ku(e,t){return e=Object(l.z)(e),t=Object(l.z)(t),(e instanceof xu||e instanceof Du)&&(t instanceof xu||t instanceof Du)&&e.firestore===t.firestore&&e.path===t.path&&e.converter===t.converter}function Ru(e,t){return e=Object(l.z)(e),t=Object(l.z)(t),e instanceof _u&&t instanceof _u&&e.firestore===t.firestore&&Mn(e._query,t._query)&&e.converter===t.converter}class Fu{constructor(){this.Gc=Promise.resolve(),this.Qc=[],this.jc=!1,this.zc=[],this.Wc=null,this.Hc=!1,this.Jc=!1,this.Yc=[],this.qo=new da(this,"async_queue_retry"),this.Xc=()=>{const e=la();e&&v("AsyncQueue","Visibility state changed to "+e.visibilityState),this.qo.Mo()};const e=la();e&&"function"==typeof e.addEventListener&&e.addEventListener("visibilitychange",this.Xc)}get isShuttingDown(){return this.jc}enqueueAndForget(e){this.enqueue(e)}enqueueAndForgetEvenWhileRestricted(e){this.Zc(),this.ta(e)}enterRestrictedMode(e){if(!this.jc){this.jc=!0,this.Jc=e||!1;const t=la();t&&"function"==typeof t.removeEventListener&&t.removeEventListener("visibilitychange",this.Xc)}}enqueue(e){if(this.Zc(),this.jc)return new Promise((()=>{}));const t=new C;return this.ta((()=>this.jc&&this.Jc?Promise.resolve():(e().then(t.resolve,t.reject),t.promise))).then((()=>t.promise))}enqueueRetryable(e){this.enqueueAndForget((()=>(this.Qc.push(e),this.ea())))}async ea(){if(0!==this.Qc.length){try{await this.Qc[0](),this.Qc.shift(),this.qo.reset()}catch(e){if(!de(e))throw e;v("AsyncQueue","Operation failed with retryable error: "+e)}this.Qc.length>0&&this.qo.No((()=>this.ea()))}}ta(e){const t=this.Gc.then((()=>(this.Hc=!0,e().catch((e=>{this.Wc=e,this.Hc=!1;const t=function(e){let t=e.message||"";return e.stack&&(t=e.stack.includes(e.message)?e.stack:e.message+"\n"+e.stack),t}(e);throw I("INTERNAL UNHANDLED ERROR: ",t),e})).then((e=>(this.Hc=!1,e))))));return this.Gc=t,t}enqueueAfterDelay(e,t,n){this.Zc(),this.Yc.indexOf(e)>-1&&(t=0);const s=Qa.createAndSchedule(this,e,t,n,(e=>this.na(e)));return this.zc.push(s),s}Zc(){this.Wc&&S()}verifyOperationInProgress(){}async sa(){let e;do{e=this.Gc,await e}while(e!==this.Gc)}ia(e){for(const t of this.zc)if(t.timerId===e)return!0;return!1}ra(e){return this.sa().then((()=>{this.zc.sort(((e,t)=>e.targetTimeMs-t.targetTimeMs));for(const t of this.zc)if(t.skipDelay(),"all"!==e&&t.timerId===e)break;return this.sa()}))}oa(e){this.Yc.push(e)}na(e){const t=this.zc.indexOf(e);this.zc.splice(t,1)}}function Vu(e){return function(e,t){if("object"!=typeof e||null===e)return!1;const n=e;for(const e of["next","error","complete"])if(e in n&&"function"==typeof n[e])return!0;return!1}(e)}class Ou{constructor(){this._progressObserver={},this._taskCompletionResolver=new C,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}onProgress(e,t,n){this._progressObserver={next:e,error:t,complete:n}}catch(e){return this._taskCompletionResolver.promise.catch(e)}then(e,t){return this._taskCompletionResolver.promise.then(e,t)}_completeWith(e){this._updateProgress(e),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(e)}_failWith(e){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(e),this._taskCompletionResolver.reject(e)}_updateProgress(e){this._lastProgress=e,this._progressObserver.next&&this._progressObserver.next(e)}}const Mu=-1;class Lu extends Tu{constructor(e,t,n,s){super(e,t,n,s),this.type="firestore",this._queue=new Fu,this._persistenceKey=(null==s?void 0:s.name)||"[DEFAULT]"}_terminate(){return this._firestoreClient||qu(this),this._firestoreClient.terminate()}}function Pu(e){return e._firestoreClient||qu(e),e._firestoreClient.verifyNotTerminated(),e._firestoreClient}function qu(e){var t,n,s;const i=e._freezeSettings(),r=function(e,t,n,s){return new It(e,t,n,s.host,s.ssl,s.experimentalForceLongPolling,s.experimentalAutoDetectLongPolling,th(s.experimentalLongPollingOptions),s.useFetchStreams)}(e._databaseId,(null===(t=e._app)||void 0===t?void 0:t.options.appId)||"",e._persistenceKey,i);e._firestoreClient=new Zc(e._authCredentials,e._appCheckCredentials,e._queue,r),(null===(n=i.cache)||void 0===n?void 0:n._offlineComponentProvider)&&(null===(s=i.cache)||void 0===s?void 0:s._onlineComponentProvider)&&(e._firestoreClient._uninitializedComponentsProvider={_offlineKind:i.cache.kind,_offline:i.cache._offlineComponentProvider,_online:i.cache._onlineComponentProvider})}function Uu(e,t){Hu(e=Iu(e,Lu));const n=Pu(e);if(n._uninitializedComponentsProvider)throw new N(q.FAILED_PRECONDITION,"SDK cache is already specified.");E("enableIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");const s=e._freezeSettings(),i=new Qc;return zu(n,i,new $c(i,s.cacheSizeBytes,null==t?void 0:t.forceOwnership))}function Bu(e){Hu(e=Iu(e,Lu));const t=Pu(e);if(t._uninitializedComponentsProvider)throw new N(q.FAILED_PRECONDITION,"SDK cache is already specified.");E("enableMultiTabIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");const n=e._freezeSettings(),s=new Qc;return zu(t,s,new jc(s,n.cacheSizeBytes))}function zu(e,t,n){const s=new C;return e.asyncQueue.enqueue((async()=>{try{await eu(e,n),await tu(e,t),s.resolve()}catch(e){const t=e;if(!nu(t))throw t;E("Error enabling indexeddb cache. Falling back to memory cache: "+t),s.reject(t)}})).then((()=>s.promise))}function Gu(e){if(e._initialized&&!e._terminated)throw new N(q.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");const t=new C;return e._queue.enqueueAndForgetEvenWhileRestricted((async()=>{try{await async function(e){if(!ue.D())return Promise.resolve();const t=e+"main";await ue.delete(t)}(Co(e._databaseId,e._persistenceKey)),t.resolve()}catch(e){t.reject(e)}})),t.promise}function Ku(e){return function(e){const t=new C;return e.asyncQueue.enqueueAndForget((async()=>async function(e,t){const n=D(e);Da(n.remoteStore)||v("SyncEngine","The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled.");try{const e=await function(e){const t=D(e);return t.persistence.runTransaction("Get highest unacknowledged batch id","readonly",(e=>t.mutationQueue.getHighestUnacknowledgedBatchId(e)))}(n.localStore);if(-1===e)return void t.resolve();const s=n.Ec.get(e)||[];s.push(t),n.Ec.set(e,s)}catch(e){const n=Wa(e,"Initialization of waitForPendingWrites() operation failed");t.reject(n)}}(await cu(e),t))),t.promise}(Pu(e=Iu(e,Lu)))}function $u(e){return function(e){return e.asyncQueue.enqueue((async()=>{const t=await iu(e),n=await au(e);return t.setNetworkEnabled(!0),function(e){const t=D(e);return t.vu.delete(0),va(t)}(n)}))}(Pu(e=Iu(e,Lu)))}function ju(e){return function(e){return e.asyncQueue.enqueue((async()=>{const t=await iu(e),n=await au(e);return t.setNetworkEnabled(!1),async function(e){const t=D(e);t.vu.add(0),await Ia(t),t.bu.set("Offline")}(n)}))}(Pu(e=Iu(e,Lu)))}function Qu(e,t){const n=Pu(e=Iu(e,Lu)),s=new Ou;return fu(n,e._databaseId,t,s),s}function Wu(e,t){return function(e,t){return e.asyncQueue.enqueue((async()=>function(e,t){const n=D(e);return n.persistence.runTransaction("Get named query","readonly",(e=>n.qs.getNamedQuery(e,t)))}(await ou(e),t)))}(Pu(e=Iu(e,Lu)),t).then((t=>t?new _u(e,null,t.query):null))}function Hu(e){if(e._initialized||e._terminated)throw new N(q.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.")}class Yu{constructor(e){this._byteString=e}static fromBase64String(e){try{return new Yu(ht.fromBase64String(e))}catch(e){throw new N(q.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+e)}}static fromUint8Array(e){return new Yu(ht.fromUint8Array(e))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(e){return this._byteString.isEqual(e._byteString)}}class Xu{constructor(...e){for(let t=0;t<e.length;++t)if(0===e[t].length)throw new N(q.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new W(e)}isEqual(e){return this._internalPath.isEqual(e._internalPath)}}class Ju{constructor(e){this._methodName=e}}class Zu{constructor(e,t){if(!isFinite(e)||e<-90||e>90)throw new N(q.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+e);if(!isFinite(t)||t<-180||t>180)throw new N(q.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+t);this._lat=e,this._long=t}get latitude(){return this._lat}get longitude(){return this._long}isEqual(e){return this._lat===e._lat&&this._long===e._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(e){return B(this._lat,e._lat)||B(this._long,e._long)}}const el=/^__.*__$/;class tl{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return null!==this.fieldMask?new Rr(e,this.data,this.fieldMask,t,this.fieldTransforms):new kr(e,this.data,t,this.fieldTransforms)}}class nl{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return new Rr(e,this.data,this.fieldMask,t,this.fieldTransforms)}}function rl(e){switch(e){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw S()}}class sl{constructor(e,t,n,s,i,r){this.settings=e,this.databaseId=t,this.serializer=n,this.ignoreUndefinedProperties=s,void 0===i&&this.ua(),this.fieldTransforms=i||[],this.fieldMask=r||[]}get path(){return this.settings.path}get ca(){return this.settings.ca}aa(e){return new sl(Object.assign(Object.assign({},this.settings),e),this.databaseId,this.serializer,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}ha(e){var t;const n=null===(t=this.path)||void 0===t?void 0:t.child(e),s=this.aa({path:n,la:!1});return s.fa(e),s}da(e){var t;const n=null===(t=this.path)||void 0===t?void 0:t.child(e),s=this.aa({path:n,la:!1});return s.ua(),s}wa(e){return this.aa({path:void 0,la:!0})}_a(e){return Sl(e,this.settings.methodName,this.settings.ma||!1,this.path,this.settings.ga)}contains(e){return void 0!==this.fieldMask.find((t=>e.isPrefixOf(t)))||void 0!==this.fieldTransforms.find((t=>e.isPrefixOf(t.field)))}ua(){if(this.path)for(let e=0;e<this.path.length;e++)this.fa(this.path.get(e))}fa(e){if(0===e.length)throw this._a("Document fields must not be empty");if(rl(this.ca)&&el.test(e))throw this._a('Document fields cannot begin and end with "__"')}}class il{constructor(e,t,n){this.databaseId=e,this.ignoreUndefinedProperties=t,this.serializer=n||ha(e)}ya(e,t,n,s=!1){return new sl({ca:e,methodName:t,ga:n,path:W.emptyPath(),la:!1,ma:s},this.databaseId,this.serializer,this.ignoreUndefinedProperties)}}function al(e){const t=e._freezeSettings(),n=ha(e._databaseId);return new il(e._databaseId,!!t.ignoreUndefinedProperties,n)}function cl(e,t,n,s,i,r={}){const o=e.ya(r.merge||r.mergeFields?2:0,t,n,i);dl("Data must be an object, but it was:",o,s);const u=vl(s,o);let c,a;if(r.merge)c=new ct(o.fieldMask),a=o.fieldTransforms;else if(r.mergeFields){const e=[];for(const s of r.mergeFields){const i=bl(t,s,n);if(!o.contains(i))throw new N(q.INVALID_ARGUMENT,`Field '${i}' is specified in your field mask but missing from your input data.`);xl(e,i)||e.push(i)}c=new ct(e),a=o.fieldTransforms.filter((e=>c.covers(e.field)))}else c=null,a=o.fieldTransforms;return new tl(new Gt(u),c,a)}class ll extends Ju{_toFieldTransform(e){if(2!==e.ca)throw 1===e.ca?e._a(`${this._methodName}() can only appear at the top level of your update data`):e._a(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return e.fieldMask.push(e.path),null}isEqual(e){return e instanceof ll}}function hl(e,t,n){return new sl({ca:3,ga:t.settings.ga,methodName:e._methodName,la:n},t.databaseId,t.serializer,t.ignoreUndefinedProperties)}class fl extends Ju{_toFieldTransform(e){return new Ir(e.path,new dr)}isEqual(e){return e instanceof fl}}class ml extends Ju{constructor(e,t){super(e),this.pa=t}_toFieldTransform(e){const t=hl(this,e,!0),n=this.pa.map((e=>wl(e,t))),s=new fr(n);return new Ir(e.path,s)}isEqual(e){return this===e}}class gl extends Ju{constructor(e,t){super(e),this.pa=t}_toFieldTransform(e){const t=hl(this,e,!0),n=this.pa.map((e=>wl(e,t))),s=new gr(n);return new Ir(e.path,s)}isEqual(e){return this===e}}class ol extends Ju{constructor(e,t){super(e),this.Ia=t}_toFieldTransform(e){const t=new yr(e.serializer,or(e.serializer,this.Ia));return new Ir(e.path,t)}isEqual(e){return this===e}}function ul(e,t,n,s){const i=e.ya(1,t,n);dl("Data must be an object, but it was:",i,s);const r=[],o=Gt.empty();Ze(s,((e,s)=>{const u=Tl(t,e,n);s=Object(l.z)(s);const c=i.da(u);if(s instanceof ll)r.push(u);else{const e=wl(s,c);null!=e&&(r.push(u),o.set(u,e))}}));const u=new ct(r);return new nl(o,u,i.fieldTransforms)}function pl(e,t,n,s,i,r){const o=e.ya(1,t,n),u=[bl(t,s,n)],c=[i];if(r.length%2!=0)throw new N(q.INVALID_ARGUMENT,`Function ${t}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let e=0;e<r.length;e+=2)u.push(bl(t,r[e])),c.push(r[e+1]);const a=[],h=Gt.empty();for(let e=u.length-1;e>=0;--e)if(!xl(a,u[e])){const t=u[e];let n=c[e];n=Object(l.z)(n);const s=o.da(t);if(n instanceof ll)a.push(t);else{const e=wl(n,s);null!=e&&(a.push(t),h.set(t,e))}}const d=new ct(a);return new nl(h,d,o.fieldTransforms)}function yl(e,t,n,s=!1){return wl(n,e.ya(s?4:3,t))}function wl(e,t){if(Il(e=Object(l.z)(e)))return dl("Unsupported field value:",t,e),vl(e,t);if(e instanceof Ju)return function(e,t){if(!rl(t.ca))throw t._a(`${e._methodName}() can only be used with update() and set()`);if(!t.path)throw t._a(`${e._methodName}() is not currently supported inside arrays`);const n=e._toFieldTransform(t);n&&t.fieldTransforms.push(n)}(e,t),null;if(void 0===e&&t.ignoreUndefinedProperties)return null;if(t.path&&t.fieldMask.push(t.path),e instanceof Array){if(t.settings.la&&4!==t.ca)throw t._a("Nested arrays are not supported");return function(e,t){const n=[];let s=0;for(const i of e){let e=wl(i,t.wa(s));null==e&&(e={nullValue:"NULL_VALUE"}),n.push(e),s++}return{arrayValue:{values:n}}}(e,t)}return function(e,t){if(null===(e=Object(l.z)(e)))return{nullValue:"NULL_VALUE"};if("number"==typeof e)return or(t.serializer,e);if("boolean"==typeof e)return{booleanValue:e};if("string"==typeof e)return{stringValue:e};if(e instanceof Date){const n=K.fromDate(e);return{timestampValue:fs(t.serializer,n)}}if(e instanceof K){const n=new K(e.seconds,1e3*Math.floor(e.nanoseconds/1e3));return{timestampValue:fs(t.serializer,n)}}if(e instanceof Zu)return{geoPointValue:{latitude:e.latitude,longitude:e.longitude}};if(e instanceof Yu)return{bytesValue:ms(t.serializer,e._byteString)};if(e instanceof xu){const n=t.databaseId,s=e.firestore._databaseId;if(!s.isEqual(n))throw t._a(`Document reference is for database ${s.projectId}/${s.database} but should be for database ${n.projectId}/${n.database}`);return{referenceValue:ys(e.firestore._databaseId||t.databaseId,e._key.path)}}throw t._a(`Unsupported field value: ${vu(e)}`)}(e,t)}function vl(e,t){const n={};return et(e)?t.path&&t.path.length>0&&t.fieldMask.push(t.path):Ze(e,((e,s)=>{const i=wl(s,t.ha(e));null!=i&&(n[e]=i)})),{mapValue:{fields:n}}}function Il(e){return!("object"!=typeof e||null===e||e instanceof Array||e instanceof Date||e instanceof K||e instanceof Zu||e instanceof Yu||e instanceof xu||e instanceof Ju)}function dl(e,t,n){if(!Il(n)||!function(e){return"object"==typeof e&&null!==e&&(Object.getPrototypeOf(e)===Object.prototype||null===Object.getPrototypeOf(e))}(n)){const s=vu(n);throw"an object"===s?t._a(e+" a custom object"):t._a(e+" "+s)}}function bl(e,t,n){if((t=Object(l.z)(t))instanceof Xu)return t._internalPath;if("string"==typeof t)return Tl(e,t);throw Sl("Field path arguments must be of type string or ",e,!1,void 0,n)}const El=new RegExp("[~\\*/\\[\\]]");function Tl(e,t,n){if(t.search(El)>=0)throw Sl(`Invalid field path (${t}). Paths must not contain '~', '*', '/', '[', or ']'`,e,!1,void 0,n);try{return new Xu(...t.split("."))._internalPath}catch(r){throw Sl(`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,e,!1,void 0,n)}}function Sl(e,t,n,s,i){const r=s&&!s.isEmpty(),o=void 0!==i;let u=`Function ${t}() called with invalid data`;n&&(u+=" (via `toFirestore()`)"),u+=". ";let c="";return(r||o)&&(c+=" (found",r&&(c+=` in field ${s}`),o&&(c+=` in document ${i}`),c+=")"),new N(q.INVALID_ARGUMENT,u+e+c)}function xl(e,t){return e.some((e=>e.isEqual(t)))}class _l{constructor(e,t,n,s,i){this._firestore=e,this._userDataWriter=t,this._key=n,this._document=s,this._converter=i}get id(){return this._key.path.lastSegment()}get ref(){return new xu(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){if(this._document){if(this._converter){const e=new Dl(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(e)}return this._userDataWriter.convertValue(this._document.data.value)}}get(e){if(this._document){const t=this._document.data.field(Nl("DocumentSnapshot.get",e));if(null!==t)return this._userDataWriter.convertValue(t)}}}class Dl extends _l{data(){return super.data()}}function Nl(e,t){return"string"==typeof t?Tl(e,t):t instanceof Xu?t._internalPath:t._delegate._internalPath}function Cl(e){if("L"===e.limitType&&0===e.explicitOrderBy.length)throw new N(q.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}class Al{}class kl extends Al{}function Rl(e,t,...n){let s=[];t instanceof Al&&s.push(t),s=s.concat(n),function(e){const t=e.filter((e=>e instanceof Ol)).length,n=e.filter((e=>e instanceof Fl)).length;if(t>1||t>0&&n>0)throw new N(q.INVALID_ARGUMENT,"InvalidQuery. When using composite filters, you cannot use more than one filter at the top level. Consider nesting the multiple filters within an `and(...)` statement. For example: change `query(query, where(...), or(...))` to `query(query, and(where(...), or(...)))`.")}(s);for(const t of s)e=t._apply(e);return e}class Fl extends kl{constructor(e,t,n){super(),this._field=e,this._op=t,this._value=n,this.type="where"}static _create(e,t,n){return new Fl(e,t,n)}_apply(e){const t=this._parse(e);return Yl(e._query,t),new _u(e.firestore,e.converter,Vn(e._query,t))}_parse(e){const t=al(e.firestore),n=function(e,t,n,s,i,r,o){let u;if(i.isKeyField()){if("array-contains"===r||"array-contains-any"===r)throw new N(q.INVALID_ARGUMENT,`Invalid Query. You can't perform '${r}' queries on documentId().`);if("in"===r||"not-in"===r){Hl(o,r);const t=[];for(const n of o)t.push(Wl(s,e,n));u={arrayValue:{values:t}}}else u=Wl(s,e,o)}else"in"!==r&&"not-in"!==r&&"array-contains-any"!==r||Hl(o,r),u=yl(n,"where",o,"in"===r||"not-in"===r);return Jt.create(i,r,u)}(e._query,0,t,e.firestore._databaseId,this._field,this._op,this._value);return n}}function Vl(e,t,n){const s=t,i=Nl("where",e);return Fl._create(i,s,n)}class Ol extends Al{constructor(e,t){super(),this.type=e,this._queryConstraints=t}static _create(e,t){return new Ol(e,t)}_parse(e){const t=this._queryConstraints.map((t=>t._parse(e))).filter((e=>e.getFilters().length>0));return 1===t.length?t[0]:Zt.create(t,this._getOperator())}_apply(e){const t=this._parse(e);return 0===t.getFilters().length?e:(function(e,t){let n=e;const s=t.getFlattenedFilters();for(const e of s)Yl(n,e),n=Vn(n,e)}(e._query,t),new _u(e.firestore,e.converter,Vn(e._query,t)))}_getQueryConstraints(){return this._queryConstraints}_getOperator(){return"and"===this.type?"and":"or"}}class Ml extends kl{constructor(e,t){super(),this._field=e,this._direction=t,this.type="orderBy"}static _create(e,t){return new Ml(e,t)}_apply(e){const t=function(e,t,n){if(null!==e.startAt)throw new N(q.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==e.endAt)throw new N(q.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");const s=new Ht(t,n);return function(e,t){if(null===Cn(e)){const n=An(e);null!==n&&Xl(e,n,t.field)}}(e,s),s}(e._query,this._field,this._direction);return new _u(e.firestore,e.converter,function(e,t){const n=e.explicitOrderBy.concat([t]);return new xn(e.path,e.collectionGroup,n,e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt)}(e._query,t))}}function Ll(e,t="asc"){const n=t,s=Nl("orderBy",e);return Ml._create(s,n)}class Pl extends kl{constructor(e,t,n){super(),this.type=e,this._limit=t,this._limitType=n}static _create(e,t,n){return new Pl(e,t,n)}_apply(e){return new _u(e.firestore,e.converter,On(e._query,this._limit,this._limitType))}}function ql(e){return bu("limit",e),Pl._create("limit",e,"F")}function Ul(e){return bu("limitToLast",e),Pl._create("limitToLast",e,"L")}class Bl extends kl{constructor(e,t,n){super(),this.type=e,this._docOrFields=t,this._inclusive=n}static _create(e,t,n){return new Bl(e,t,n)}_apply(e){const t=Ql(e,this.type,this._docOrFields,this._inclusive);return new _u(e.firestore,e.converter,function(e,t){return new xn(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),e.limit,e.limitType,t,e.endAt)}(e._query,t))}}function zl(...e){return Bl._create("startAt",e,!0)}function Gl(...e){return Bl._create("startAfter",e,!1)}class Kl extends kl{constructor(e,t,n){super(),this.type=e,this._docOrFields=t,this._inclusive=n}static _create(e,t,n){return new Kl(e,t,n)}_apply(e){const t=Ql(e,this.type,this._docOrFields,this._inclusive);return new _u(e.firestore,e.converter,function(e,t){return new xn(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),e.limit,e.limitType,e.startAt,t)}(e._query,t))}}function $l(...e){return Kl._create("endBefore",e,!1)}function jl(...e){return Kl._create("endAt",e,!0)}function Ql(e,t,n,s){if(n[0]=Object(l.z)(n[0]),n[0]instanceof _l)return function(e,t,n,s,i){if(!s)throw new N(q.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${n}().`);const r=[];for(const n of Rn(e))if(n.field.isKeyField())r.push(kt(t,s.key));else{const e=s.data.field(n.field);if(yt(e))throw new N(q.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+n.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===e){const e=n.field.canonicalString();throw new N(q.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${e}' (used as the orderBy) does not exist.`)}r.push(e)}return new jt(r,i)}(e._query,e.firestore._databaseId,t,n[0]._document,s);{const i=al(e.firestore);return function(e,t,n,s,i,r){const o=e.explicitOrderBy;if(i.length>o.length)throw new N(q.INVALID_ARGUMENT,`Too many arguments provided to ${s}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);const u=[];for(let r=0;r<i.length;r++){const c=i[r];if(o[r].field.isKeyField()){if("string"!=typeof c)throw new N(q.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${s}(), but got a ${typeof c}`);if(!kn(e)&&-1!==c.indexOf("/"))throw new N(q.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by documentId(), the value passed to ${s}() must be a plain document ID, but '${c}' contains a slash.`);const n=e.path.child(j.fromString(c));if(!H.isDocumentKey(n))throw new N(q.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by documentId(), the value passed to ${s}() must result in a valid document path, but '${n}' is not because it contains an odd number of segments.`);const i=new H(n);u.push(kt(t,i))}else{const e=yl(n,s,c);u.push(e)}}return new jt(u,r)}(e._query,e.firestore._databaseId,i,t,n,s)}}function Wl(e,t,n){if("string"==typeof(n=Object(l.z)(n))){if(""===n)throw new N(q.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!kn(t)&&-1!==n.indexOf("/"))throw new N(q.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${n}' contains a '/' character.`);const s=t.path.child(j.fromString(n));if(!H.isDocumentKey(s))throw new N(q.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${s}' is not because it has an odd number of segments (${s.length}).`);return kt(e,new H(s))}if(n instanceof xu)return kt(e,n._key);throw new N(q.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${vu(n)}.`)}function Hl(e,t){if(!Array.isArray(e)||0===e.length)throw new N(q.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${t.toString()}' filters.`)}function Yl(e,t){if(t.isInequality()){const n=An(e),s=t.field;if(null!==n&&!n.isEqual(s))throw new N(q.INVALID_ARGUMENT,`Invalid query. All where filters with an inequality (<, <=, !=, not-in, >, or >=) must be on the same field. But you have inequality filters on '${n.toString()}' and '${s.toString()}'`);const i=Cn(e);null!==i&&Xl(e,s,i)}const n=function(e,t){for(const n of e)for(const e of n.getFlattenedFilters())if(t.indexOf(e.op)>=0)return e.op;return null}(e.filters,function(e){switch(e){case"!=":return["!=","not-in"];case"array-contains-any":case"in":return["not-in"];case"not-in":return["array-contains-any","in","not-in","!="];default:return[]}}(t.op));if(null!==n)throw n===t.op?new N(q.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${t.op.toString()}' filter.`):new N(q.INVALID_ARGUMENT,`Invalid query. You cannot use '${t.op.toString()}' filters with '${n.toString()}' filters.`)}function Xl(e,t,n){if(!n.isEqual(t))throw new N(q.INVALID_ARGUMENT,`Invalid query. You have a where filter with an inequality (<, <=, !=, not-in, >, or >=) on field '${t.toString()}' and so you must also use '${t.toString()}' as your first argument to orderBy(), but your first orderBy() is on field '${n.toString()}' instead.`)}class Jl{convertValue(e,t="none"){switch(St(e)){case 0:return null;case 1:return e.booleanValue;case 2:return gt(e.integerValue||e.doubleValue);case 3:return this.convertTimestamp(e.timestampValue);case 4:return this.convertServerTimestamp(e,t);case 5:return e.stringValue;case 6:return this.convertBytes(pt(e.bytesValue));case 7:return this.convertReference(e.referenceValue);case 8:return this.convertGeoPoint(e.geoPointValue);case 9:return this.convertArray(e.arrayValue,t);case 10:return this.convertObject(e.mapValue,t);default:throw S()}}convertObject(e,t){return this.convertObjectMap(e.fields,t)}convertObjectMap(e,t="none"){const n={};return Ze(e,((e,s)=>{n[e]=this.convertValue(s,t)})),n}convertGeoPoint(e){return new Zu(gt(e.latitude),gt(e.longitude))}convertArray(e,t){return(e.values||[]).map((e=>this.convertValue(e,t)))}convertServerTimestamp(e,t){switch(t){case"previous":const n=wt(e);return null==n?null:this.convertValue(n,t);case"estimate":return this.convertTimestamp(vt(e));default:return null}}convertTimestamp(e){const t=mt(e);return new K(t.seconds,t.nanos)}convertDocumentKey(e,t){const n=j.fromString(e);x(qs(n));const s=new bt(n.get(1),n.get(3)),i=new H(n.popFirst(5));return s.isEqual(t)||I(`Document ${i} contains a document reference within a different database (${s.projectId}/${s.database}) which is not supported. It will be treated as a reference in the current database (${t.projectId}/${t.database}) instead.`),i}}function Zl(e,t,n){let s;return s=e?n&&(n.merge||n.mergeFields)?e.toFirestore(t,n):e.toFirestore(t):t,s}class eh extends Jl{constructor(e){super(),this.firestore=e}convertBytes(e){return new Yu(e)}convertReference(e){const t=this.convertDocumentKey(e,this.firestore._databaseId);return new xu(this.firestore,null,t)}}class nh{constructor(e,t){this.hasPendingWrites=e,this.fromCache=t}isEqual(e){return this.hasPendingWrites===e.hasPendingWrites&&this.fromCache===e.fromCache}}class rh extends _l{constructor(e,t,n,s,i,r){super(e,t,n,s,r),this._firestore=e,this._firestoreImpl=e,this.metadata=i}exists(){return super.exists()}data(e={}){if(this._document){if(this._converter){const t=new sh(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(t,e)}return this._userDataWriter.convertValue(this._document.data.value,e.serverTimestamps)}}get(e,t={}){if(this._document){const n=this._document.data.field(Nl("DocumentSnapshot.get",e));if(null!==n)return this._userDataWriter.convertValue(n,t.serverTimestamps)}}}class sh extends rh{data(e={}){return super.data(e)}}class ih{constructor(e,t,n,s){this._firestore=e,this._userDataWriter=t,this._snapshot=s,this.metadata=new nh(s.hasPendingWrites,s.fromCache),this.query=n}get docs(){const e=[];return this.forEach((t=>e.push(t))),e}get size(){return this._snapshot.docs.size}get empty(){return 0===this.size}forEach(e,t){this._snapshot.docs.forEach((n=>{e.call(t,new sh(this._firestore,this._userDataWriter,n.key,n,new nh(this._snapshot.mutatedKeys.has(n.key),this._snapshot.fromCache),this.query.converter))}))}docChanges(e={}){const t=!!e.includeMetadataChanges;if(t&&this._snapshot.excludesMetadataChanges)throw new N(q.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===t||(this._cachedChanges=function(e,t){if(e._snapshot.oldDocs.isEmpty()){let t=0;return e._snapshot.docChanges.map((n=>{const s=new sh(e._firestore,e._userDataWriter,n.doc.key,n.doc,new nh(e._snapshot.mutatedKeys.has(n.doc.key),e._snapshot.fromCache),e.query.converter);return n.doc,{type:"added",doc:s,oldIndex:-1,newIndex:t++}}))}{let n=e._snapshot.oldDocs;return e._snapshot.docChanges.filter((e=>t||3!==e.type)).map((t=>{const s=new sh(e._firestore,e._userDataWriter,t.doc.key,t.doc,new nh(e._snapshot.mutatedKeys.has(t.doc.key),e._snapshot.fromCache),e.query.converter);let i=-1,r=-1;return 0!==t.type&&(i=n.indexOf(t.doc.key),n=n.delete(t.doc.key)),1!==t.type&&(n=n.add(t.doc),r=n.indexOf(t.doc.key)),{type:oh(t.type),doc:s,oldIndex:i,newIndex:r}}))}}(this,t),this._cachedChangesIncludeMetadataChanges=t),this._cachedChanges}}function oh(e){switch(e){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return S()}}function ah(e,t){return e instanceof rh&&t instanceof rh?e._firestore===t._firestore&&e._key.isEqual(t._key)&&(null===e._document?null===t._document:e._document.isEqual(t._document))&&e._converter===t._converter:e instanceof ih&&t instanceof ih&&e._firestore===t._firestore&&Ru(e.query,t.query)&&e.metadata.isEqual(t.metadata)&&e._snapshot.isEqual(t._snapshot)}function ch(e){e=Iu(e,xu);const t=Iu(e.firestore,Lu);return hu(Pu(t),e._key).then((n=>Eh(t,e,n)))}class uh extends Jl{constructor(e){super(),this.firestore=e}convertBytes(e){return new Yu(e)}convertReference(e){const t=this.convertDocumentKey(e,this.firestore._databaseId);return new xu(this.firestore,null,t)}}function lh(e){e=Iu(e,xu);const t=Iu(e.firestore,Lu),n=Pu(t),s=new uh(t);return function(e,t){const n=new C;return e.asyncQueue.enqueueAndForget((async()=>async function(e,t,n){try{const s=await function(e,t){const n=D(e);return n.persistence.runTransaction("read document","readonly",(e=>n.localDocuments.getDocument(e,t)))}(e,t);s.isFoundDocument()?n.resolve(s):s.isNoDocument()?n.resolve(null):n.reject(new N(q.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)"))}catch(e){const s=Wa(e,`Failed to get document '${t} from cache`);n.reject(s)}}(await ou(e),t,n))),n.promise}(n,e._key).then((n=>new rh(t,s,e._key,n,new nh(null!==n&&n.hasLocalMutations,!0),e.converter)))}function hh(e){e=Iu(e,xu);const t=Iu(e.firestore,Lu);return hu(Pu(t),e._key,{source:"server"}).then((n=>Eh(t,e,n)))}function dh(e){e=Iu(e,_u);const t=Iu(e.firestore,Lu),n=Pu(t),s=new uh(t);return Cl(e._query),du(n,e._query).then((n=>new ih(t,s,e,n)))}function fh(e){e=Iu(e,_u);const t=Iu(e.firestore,Lu),n=Pu(t),s=new uh(t);return function(e,t){const n=new C;return e.asyncQueue.enqueueAndForget((async()=>async function(e,t,n){try{const s=await Uo(e,t,!0),i=new dc(t,s.ir),r=i.sc(s.documents),o=i.applyChanges(r,!1);n.resolve(o.snapshot)}catch(e){const s=Wa(e,`Failed to execute query '${t} against cache`);n.reject(s)}}(await ou(e),t,n))),n.promise}(n,e._query).then((n=>new ih(t,s,e,n)))}function mh(e){e=Iu(e,_u);const t=Iu(e.firestore,Lu),n=Pu(t),s=new uh(t);return du(n,e._query,{source:"server"}).then((n=>new ih(t,s,e,n)))}function gh(e,t,n){e=Iu(e,xu);const s=Iu(e.firestore,Lu),i=Zl(e.converter,t,n);return bh(s,[cl(al(s),"setDoc",e._key,i,null!==e.converter,n).toMutation(e._key,Tr.none())])}function ph(e,t,n,...s){e=Iu(e,xu);const i=Iu(e.firestore,Lu),r=al(i);let o;return o="string"==typeof(t=Object(l.z)(t))||t instanceof Xu?pl(r,"updateDoc",e._key,t,n,s):ul(r,"updateDoc",e._key,t),bh(i,[o.toMutation(e._key,Tr.exists(!0))])}function yh(e){return bh(Iu(e.firestore,Lu),[new Mr(e._key,Tr.none())])}function wh(e,t){const n=Iu(e.firestore,Lu),s=Au(e),i=Zl(e.converter,t);return bh(n,[cl(al(e.firestore),"addDoc",s._key,i,null!==e.converter,{}).toMutation(s._key,Tr.exists(!1))]).then((()=>s))}function vh(e,...t){var n,s,i;e=Object(l.z)(e);let r={includeMetadataChanges:!1},o=0;"object"!=typeof t[o]||Vu(t[o])||(r=t[o],o++);const u={includeMetadataChanges:r.includeMetadataChanges};if(Vu(t[o])){const e=t[o];t[o]=null===(n=e.next)||void 0===n?void 0:n.bind(e),t[o+1]=null===(s=e.error)||void 0===s?void 0:s.bind(e),t[o+2]=null===(i=e.complete)||void 0===i?void 0:i.bind(e)}let c,a,h;if(e instanceof xu)a=Iu(e.firestore,Lu),h=Dn(e._key.path),c={next:n=>{t[o]&&t[o](Eh(a,e,n))},error:t[o+1],complete:t[o+2]};else{const n=Iu(e,_u);a=Iu(n.firestore,Lu),h=n._query;const s=new uh(a);c={next:e=>{t[o]&&t[o](new ih(a,s,n,e))},error:t[o+1],complete:t[o+2]},Cl(e._query)}return function(e,t,n,s){const i=new Hc(s),r=new ic(t,i,n);return e.asyncQueue.enqueueAndForget((async()=>ec(await lu(e),r))),()=>{i.Dc(),e.asyncQueue.enqueueAndForget((async()=>tc(await lu(e),r)))}}(Pu(a),h,u,c)}function Ih(e,t){return function(e,t){const n=new Hc(t);return e.asyncQueue.enqueueAndForget((async()=>function(e,t){D(e).ku.add(t),t.next()}(await lu(e),n))),()=>{n.Dc(),e.asyncQueue.enqueueAndForget((async()=>function(e,t){D(e).ku.delete(t)}(await lu(e),n)))}}(Pu(e=Iu(e,Lu)),Vu(t)?t:{next:t})}function bh(e,t){return function(e,t){const n=new C;return e.asyncQueue.enqueueAndForget((async()=>async function(e,t,n){const s=Gc(e);try{const e=await function(e,t){const n=D(e),s=K.now(),i=t.reduce(((e,t)=>e.add(t.key)),er());let r,o;return n.persistence.runTransaction("Locally write mutations","readwrite",(e=>{let u=$n(),c=er();return n.Zi.getEntries(e,i).next((e=>{u=e,u.forEach(((e,t)=>{t.isValidDocument()||(c=c.add(e))}))})).next((()=>n.localDocuments.getOverlayedDocuments(e,u))).next((i=>{r=i;const o=[];for(const e of t){const t=Cr(e,r.get(e.key).overlayedDocument);null!=t&&o.push(new Rr(e.key,t,Kt(t.value.mapValue),Tr.exists(!0)))}return n.mutationQueue.addMutationBatch(e,s,o,t)})).next((t=>{o=t;const s=t.applyToLocalDocumentSet(r,c);return n.documentOverlayCache.saveOverlays(e,t.batchId,s)}))})).then((()=>({batchId:o.batchId,changes:Wn(r)})))}(s.localStore,t);s.sharedClientState.addPendingMutation(e.batchId),function(e,t,n){let s=e.Tc[e.currentUser.toKey()];s||(s=new tt(B)),s=s.insert(t,n),e.Tc[e.currentUser.toKey()]=s}(s,e.batchId,n),await kc(s,e.changes),await Va(s.remoteStore)}catch(e){const t=Wa(e,"Failed to persist write");n.reject(t)}}(await cu(e),t,n))),n.promise}(Pu(e),t)}function Eh(e,t,n){const s=n.docs.get(t._key),i=new uh(e);return new rh(e,i,t._key,s,new nh(n.hasPendingWrites,n.fromCache),t.converter)}const Th={maxAttempts:5};class Sh{constructor(e,t){this._firestore=e,this._commitHandler=t,this._mutations=[],this._committed=!1,this._dataReader=al(e)}set(e,t,n){this._verifyNotCommitted();const s=xh(e,this._firestore),i=Zl(s.converter,t,n),r=cl(this._dataReader,"WriteBatch.set",s._key,i,null!==s.converter,n);return this._mutations.push(r.toMutation(s._key,Tr.none())),this}update(e,t,n,...s){this._verifyNotCommitted();const i=xh(e,this._firestore);let r;return r="string"==typeof(t=Object(l.z)(t))||t instanceof Xu?pl(this._dataReader,"WriteBatch.update",i._key,t,n,s):ul(this._dataReader,"WriteBatch.update",i._key,t),this._mutations.push(r.toMutation(i._key,Tr.exists(!0))),this}delete(e){this._verifyNotCommitted();const t=xh(e,this._firestore);return this._mutations=this._mutations.concat(new Mr(t._key,Tr.none())),this}commit(){return this._verifyNotCommitted(),this._committed=!0,this._mutations.length>0?this._commitHandler(this._mutations):Promise.resolve()}_verifyNotCommitted(){if(this._committed)throw new N(q.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}}function xh(e,t){if((e=Object(l.z)(e)).firestore!==t)throw new N(q.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return e}class _h extends class{constructor(e,t){this._firestore=e,this._transaction=t,this._dataReader=al(e)}get(e){const t=xh(e,this._firestore),n=new eh(this._firestore);return this._transaction.lookup([t._key]).then((e=>{if(!e||1!==e.length)return S();const s=e[0];if(s.isFoundDocument())return new _l(this._firestore,n,s.key,s,t.converter);if(s.isNoDocument())return new _l(this._firestore,n,t._key,null,t.converter);throw S()}))}set(e,t,n){const s=xh(e,this._firestore),i=Zl(s.converter,t,n),r=cl(this._dataReader,"Transaction.set",s._key,i,null!==s.converter,n);return this._transaction.set(s._key,r),this}update(e,t,n,...s){const i=xh(e,this._firestore);let r;return r="string"==typeof(t=Object(l.z)(t))||t instanceof Xu?pl(this._dataReader,"Transaction.update",i._key,t,n,s):ul(this._dataReader,"Transaction.update",i._key,t),this._transaction.update(i._key,r),this}delete(e){const t=xh(e,this._firestore);return this._transaction.delete(t._key),this}}{constructor(e,t){super(e,t),this._firestore=e}get(e){const t=xh(e,this._firestore),n=new uh(this._firestore);return super.get(e).then((e=>new rh(this._firestore,n,t._key,e._document,new nh(!1,!1),t.converter)))}}function Dh(e,t,n){e=Iu(e,Lu);const s=Object.assign(Object.assign({},Th),n);return function(e){if(e.maxAttempts<1)throw new N(q.INVALID_ARGUMENT,"Max attempts must be at least 1")}(s),function(e,t,n){const s=new C;return e.asyncQueue.enqueueAndForget((async()=>{const i=await uu(e);new Jc(e.asyncQueue,i,n,t,s).run()})),s.promise}(Pu(e),(n=>t(new _h(e,n))),s)}function Nh(){return new ll("deleteField")}function Ch(){return new fl("serverTimestamp")}function Ah(...e){return new ml("arrayUnion",e)}function kh(...e){return new gl("arrayRemove",e)}function Rh(e){return new ol("increment",e)}!function(e,t=!0){!function(e){f=e}(r.SDK_VERSION),Object(r._registerComponent)(new o.a("firestore",((e,{instanceIdentifier:n,options:s})=>{const i=e.getProvider("app").getImmediate(),r=new Lu(new F(e.getProvider("auth-internal")),new L(e.getProvider("app-check-internal")),function(e,t){if(!Object.prototype.hasOwnProperty.apply(e.options,["projectId"]))throw new N(q.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new bt(e.options.projectId,t)}(i,n),i);return s=Object.assign({useFetchStreams:t},s),r._setSettings(s),r}),"PUBLIC").setMultipleInstances(!0)),Object(r.registerVersion)(b,"3.13.0",e),Object(r.registerVersion)(b,"3.13.0","esm2017")}()}).call(this,n(76))}}]);